<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AFI CRM - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6161ff;
      --primary-dark: #4545d4;
      --primary-light: #7e7eff;
      --success: #00c875;
      --success-light: #00d084;
      --warning: #ffcb00;
      --warning-light: #ffd533;
      --danger: #e2445c;
      --danger-light: #ff6b7d;
      --info: #0086c0;
      --info-light: #00a8f0;
      --purple: #a25ddc;
      --purple-light: #b56eef;
      
      /* Status Colors */
      --status-pending: #fdab3d;
      --status-pending-bg: #fef4e6;
      --status-in-progress: #007fff;
      --status-in-progress-bg: #e6f4ff;
      --status-ready: #9747ff;
      --status-ready-bg: #f3e6ff;
      --status-delivery: #ff6b35;
      --status-delivery-bg: #fff0e6;
      --status-delivered: #00c875;
      --status-delivered-bg: #e6f9f0;
      
      /* Modern Grays */
      --gray-25: #fcfcfc;
      --gray-50: #f8f9fa;
      --gray-75: #f1f3f4;
      --gray-100: #e8eaed;
      --gray-200: #dadce0;
      --gray-300: #c4c7c5;
      --gray-400: #9aa0a6;
      --gray-500: #5f6368;
      --gray-600: #3c4043;
      --gray-700: #202124;
      --gray-800: #171717;
      --gray-900: #0a0a0a;
      
      /* Modern Styling */
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 16px;
      --border-radius-pill: 50px;
      
      /* Modern Shadows */
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.03);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
      --shadow-md: 0 6px 16px -6px rgb(0 0 0 / 0.12), 0 0 0 1px rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 24px -8px rgb(0 0 0 / 0.15), 0 0 0 1px rgb(0 0 0 / 0.05);
      --shadow-xl: 0 20px 40px -12px rgb(0 0 0 / 0.20), 0 0 0 1px rgb(0 0 0 / 0.05);
      
      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.2);
      
      /* Transitions */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, var(--gray-25) 0%, var(--gray-75) 100%);
      color: var(--gray-700);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(97, 97, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
      backdrop-filter: blur(10px);
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      text-align: center;
      color: white;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 3rem;
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .loading-spinner {
      width: 64px;
      height: 64px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    .loading-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loading-message {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 2rem;
      left: 2rem;
      z-index: 9998;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toast {
      background: white;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 1rem 1.5rem;
      min-width: 320px;
      max-width: 500px;
      transform: translateX(-120%);
      transition: var(--transition);
      border: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: var(--success);
      border-left: 4px solid var(--success);
    }

    .toast.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: var(--danger);
      border-left: 4px solid var(--danger);
    }

    .toast-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      color: var(--gray-700);
    }

    .toast-close {
      background: var(--gray-100);
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      background: var(--gray-200);
      color: var(--gray-700);
      transform: scale(1.05);
    }

    /* ===== MAIN LAYOUT ===== */
    .app-container {
      min-height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--border-radius-xl);
      padding: 2.5rem 3rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-xl);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
      pointer-events: none;
    }

    .header-content h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    .header-content p {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    /* ===== NAVIGATION ===== */
    .main-nav {
      background: var(--glass-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
      overflow: hidden;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .nav-tabs {
      display: flex;
      padding: 0.5rem;
      gap: 0.25rem;
    }

    .nav-tab {
      flex: 1;
      padding: 1rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--gray-500);
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      border-radius: var(--border-radius);
      position: relative;
    }

    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.6);
      color: var(--gray-700);
      transform: translateY(-1px);
    }

    .nav-tab.active {
      color: var(--primary);
      background: white;
      box-shadow: var(--shadow-sm);
      font-weight: 600;
    }

    .nav-tab.active::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--primary);
      border-radius: var(--border-radius-pill);
    }

    /* ===== CONTENT SECTIONS ===== */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* ===== CARDS ===== */
    .card {
      background: var(--glass-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .card-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--gray-200);
      background: rgba(255, 255, 255, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-content {
      padding: 2rem;
      background: rgba(255, 255, 255, 0.3);
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* ===== ORDER FILTERS ===== */
    .order-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--gray-200);
      background: var(--glass-bg);
      border-radius: var(--border-radius-pill);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .filter-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .filter-btn:hover::before {
      opacity: 1;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
    }

    .filter-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .filter-btn .badge {
      background: rgba(255, 255, 255, 0.9);
      color: var(--gray-700);
      padding: 0.25rem 0.6rem;
      border-radius: var(--border-radius-pill);
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .filter-btn.active .badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* ===== ORDERS TABLE ===== */
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: transparent;
      margin: 0;
      border-spacing: 0;
    }

    /* Define specific column widths for the main orders table */
    .orders-table th:nth-child(1),
    .orders-table td:nth-child(1) {
      width: 15%; /* Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ */
    }

    .orders-table th:nth-child(2),
    .orders-table td:nth-child(2) {
      width: 25%; /* Ø§Ù„Ø¹Ù…ÙŠÙ„ */
    }

    .orders-table th:nth-child(3),
    .orders-table td:nth-child(3) {
      width: 15%; /* Ø§Ù„ØªØ§Ø±ÙŠØ® */
    }

    .orders-table th:nth-child(4),
    .orders-table td:nth-child(4) {
      width: 15%; /* Ø§Ù„Ù…Ø¨Ù„Øº */
    }

    .orders-table th:nth-child(5),
    .orders-table td:nth-child(5) {
      width: 30%; /* Ø§Ù„Ø­Ø§Ù„Ø© */
    }

    .orders-table th,
    .orders-table td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
      text-align: right;
      box-sizing: border-box;
    }

    .orders-table th {
      background: linear-gradient(135deg, white 0%, var(--gray-100) 100%);
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
      text-align: right;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .orders-table td {
      text-align: right;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
    }

    .orders-table tbody tr {
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--border-radius);
    }

    .orders-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .order-row.expanded {
      background: rgba(97, 97, 255, 0.1);
      box-shadow: var(--shadow-sm);
    }

    .order-details-row {
      display: none;
    }

    .order-details-row.show {
      display: table-row;
    }

    .order-details-content {
      padding: 2rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
      border-radius: var(--border-radius-lg);
      margin: 1rem 0;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Fix for table container */
    .card-content {
      padding: 0;
      background: rgba(255, 255, 255, 0.3);
      overflow-x: auto;
    }

    .orders-table-container {
      width: 100%;
      min-width: 100%;
      overflow-x: auto;
    }

    /* Ensure order details row spans full width */
    .order-details-row td {
      width: 100% !important;
      padding: 1rem !important;
      box-sizing: border-box;
    }

    .order-details-content {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* ===== MODERN STATUS CHIPS ===== */
    .status-select {
      appearance: none;
      background: transparent;
      border: none;
      padding: 0.6rem 2.5rem 0.6rem 1.2rem;
      border-radius: var(--border-radius-pill);
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      color: white;
      min-width: 150px;
      position: relative;
      text-align: center;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* Status Chip Colors */
    .status-pending {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%);
      box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4);
    }

    .status-pending::before {
      content: 'â³';
      margin-left: 0.5rem;
    }

    .status-in-progress {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%);
      box-shadow: 0 4px 15px rgba(55, 66, 250, 0.4);
    }

    .status-in-progress::before {
      content: 'âš¡';
      margin-left: 0.5rem;
    }

    .status-ready-for-shipment {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%);
      box-shadow: 0 4px 15px rgba(165, 94, 234, 0.4);
    }

    .status-ready-for-shipment::before {
      content: 'ğŸ“¦';
      margin-left: 0.5rem;
    }

    .status-out-for-delivery {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
      box-shadow: 0 4px 15px rgba(253, 121, 168, 0.4);
    }

    .status-out-for-delivery::before {
      content: 'ğŸšš';
      margin-left: 0.5rem;
    }

    .status-delivered {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
    }

    .status-delivered::before {
      content: 'âœ…';
      margin-left: 0.5rem;
    }

    .status-select:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .status-select:focus {
      outline: none;
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .status-select:active {
      transform: translateY(0) scale(0.98);
    }

    /* Custom dropdown arrow with modern styling */
    .status-select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: left calc(100% - 0.75rem) center;
      background-repeat: no-repeat;
      background-size: 16px 16px;
    }

    /* CHIP-STYLE DROPDOWN OPTIONS */
    .status-select option {
      background: white !important;
      color: var(--gray-700) !important;
      padding: 0.75rem 1rem !important;
      margin: 0.25rem !important;
      border-radius: var(--border-radius-pill) !important;
      font-weight: 600 !important;
      font-size: 0.85rem !important;
      border: 2px solid transparent !important;
      transition: var(--transition) !important;
    }

    .status-select option:hover {
      transform: scale(1.02) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    /* Individual option colors */
    .status-select option[value="pending"] {
      background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%) !important;
      color: #e67e22 !important;
      border-color: rgba(255, 159, 67, 0.3) !important;
    }

    .status-select option[value="pending"]::before {
      content: 'â³ ';
    }

    .status-select option[value="pending"]:hover {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%) !important;
      color: white !important;
    }

    .status-select option[value="in-progress"] {
      background: linear-gradient(135deg, #e8eaff 0%, #d4d7ff 100%) !important;
      color: #3742fa !important;
      border-color: rgba(55, 66, 250, 0.3) !important;
    }

    .status-select option[value="in-progress"]::before {
      content: 'âš¡ ';
    }

    .status-select option[value="in-progress"]:hover {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%) !important;
      color: white !important;
    }

    .status-select option[value="ready-for-shipment"] {
      background: linear-gradient(135deg, #f3eaff 0%, #e8d5ff 100%) !important;
      color: #a55eea !important;
      border-color: rgba(165, 94, 234, 0.3) !important;
    }

    .status-select option[value="ready-for-shipment"]::before {
      content: 'ğŸ“¦ ';
    }

    .status-select option[value="ready-for-shipment"]:hover {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%) !important;
      color: white !important;
    }

    .status-select option[value="out-for-delivery"] {
      background: linear-gradient(135deg, #ffe8f0 0%, #ffd1e1 100%) !important;
      color: #e84393 !important;
      border-color: rgba(253, 121, 168, 0.3) !important;
    }

    .status-select option[value="out-for-delivery"]::before {
      content: 'ğŸšš ';
    }

    .status-select option[value="out-for-delivery"]:hover {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%) !important;
      color: white !important;
    }

    .status-select option[value="delivered"] {
      background: linear-gradient(135deg, #e6f9f6 0%, #ccf2ec 100%) !important;
      color: #00b894 !important;
      border-color: rgba(0, 184, 148, 0.3) !important;
    }

    .status-select option[value="delivered"]::before {
      content: 'âœ… ';
    }

    .status-select option[value="delivered"]:hover {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%) !important;
      color: white !important;
    }

    /* Enhanced dropdown styling */
    .status-select:focus option {
      background: white;
      border-radius: var(--border-radius-pill);
      margin: 0.2rem 0.5rem;
      padding: 0.5rem 1rem;
    }

    /* Status Badge Styles for Filter Buttons - Enhanced */
    .filter-btn[data-filter="pending"] .badge {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(255, 159, 67, 0.3);
    }

    .filter-btn[data-filter="in-progress"] .badge {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(55, 66, 250, 0.3);
    }

    .filter-btn[data-filter="ready-for-shipment"] .badge {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(165, 94, 234, 0.3);
    }

    .filter-btn[data-filter="out-for-delivery"] .badge {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(253, 121, 168, 0.3);
    }

    .filter-btn[data-filter="delivered"] .badge {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
    }

    .filter-btn[data-filter="all"] .badge {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(97, 97, 255, 0.3);
    }

    /* Enhanced filter button badges */
    .filter-btn .badge {
      border-radius: var(--border-radius-pill);
      padding: 0.3rem 0.7rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
      transition: var(--transition);
    }

    /* Override active filter button badge colors */
    .filter-btn.active .badge {
      background: rgba(255, 255, 255, 0.25) !important;
      color: white !important;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }

    /* Pulse animation for active status */
    .status-select {
      animation: none;
    }

    .status-select:focus {
      animation: statusPulse 2s infinite;
    }

    @keyframes statusPulse {
      0% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      50% {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      100% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
    }

    /* ===== ORDER ITEMS TABLE (inside details) - SEPARATE STYLING ===== */
    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      table-layout: auto; /* Different from main table */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Specific column widths for items table - More Even Distribution */
    .order-items-table th.order-items-table-product,
    .order-items-table td.order-items-table-product {
      width: 20%; /* Ø§Ù„Ù…Ù†ØªØ¬ */
      text-align: right;
    }

    .order-items-table th.order-items-table-quantity,
    .order-items-table td.order-items-table-quantity {
      width: 13%; /* Ø§Ù„ÙƒÙ…ÙŠØ© */
      text-align: center;
    }

    .order-items-table th.order-items-table-unit,
    .order-items-table td.order-items-table-unit {
      width: 13%; /* Ø§Ù„ÙˆØ­Ø¯Ø© */
      text-align: center;
    }

    .order-items-table th.order-items-table-price,
    .order-items-table td.order-items-table-price {
      width: 17%; /* Ø§Ù„Ø³Ø¹Ø± */
      text-align: center;
    }

    .order-items-table th.order-items-table-total,
    .order-items-table td.order-items-table-total {
      width: 17%; /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
      text-align: center;
    }

    .order-items-table th.order-items-table-notes,
    .order-items-table td.order-items-table-notes {
      width: 20%; /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
      text-align: right;
    }

    .order-items-table th {
      background: linear-gradient(135deg, var(--gray-75) 0%, var(--gray-100) 100%);
      padding: 0.875rem 0.75rem;
      text-align: center;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.875rem;
      border-bottom: 2px solid var(--gray-200);
      white-space: nowrap;
    }

    .order-items-table th:first-child,
    .order-items-table th:last-child {
      text-align: right;
    }

    .order-items-table td {
      padding: 0.875rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.6);
      vertical-align: middle;
      text-align: center;
    }

    .order-items-table td:first-child,
    .order-items-table td:last-child {
      text-align: right;
    }

    .order-items-table tbody tr:last-child td {
      border-bottom: none;
    }

    .order-items-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    /* Footer styling for items table */
    .order-items-table tfoot tr {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%) !important;
      color: white !important;
    }

    .order-items-table tfoot td {
      background: none !important;
      color: white !important;
      font-weight: 600;
      border-bottom: none;
      padding: 1rem 0.75rem;
    }

    .order-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .summary-item {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
      padding: 1.5rem;
      border-radius: var(--border-radius-lg);
      text-align: center;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: var(--transition);
    }

    .summary-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .summary-label {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-700);
    }

    .expand-icon {
      transition: transform 0.3s ease;
    }

    .expand-icon.rotated {
      transform: rotate(180deg);
    }

    /* ===== ITEMS TABLE (for forms) - SEPARATE STYLING ===== */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      table-layout: auto;
      background: white;
    }

    .items-table th {
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
      padding: 0.875rem 0.75rem;
      text-align: center;
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .items-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
      text-align: center;
    }

    .items-table tbody tr:hover {
      background: var(--gray-50);
    }

    .items-table input,
    .items-table select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .add-item-btn {
      width: 100%;
      background: var(--gray-50);
      color: var(--primary);
      border: 2px dashed var(--gray-300);
      padding: 1rem;
    }

    .add-item-btn:hover {
      background: rgba(97, 97, 255, 0.05);
      border-color: var(--primary);
    }

    /* ===== ADDRESS SELECTION ===== */
    .address-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .address-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .address-card:hover {
      border-color: var(--primary-light);
      background: rgba(37, 99, 235, 0.02);
    }

    .address-card.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .address-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.75rem;
    }

    .address-details {
      color: var(--gray-600);
      line-height: 1.5;
    }

    .section-divider {
      margin: 2rem 0;
      padding-top: 2rem;
      border-top: 2px solid var(--gray-100);
    }

    .form-section {
      display: none;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--gray-200);
    }

    .form-section.show {
      display: block;
    }

    /* ===== CUSTOMER GRID ===== */
    .customers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .customer-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
    }

    .customer-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .customer-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .customer-info h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.25rem;
    }

    .customer-info p {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    .customer-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-200);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray-500);
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 2rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-400);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .modal-content {
      padding: 2rem;
    }

    /* ===== FORMS ===== */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 0.875rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      color: var(--gray-900);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-input.error,
    .form-select.error {
      border-color: var(--danger);
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* ===== CUSTOMER SEARCH ===== */
    .customer-search {
      position: relative;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 1rem 3rem 1rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 1.1rem;
      transition: var(--transition);
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.1rem;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--gray-200);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .search-results.show {
      display: block;
    }

    .search-result {
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--gray-100);
    }

    .search-result:hover {
      background: var(--gray-50);
    }

    .search-result:last-child {
      border-bottom: none;
    }

    .new-customer-option {
      background: var(--gray-100);
      color: var(--primary);
      border-top: 2px solid var(--gray-200);
      font-weight: 500;
    }

    .new-customer-option:hover {
      background: var(--gray-200);
      color: var(--primary-dark);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .app-container {
        padding: 1rem;
      }

      .app-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .header-content h1 {
        font-size: 2rem;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .order-filters {
        flex-direction: column;
      }

      .customers-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .toast-container {
        left: 1rem;
        right: 1rem;
      }

      .toast {
        min-width: auto;
      }

      .orders-table {
        width: 100%;
        font-size: 0.9rem;
      }

      .orders-table th,
      .orders-table td {
        padding: 0.75rem 0.5rem;
      }

      /* Adjust column widths for mobile */
      .orders-table th:nth-child(1),
      .orders-table td:nth-child(1) {
        width: 20%; /* Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ */
      }

      .orders-table th:nth-child(2),
      .orders-table td:nth-child(2) {
        width: 30%; /* Ø§Ù„Ø¹Ù…ÙŠÙ„ */
      }

      .orders-table th:nth-child(3),
      .orders-table td:nth-child(3) {
        width: 20%; /* Ø§Ù„ØªØ§Ø±ÙŠØ® */
      }

      .orders-table th:nth-child(4),
      .orders-table td:nth-child(4) {
        width: 15%; /* Ø§Ù„Ù…Ø¨Ù„Øº */
      }

      .orders-table th:nth-child(5),
      .orders-table td:nth-child(5) {
        width: 15%; /* Ø§Ù„Ø­Ø§Ù„Ø© */
      }
    }

    /* ===== UTILITY CLASSES ===== */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-2 {
      margin-bottom: 1rem;
    }

    .mt-2 {
      margin-top: 1rem;
    }

    .order-details-row td {
      width: 100%;
      padding: 0;
    }
    .order-details-content {
      width: 100%;
    }

    /* ===== CUSTOM SEARCHABLE DROPDOWN ===== */
    .custom-dropdown {
      position: relative;
      width: 100%;
      font-family: inherit;
      overflow: visible;
    }
    .custom-dropdown-box {
      display: flex;
      align-items: center;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      background: white;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      cursor: pointer;
      min-height: 40px;
      position: relative;
      transition: border-color 0.2s;
    }
    .custom-dropdown-box:focus-within, .custom-dropdown-box.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(97, 97, 255, 0.08);
    }
    .custom-dropdown-input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 1rem;
      background: transparent;
      color: var(--gray-900);
      padding: 0;
    }
    .custom-dropdown-chevron {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%) rotate(0deg);
      color: #aaa;
      font-size: 1.2em;
      pointer-events: none;
      transition: transform 0.2s;
    }
    .custom-dropdown-box.active .custom-dropdown-chevron {
      transform: translateY(-50%) rotate(180deg);
    }
    .custom-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: var(--shadow-lg);
      max-height: 220px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      direction: rtl;
    }
    .custom-dropdown-list.show {
      display: block;
    }
    .custom-dropdown-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 1rem;
      color: var(--gray-900);
      display: block;
      text-align: right;
      direction: rtl;
    }
    .custom-dropdown-item.selected, .custom-dropdown-item:hover {
      background: var(--gray-50);
      color: var(--primary);
    }
    .custom-dropdown-item mark {
      background: #fef3c7;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .items-table,
    .items-table tbody,
    .items-table tr {
      overflow: visible !important;
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-title">AFI CRM</div>
      <div class="loading-message" id="loadingMessage">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Main Application -->
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="header-content">
        <h1>
          <i class="fas fa-chart-line"></i>
          AFI CRM
        </h1>
        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-success" onclick="openNewOrderModal()">
          <i class="fas fa-plus"></i>
          Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
      <div class="nav-tabs">
        <button class="nav-tab active" data-section="orders">
          <i class="fas fa-shopping-cart"></i>
          Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </button>
        <button class="nav-tab" data-section="customers">
          <i class="fas fa-users"></i>
          Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        </button>
        <button class="nav-tab" data-section="leads">
          <i class="fas fa-user-plus"></i>
          Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†
        </button>
      </div>
    </nav>

    <!-- Orders Section -->
    <div class="content-section active" id="orders">
      <!-- Order Filters -->
      <div class="order-filters">
        <button class="filter-btn active" data-filter="all">
          <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
          <span class="badge" id="allCount">0</span>
        </button>
        <button class="filter-btn" data-filter="pending">
          <span>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
          <span class="badge" id="pendingCount">0</span>
        </button>
        <button class="filter-btn" data-filter="in-progress">
          <span>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
          <span class="badge" id="inProgressCount">0</span>
        </button>
        <button class="filter-btn" data-filter="ready-for-shipment">
          <span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø´Ø­Ù†</span>
          <span class="badge" id="readyForShipmentCount">0</span>
        </button>
        <button class="filter-btn" data-filter="out-for-delivery">
          <span>ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
          <span class="badge" id="outForDeliveryCount">0</span>
        </button>
        <button class="filter-btn" data-filter="delivered">
          <span>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span>
          <span class="badge" id="deliveredCount">0</span>
        </button>
      </div>

      <!-- Orders Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-list"></i>
            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </h2>
        </div>
        <div class="card-content">
          <div class="orders-table-container">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Customers Section -->
    <div class="content-section" id="customers">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-users"></i>
            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          </h2>
          <button class="btn btn-primary" onclick="openAddCustomerModal()">
            <i class="fas fa-user-plus"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
          </button>
        </div>
        <div class="card-content">
          <div class="customers-grid" id="customersGrid">
          </div>
        </div>
      </div>
    </div>

    <!-- Leads Section -->
    <div class="content-section" id="leads">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-user-plus"></i>
            Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ† (Leads)
          </h2>
          <button class="btn btn-success" onclick="openAddLeadModal()">
            <i class="fas fa-plus"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„
          </button>
        </div>
        <div class="card-content">
          <div class="leads-grid" id="leadsGrid">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Order Modal -->
  <div class="modal-overlay" id="newOrderModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-plus"></i>
          Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </h2>
        <button class="modal-close" onclick="closeNewOrderModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        
        <!-- Customer Search Section -->
        <div class="customer-search">
          <label class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</label>
          <input type="text" class="search-input" id="customerSearch"
            placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." autocomplete="off">
          <i class="fas fa-search search-icon"></i>
          <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Address Selection Section (shows when existing customer is selected) -->
        <div class="form-section" id="addressSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-map-marker-alt"></i>
            Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„
          </h3>
          <div class="address-grid" id="addressGrid"></div>
          <button type="button" class="btn btn-primary mb-2" onclick="showNewAddressForm()">
            <i class="fas fa-plus"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯
          </button>
        </div>

        <!-- Customer Details Section (shows only when adding new customer) -->
        <div class="form-section" id="customerDetailsSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-user-plus"></i>
            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
              <input type="text" class="form-input" id="customerName" required>
            </div>
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
              <input type="tel" class="form-input" id="customerPhone" required>
            </div>
            <div class="form-group">
              <label class="form-label">ÙˆØ§ØªØ³Ø§Ø¨</label>
              <input type="tel" class="form-input" id="customerWhatsapp">
            </div>
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
              <input type="email" class="form-input" id="customerEmail">
            </div>
            <div class="form-group">
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ØªØ¹Ù„ÙŠÙ‚</label>
              <textarea class="form-textarea" id="customerComment" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>
            </div>
            <input type="hidden" id="customerType" value="customer">
            <div class="form-group">
              <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ *</label>
              <select class="form-select" id="primarySourceOfSale" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
                <option value="Online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                <option value="InStore">Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</option>
                <option value="Phone">Ù‡Ø§ØªÙ</option>
                <option value="Other">Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</label>
              <select class="form-select" id="secondarySourceOfSale">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>
                <option value="Referral">Ø¥Ø­Ø§Ù„Ø©</option>
                <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
                <option value="Instagram">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</option>
                <option value="Google">Ø¬ÙˆØ¬Ù„</option>
                <option value="Other">Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
          </div>
        </div>

        <!-- New Address Section (shows when adding new address for existing customer) -->
        <div class="form-section" id="newAddressSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-map-marker-alt"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯
          </h3>
          <div class="form-grid">
            <!-- Address Label -->
            <div class="form-group">
              <label class="form-label">ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <select class="form-select" id="newAddressLabel">
                <option value="Home" data-icon="fa-home">ğŸ  Ø§Ù„Ù…Ù†Ø²Ù„</option>
                <option value="Work" data-icon="fa-building">ğŸ¢ Ø§Ù„Ø¹Ù…Ù„</option>
                <option value="Family" data-icon="fa-users">ğŸ‘ª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</option>
                <option value="Friend" data-icon="fa-handshake">ğŸ¤ ØµØ¯ÙŠÙ‚</option>
                <option value="Warehouse" data-icon="fa-warehouse">ğŸ¬ Ù…Ø³ØªÙˆØ¯Ø¹</option>
                <option value="Chalet" data-icon="fa-umbrella-beach">ğŸ–ï¸ Ø´Ø§Ù„ÙŠÙ‡</option>
                <option value="Farm" data-icon="fa-tractor">ğŸŒ¾ Ù…Ø²Ø±Ø¹Ø©</option>
                <option value="Shop" data-icon="fa-store">ğŸ›’ Ù…ØªØ¬Ø±</option>
                <option value="Other" data-icon="fa-map-marker-alt">ğŸ“ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <!-- Building Number -->
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„</label>
              <input type="text" class="form-input" id="newHouseNumber">
            </div>
            <!-- Flat Number -->
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©</label>
              <input type="text" class="form-input" id="newFlatNumber">
            </div>
            <!-- Floor Number -->
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±</label>
              <input type="text" class="form-input" id="newFloorNumber">
            </div>
            <!-- Street Name -->
            <div class="form-group">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹ *</label>
              <input type="text" class="form-input" id="newStreetName" required>
            </div>
            <!-- District (searchable) -->
            <div class="form-group" style="position:relative;">
              <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
              <input type="text" class="form-input" id="newAddressDistrictSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." autocomplete="off" required style="padding-left: 2.5rem; padding-right: 1rem;">
              <i class="fas fa-chevron-down" id="districtChevron" style="position:absolute; left:1.25rem; top:50%; transform:translateY(-50%); color:#aaa; font-size:1.2em; pointer-events:none; line-height:1;"></i>
              <div class="search-results" id="districtSearchResults"></div>
              <input type="hidden" id="newAddressDistrict">
              <input type="hidden" id="newAddressGovernorate">
              <input type="hidden" id="newDistrictId">
            </div>
            <!-- Landmark -->
            <div class="form-group">
              <label class="form-label">Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©</label>
              <input type="text" class="form-input" id="newAddressMarking">
            </div>
            <!-- Comment -->
            <div class="form-group">
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ØªØ¹Ù„ÙŠÙ‚</label>
              <textarea class="form-textarea" id="newAddressComment" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..."></textarea>
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="saveNewAddress()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
          </button>
          <button type="button" class="btn btn-primary" onclick="cancelNewAddress()">
            <i class="fas fa-times"></i>
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>

        <!-- Order Details Section (always visible once customer/address is set) -->
        <div class="form-section" id="orderDetailsSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-shopping-cart"></i>
            ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
          </h3>

          <!-- Order Comments -->
          <div class="form-group mb-2">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ù„Ø¨</label>
            <textarea class="form-textarea" id="orderComments" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ù„Ø¨..."></textarea>
          </div>

          <!-- Order Items Table -->
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 30%">Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th style="width: 12%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th style="width: 12%">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th style="width: 12%">Ø§Ù„Ø³Ø¹Ø±</th>
                <th style="width: 25%">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th style="width: 9%">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody">
            </tbody>
          </table>

          <button type="button" class="btn add-item-btn" onclick="addOrderItem()">
            <i class="fas fa-plus"></i>
            Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
          </button>

          <!-- Submit Buttons -->
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
            <button type="button" class="btn btn-success" onclick="submitOrder()">
              <i class="fas fa-check"></i>
              ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
            </button>
            <button type="button" class="btn btn-primary" onclick="closeNewOrderModal()">
              <i class="fas fa-times"></i>
              Ø¥Ù„ØºØ§Ø¡
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Add Lead Modal (dedicated) -->
  <div class="modal-overlay" id="addLeadModalDedicated">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-plus"></i>
          Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„ Ø¬Ø¯ÙŠØ¯
        </h2>
        <button class="modal-close" onclick="closeAddLeadModalDedicated()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„ *</label>
            <input type="text" class="form-input" id="addLeadName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
            <input type="tel" class="form-input" id="addLeadPhone" required>
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" class="form-input" id="addLeadEmail">
          </div>
          <div class="form-group">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ØªØ¹Ù„ÙŠÙ‚</label>
            <textarea class="form-textarea" id="addLeadComment" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„..."></textarea>
          </div>
          <input type="hidden" id="addLeadType" value="customer">
          <div class="form-group">
            <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ *</label>
            <select class="form-select" id="addLeadPrimarySourceOfSale" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
              <option value="Online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
              <option value="InStore">Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</option>
              <option value="Phone">Ù‡Ø§ØªÙ</option>
              <option value="Other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</label>
            <select class="form-select" id="addLeadSecondarySourceOfSale">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>
              <option value="Referral">Ø¥Ø­Ø§Ù„Ø©</option>
              <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
              <option value="Instagram">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</option>
              <option value="Google">Ø¬ÙˆØ¬Ù„</option>
              <option value="Other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
          <button type="button" class="btn btn-success" onclick="submitAddLead()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„
          </button>
          <button type="button" class="btn btn-primary" onclick="closeAddLeadModalDedicated()">
            <i class="fas fa-times"></i>
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-overlay" id="addCustomerModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-plus"></i>
          Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </h2>
        <button class="modal-close" onclick="closeAddCustomerModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
            <input type="text" class="form-input" id="addCustomerName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
            <input type="tel" class="form-input" id="addCustomerPhone" required>
          </div>
          <div class="form-group">
            <label class="form-label">ÙˆØ§ØªØ³Ø§Ø¨</label>
            <input type="tel" class="form-input" id="addCustomerWhatsapp">
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" class="form-input" id="addCustomerEmail">
          </div>
          <div class="form-group">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ØªØ¹Ù„ÙŠÙ‚</label>
            <textarea class="form-textarea" id="addCustomerComment" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>
          </div>
          <input type="hidden" id="addCustomerType" value="customer">
          <div class="form-group">
            <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ *</label>
            <select class="form-select" id="addCustomerPrimarySourceOfSale" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
              <option value="Online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
              <option value="InStore">Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</option>
              <option value="Phone">Ù‡Ø§ØªÙ</option>
              <option value="Other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</label>
            <select class="form-select" id="addCustomerSecondarySourceOfSale">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>
              <option value="Referral">Ø¥Ø­Ø§Ù„Ø©</option>
              <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
              <option value="Instagram">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</option>
              <option value="Google">Ø¬ÙˆØ¬Ù„</option>
              <option value="Other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
          <button type="button" class="btn btn-success" onclick="submitAddCustomer()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button type="button" class="btn btn-primary" onclick="closeAddCustomerModal()">
            <i class="fas fa-times"></i>
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== GLOBAL DATA =====
    let products = [
      { id: 'PROD_001', name: 'Ø£Ø±Ø² Ø£Ø¨ÙŠØ¶ - ÙƒÙŠØ³ 5 ÙƒÙŠÙ„Ùˆ', category: 'Ø£Ø±Ø²', price: 45.00 },
      { id: 'PROD_002', name: 'Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ - ÙƒÙŠØ³ 2 ÙƒÙŠÙ„Ùˆ', category: 'Ø£Ø±Ø²', price: 35.00 },
      { id: 'PROD_003', name: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© Ø¨Ù†Ø© - 500 Ø¬Ø±Ø§Ù…', category: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø©', price: 12.50 },
      { id: 'PROD_004', name: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© Ø­Ù„Ø²ÙˆÙ†ÙŠØ© - 500 Ø¬Ø±Ø§Ù…', category: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø©', price: 15.00 },
      { id: 'PROD_005', name: 'Ø²ÙŠØª Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³ - Ù„ØªØ±', category: 'Ø²ÙŠÙˆØª', price: 25.00 },
      { id: 'PROD_006', name: 'Ø²ÙŠØª Ø²ÙŠØªÙˆÙ† - 500 Ù…Ù„', category: 'Ø²ÙŠÙˆØª', price: 85.00 },
      { id: 'PROD_007', name: 'Ø³ÙƒØ± Ø£Ø¨ÙŠØ¶ - ÙƒÙŠØ³ ÙƒÙŠÙ„Ùˆ', category: 'Ø³ÙƒØ±', price: 20.00 },
      { id: 'PROD_008', name: 'Ø¯Ù‚ÙŠÙ‚ ÙØ§Ø®Ø± - ÙƒÙŠØ³ 2 ÙƒÙŠÙ„Ùˆ', category: 'Ø¯Ù‚ÙŠÙ‚', price: 18.00 },
      { id: 'PROD_009', name: 'Ø´Ø§ÙŠ Ø£Ø­Ù…Ø¯ - 100 ÙƒÙŠØ³', category: 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', price: 30.00 },
      { id: 'PROD_010', name: 'Ù‚Ù‡ÙˆØ© Ù†Ø³ÙƒØ§ÙÙŠÙ‡ - 200 Ø¬Ø±Ø§Ù…', category: 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', price: 55.00 }
    ];

    let districts = [
      { district_id: '420000000000001', district_name: 'Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' },
      { district_id: '420000000000002', district_name: 'Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' },
      { district_id: '420000000000003', district_name: 'ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' },
      { district_id: '420000000000004', district_name: 'Ø§Ù„Ù†Ø²Ù‡Ø©', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' },
      { district_id: '420000000000005', district_name: 'Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' },
      { district_id: '420000000000006', district_name: 'Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†', governorate_name: 'Ø§Ù„Ø¬ÙŠØ²Ø©' },
      { district_id: '420000000000007', district_name: 'Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ', governorate_name: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©' }
    ];

    let orders = [
      {
        id: 'AFI-001',
        customerId: 'CUST-001',
        customerName: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
        customerPhone: '01234567890',
        date: '2025-06-10',
        amount: 450.00,
        status: 'pending',
        items: [
          { productId: 'PROD_002', productName: 'Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ - ÙƒÙŠØ³ 2 ÙƒÙŠÙ„Ùˆ', quantity: 2, unit: 'ÙƒÙŠØ³', price: 35.00, comments: 'ÙŠÙØ¶Ù„ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ§Ø®Ø±' },
          { productId: 'PROD_005', productName: 'Ø²ÙŠØª Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³ - Ù„ØªØ±', quantity: 1, unit: 'Ù„ØªØ±', price: 25.00, comments: '' }
        ],
        address: 'Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
        comments: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØºØ±Ø¨'
      },
      {
        id: 'AFI-002',
        customerId: 'CUST-002',
        customerName: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯',
        customerPhone: '01111111111',
        date: '2025-06-09',
        amount: 320.50,
        status: 'in-progress',
        items: [
          { productId: 'PROD_003', productName: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© Ø¨Ù†Ø© - 500 Ø¬Ø±Ø§Ù…', quantity: 3, unit: 'Ø¹Ø¨ÙˆØ©', price: 12.50, comments: 'Ù†ÙˆØ¹ Ø¬ÙŠØ¯' },
          { productId: 'PROD_007', productName: 'Ø³ÙƒØ± Ø£Ø¨ÙŠØ¶ - ÙƒÙŠØ³ ÙƒÙŠÙ„Ùˆ', quantity: 2, unit: 'ÙƒÙŠØ³', price: 20.00, comments: '' }
        ],
        address: 'Ù‡Ù„ÙŠÙˆØ¨ÙˆÙ„ÙŠØ³',
        comments: ''
      },
      {
        id: 'AFI-003',
        customerId: 'CUST-003',
        customerName: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù† Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…',
        customerPhone: '01222222222',
        date: '2025-06-08',
        amount: 680.75,
        status: 'out-for-delivery',
        items: [
          { productId: 'PROD_008', productName: 'Ø¯Ù‚ÙŠÙ‚ ÙØ§Ø®Ø± - ÙƒÙŠØ³ 2 ÙƒÙŠÙ„Ùˆ', quantity: 1, unit: 'ÙƒÙŠØ³', price: 18.00, comments: '' },
          { productId: 'PROD_009', productName: 'Ø´Ø§ÙŠ Ø£Ø­Ù…Ø¯ - 100 ÙƒÙŠØ³', quantity: 2, unit: 'Ø¹Ø¨ÙˆØ©', price: 30.00, comments: 'ØªØ§Ø±ÙŠØ® Ø­Ø¯ÙŠØ«' }
        ],
        address: 'Ø§Ù„Ø¯Ù‚ÙŠ',
        comments: 'Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„'
      },
      {
        id: 'AFI-004',
        customerId: 'CUST-001',
        customerName: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
        customerPhone: '01234567890',
        date: '2025-06-07',
        amount: 280.00,
        status: 'delivered',
        items: [
          { productId: 'PROD_006', productName: 'Ø²ÙŠØª Ø²ÙŠØªÙˆÙ† - 500 Ù…Ù„', quantity: 1, unit: 'Ø²Ø¬Ø§Ø¬Ø©', price: 85.00, comments: 'Ø£ØµÙ„ÙŠ 100%' }
        ],
        address: 'Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
        comments: ''
      },
      {
        id: 'AFI-005',
        customerId: 'CUST-004',
        customerName: 'Ø³Ø§Ø±Ø© Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯',
        customerPhone: '01333333333',
        date: '2025-06-06',
        amount: 520.25,
        status: 'delivered',
        items: [
          { productId: 'PROD_001', productName: 'Ø£Ø±Ø² Ø£Ø¨ÙŠØ¶ - ÙƒÙŠØ³ 5 ÙƒÙŠÙ„Ùˆ', quantity: 2, unit: 'ÙƒÙŠØ³', price: 45.00, comments: '' },
          { productId: 'PROD_004', productName: 'Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© Ø­Ù„Ø²ÙˆÙ†ÙŠØ© - 500 Ø¬Ø±Ø§Ù…', quantity: 3, unit: 'Ø¹Ø¨ÙˆØ©', price: 15.00, comments: 'Ù„Ù„Ø£Ø·ÙØ§Ù„' }
        ],
        address: 'Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±',
        comments: 'ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹'
      }
    ];

    let customers = [
      {
        id: 'CUST-001',
        name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
        phone: '01234567890',
        addresses: [
          {
            id: 'ADDR_001',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: 'Ø¹Ù†ÙˆØ§Ù† Ø±Ø¦ÙŠØ³ÙŠ',
            house_number: '15',
            flat_number: '3',
            floor_number: '2',
            street_name: 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ù†ÙŠÙ„',
            address_marking: 'Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø© Ø§Ù„Ù…ØªØ±Ùˆ',
            address_district: 'Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ',
            address_governorate: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
            district_id: '420000000000001',
            area_id: '420000000000101',
            area: 'Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
            isPrimary: true
          },
          {
            id: 'ADDR_002',
            address_label: 'Work',
            address_type: 'Work',
            address_comment: 'Ù…ÙƒØªØ¨ Ø§Ù„Ø´Ø±ÙƒØ©',
            house_number: '45',
            flat_number: '201',
            floor_number: '5',
            street_name: 'Ø´Ø§Ø±Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±',
            address_marking: '',
            address_district: 'ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯',
            address_governorate: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
            district_id: '420000000000003',
            area_id: '420000000000301',
            area: 'Ø§Ù„ØªØ­Ø±ÙŠØ±',
            isPrimary: false
          }
        ],
        totalOrders: 5,
        totalSpent: 1250.00,
        lastOrderDate: '2025-06-10'
      },
      {
        id: 'CUST-002',
        name: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯',
        phone: '01111111111',
        addresses: [
          {
            id: 'ADDR_003',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '8',
            flat_number: '5',
            floor_number: '5',
            street_name: 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ©',
            address_marking: '',
            address_district: 'Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
            address_governorate: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
            district_id: '420000000000002',
            area_id: '420000000000201',
            area: 'Ù‡Ù„ÙŠÙˆØ¨ÙˆÙ„ÙŠØ³',
            isPrimary: true
          }
        ],
        totalOrders: 3,
        totalSpent: 890.50,
        lastOrderDate: '2025-06-09'
      },
      {
        id: 'CUST-003',
        name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù† Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…',
        phone: '01222222222',
        addresses: [
          {
            id: 'ADDR_004',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '22',
            flat_number: '',
            floor_number: '',
            street_name: 'Ø´Ø§Ø±Ø¹ Ø£Ø­Ù…Ø¯ Ø¹Ø±Ø§Ø¨ÙŠ',
            address_marking: '',
            address_district: 'Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†',
            address_governorate: 'Ø§Ù„Ø¬ÙŠØ²Ø©',
            district_id: '420000000000006',
            area_id: '420000000000601',
            area: 'Ø§Ù„Ø¯Ù‚ÙŠ',
            isPrimary: true
          }
        ],
        totalOrders: 2,
        totalSpent: 680.75,
        lastOrderDate: '2025-06-08'
      },
      {
        id: 'CUST-004',
        name: 'Ø³Ø§Ø±Ø© Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯',
        phone: '01333333333',
        addresses: [
          {
            id: 'ADDR_005',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '10',
            flat_number: '2',
            floor_number: '2',
            street_name: 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¨Ø©',
            address_marking: '',
            address_district: 'Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±',
            address_governorate: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
            district_id: '420000000000005',
            area_id: '420000000000501',
            area: 'Ø§Ù„Ø­ÙŠ Ø§Ù„Ø£ÙˆÙ„',
            isPrimary: true
          }
        ],
        totalOrders: 1,
        totalSpent: 520.25,
        lastOrderDate: '2025-06-06'
      }
    ];

    let leads = [
      {
        lead_name: 'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†',
        lead_type: 'customer',
        lead_comment: 'Ù…Ù‡ØªÙ… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©ØŒ Ø·Ù„Ø¨ ÙƒØªØ§Ù„ÙˆØ¬',
        lead_phone: '01544444444',
        lead_email: 'khalid@email.com',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Facebook'
      },
      {
        lead_name: 'Ø±ÙŠÙ… Ù…Ø­Ù…ÙˆØ¯',
        lead_type: 'customer',
        lead_comment: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù„Ø·Ù„Ø¨ÙŠØ© Ø´Ù‡Ø±ÙŠØ©',
        lead_phone: '01655555555',
        lead_email: 'reem.m@email.com',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Google'
      },
      {
        lead_name: 'Ø¹Ù…Ø± Ø§Ù„Ø´Ø±ÙŠÙ',
        lead_type: 'customer',
        lead_comment: 'Ø¥Ø­Ø§Ù„Ø© Ù…Ù† Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
        lead_phone: '01766666666',
        lead_email: '',
        primary_source_of_sale: 'Referral',
        secondary_source_of_sale: ''
      },
      {
        lead_name: 'Ù†ÙˆØ±Ø§ Ø­Ø³Ø§Ù…',
        lead_type: 'customer',
        lead_comment: 'ØºÙŠØ± Ù…Ù‡ØªÙ…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ 3 Ø£Ø´Ù‡Ø±',
        lead_phone: '01877777777',
        lead_email: 'nora.h@email.com',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Instagram'
      }
    ];

    // ===== STATE MANAGEMENT =====
    let appState = {
      currentSection: 'orders',
      orderFilter: 'all',
      selectedCustomer: null,
      selectedAddress: null,
      newOrderForm: {
        customer: null,
        address: null,
        items: [],
        notes: '',
        source: '',
        secondarySource: ''
      },
      isAddingNewAddress: false
    };

    // ===== API MODULE =====
    const API = {
      activeRequests: {},

      request: function (functionName, data = {}, options = {}) {
        const {
          showLoader = true,
          loaderMessage = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...',
          hideToastOnSuccess = false,
          successMessage = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­',
          errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
          preventDuplicateSubmission = true,
          requestId = functionName
        } = options;

        const trackingId = requestId;

        if (preventDuplicateSubmission && this.activeRequests[trackingId]) {
          console.warn(`Preventing duplicate submission for: ${trackingId}`);
          return Promise.reject(new Error(`Request ${trackingId} already in progress`));
        }

        if (preventDuplicateSubmission) {
          this.activeRequests[trackingId] = true;
        }

        return new Promise((resolve, reject) => {
          if (showLoader) {
            updateLoadingMessage(loaderMessage);
            showGlobalLoader();
          }

          // Simulate API delay
          setTimeout(() => {
            try {
              const result = this.handleMockRequest(functionName, data);

              if (showLoader) {
                hideGlobalLoader();
              }

              if (!hideToastOnSuccess) {
                showToast('success', successMessage);
              }

              if (preventDuplicateSubmission) {
                delete this.activeRequests[trackingId];
              }

              resolve(result);
            } catch (error) {
              if (showLoader) {
                hideGlobalLoader();
              }

              showToast('error', errorMessage);

              if (preventDuplicateSubmission) {
                delete this.activeRequests[trackingId];
              }

              reject(error);
            }
          }, 800 + Math.random() * 500);
        });
      },

      handleMockRequest: function (functionName, data) {
        switch (functionName) {
          case 'getOrders':
            return orders;
          case 'getCustomers':
            return customers;
          case 'getLeads':
            return leads;
          case 'getProducts':
            return products;
          case 'getLocations':
            return districts;
          case 'updateOrderStatus':
            const order = orders.find(o => o.id === data.orderId);
            if (order) {
              order.status = data.status;
              return order;
            }
            throw new Error('Order not found');
          case 'addOrder':
            const newOrder = {
              id: `AFI-${String(orders.length + 1).padStart(3, '0')}`,
              customerId: data.customer.id || `CUST-${Date.now()}`,
              customerName: data.customer.name,
              customerPhone: data.customer.phone,
              date: new Date().toISOString().split('T')[0],
              amount: data.items.reduce((total, item) => total + (item.price * item.quantity), 0),
              status: 'pending',
              items: data.items,
              address: data.address ? `${data.address.area}` : data.customer.address,
              comments: data.notes || ''
            };
            orders.unshift(newOrder);
            return newOrder;
          case 'addCustomer':
            const newCustomer = {
              id: `CUST-${Date.now()}`,
              name: data.name,
              phone: data.phone,
              addresses: [{
                id: `ADDR-${Date.now()}`,
                street: data.address,
                district: data.district,
                area: data.area,
                isPrimary: true,
                label: 'Ø§Ù„Ù…Ù†Ø²Ù„'
              }],
              totalOrders: 0,
              totalSpent: 0,
              lastOrderDate: null
            };
            customers.push(newCustomer);
            return newCustomer;
          default:
            throw new Error('Unknown function: ' + functionName);
        }
      },

      getOrders: function () {
        return this.request('getOrders', {}, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...',
          hideToastOnSuccess: true
        });
      },

      getCustomers: function () {
        return this.request('getCustomers', {}, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...',
          hideToastOnSuccess: true
        });
      },

      getProducts: function () {
        return this.request('getProducts', {}, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...',
          hideToastOnSuccess: true
        });
      },

      getLocations: function () {
        return this.request('getLocations', {}, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹...',
          hideToastOnSuccess: true
        });
      },

      updateOrderStatus: function (orderId, status) {
        return this.request('updateOrderStatus', { orderId, status }, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨...',
          successMessage: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­'
        });
      },

      addOrder: function (orderData) {
        return this.request('addOrder', orderData, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨...',
          successMessage: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­'
        });
      },

      addCustomer: function (customerData) {
        return this.request('addCustomer', customerData, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„...',
          successMessage: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­'
        });
      },

      getLeads: function () {
        return this.request('getLeads', {}, {
          loaderMessage: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†...',
          hideToastOnSuccess: true
        });
      }
    };

    // ===== UTILITY FUNCTIONS =====
    function updateLoadingMessage(message) {
      document.getElementById('loadingMessage').textContent = message;
    }

    function showGlobalLoader() {
      document.getElementById('loadingScreen').classList.remove('hidden');
    }

    function hideGlobalLoader() {
      document.getElementById('loadingScreen').classList.add('hidden');
    }

    function showToast(type, title, message = '') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle'
      };

      toast.innerHTML = `
        <div class="toast-icon"><i class="fas fa-${icons[type]}"></i></div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

      toastContainer.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function formatCurrency(amount) {
      return `${amount.toFixed(2)} Ø¬.Ù…`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-EG');
    }

    // ===== NAVIGATION =====
    function initializeNavigation() {
      const navTabs = document.querySelectorAll('.nav-tab');
      const contentSections = document.querySelectorAll('.content-section');

      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetSection = tab.dataset.section;

          // Update nav tabs
          navTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update content sections
          contentSections.forEach(section => section.classList.remove('active'));
          document.getElementById(targetSection).classList.add('active');

          appState.currentSection = targetSection;

          // Load section data if needed
          if (targetSection === 'customers') {
            loadCustomers();
          } else if (targetSection === 'leads') {
            loadLeads();
          }
        });
      });
    }

    // ===== ORDERS MANAGEMENT =====
    function initializeOrderFilters() {
      const filterButtons = document.querySelectorAll('.filter-btn');

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;

          // Update filter buttons
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          appState.orderFilter = filter;
          renderOrders();
        });
      });
    }

    function loadOrders() {
      API.getOrders().then(orders => {
        orders = orders;
        updateOrderCounts();
        renderOrders();
      }).catch(error => {
        console.error('Failed to load orders:', error);
      });
    }

    function updateOrderCounts() {
      const counts = {
        all: orders.length,
        pending: orders.filter(o => o.status === 'pending').length,
        inprogress: orders.filter(o => o.status === 'in-progress').length,
        readyforshipment: orders.filter(o => o.status === 'ready-for-shipment').length,
        outfordelivery: orders.filter(o => o.status === 'out-for-delivery').length,
        delivered: orders.filter(o => o.status === 'delivered').length
      };

      // Update badges with correct IDs
      document.getElementById('allCount').textContent = counts.all;
      document.getElementById('pendingCount').textContent = counts.pending;
      document.getElementById('inProgressCount').textContent = counts.inprogress;
      document.getElementById('readyForShipmentCount').textContent = counts.readyforshipment;
      document.getElementById('outForDeliveryCount').textContent = counts.outfordelivery;
      document.getElementById('deliveredCount').textContent = counts.delivered;
    }

    function renderOrders() {
      const tbody = document.getElementById('ordersTableBody');
      let filteredOrders = orders;

      if (appState.orderFilter !== 'all') {
        filteredOrders = orders.filter(order => order.status === appState.orderFilter);
      }

      tbody.innerHTML = filteredOrders.map(order => {
        const totalItems = order.items.length;
        const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);

        return `
          <tr class="order-row" onclick="toggleOrderDetails('${order.id}')" data-order-id="${order.id}">
            <td><strong>${order.id}</strong></td>
            <td>
              <div>
                <strong>${order.customerName}</strong><br>
                <small style="color: var(--gray-500);">${order.customerPhone}</small>
              </div>
            </td>
            <td>${formatDate(order.date)}</td>
            <td><strong>${formatCurrency(order.amount)}</strong></td>
            <td>
              <select class="form-select" style="padding: 0.5rem; font-size: 0.875rem;" onchange="changeOrderStatus('${order.id}', this.value)" onclick="event.stopPropagation()">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</option>
                <option value="ready-for-shipment" ${order.status === 'ready-for-shipment' ? 'selected' : ''}>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø´Ø­Ù†</option>
                <option value="out-for-delivery" ${order.status === 'out-for-delivery' ? 'selected' : ''}>ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
              </select>
            </td>
          </tr>
          <tr class="order-details-row" id="details-${order.id}">
            <td colspan="6">
              <div class="order-details-content">
                <div class="order-summary">
                  <div class="summary-item">
                    <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                    <div class="summary-value">${totalItems}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                    <div class="summary-value">${totalQuantity}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
                    <div class="summary-value">${order.address}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</div>
                    <div class="summary-value">${formatDate(order.date)}</div>
                  </div>
                </div>
                
                ${order.comments ? `
                  <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid var(--info);">
                    <h5 style="margin-bottom: 0.5rem; color: var(--gray-700);"><i class="fas fa-comment"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨:</h5>
                    <p style="margin: 0; color: var(--gray-600);">${order.comments}</p>
                  </div>
                ` : ''}
                
                <h4 style="margin-bottom: 1rem; color: var(--gray-700);">
                  <i class="fas fa-list"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </h4>
                
                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                      <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                      <th>Ø§Ù„Ø³Ø¹Ø±</th>
                      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                      <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${order.items.map(item => `
                      <tr>
                        <td><strong>${item.productName}</strong></td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td><strong>${formatCurrency(item.price * item.quantity)}</strong></td>
                        <td>${item.comments || '-'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: var(--gray-100); font-weight: 600;">
                      <td colspan="4" style="text-align: left; padding: 1rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</td>
                      <td style="padding: 1rem;"><strong>${formatCurrency(order.amount)}</strong></td>
                      <td style="padding: 1rem;"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function toggleOrderDetails(orderId) {
      const detailsRow = document.getElementById(`details-${orderId}`);
      const expandIcon = document.getElementById(`expand-${orderId}`);
      const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);

      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        if (expandIcon) expandIcon.classList.remove('rotated');
        orderRow.classList.remove('expanded');
      } else {
        // Close all other expanded rows first
        document.querySelectorAll('.order-details-row.show').forEach(row => {
          row.classList.remove('show');
        });
        document.querySelectorAll('.expand-icon.rotated').forEach(icon => {
          icon.classList.remove('rotated');
        });
        document.querySelectorAll('.order-row.expanded').forEach(row => {
          row.classList.remove('expanded');
        });

        // Open the clicked row
        detailsRow.classList.add('show');
        if (expandIcon) expandIcon.classList.add('rotated');
        orderRow.classList.add('expanded');
      }
    }

    function changeOrderStatus(orderId, newStatus) {
      API.updateOrderStatus(orderId, newStatus).then(updatedOrder => {
        updateOrderCounts();
        renderOrders();
      }).catch(error => {
        console.error('Failed to update order status:', error);
        // Revert the select to original value
        loadOrders();
      });
    }

    // ===== CUSTOMERS MANAGEMENT =====
    function loadCustomers() {
      API.getCustomers().then(customers => {
        customers = customers;
        renderCustomers();
      }).catch(error => {
        console.error('Failed to load customers:', error);
      });
    }

    function renderCustomers() {
      const grid = document.getElementById('customersGrid');

      grid.innerHTML = customers.map(customer => {
        const primaryAddress = customer.addresses.find(addr => addr.isPrimary) || customer.addresses[0];
        return `
          <div class="customer-card">
            <div class="customer-header">
              <div class="customer-info">
                <h3>${customer.name}</h3>
                <p><i class="fas fa-phone"></i> ${customer.phone}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${primaryAddress.area}${primaryAddress.address_governorate ? ', ' + primaryAddress.address_governorate : ''}</p>
              </div>
            </div>
            <div class="customer-stats">
              <div class="stat">
                <div class="stat-value">${customer.totalOrders}</div>
                <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
              </div>
              <div class="stat">
                <div class="stat-value">${formatCurrency(customer.totalSpent)}</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
              </div>
            </div>
            ${customer.lastOrderDate ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); text-align: center; color: var(--gray-500); font-size: 0.9rem;">
                Ø¢Ø®Ø± Ø·Ù„Ø¨: ${formatDate(customer.lastOrderDate)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ===== NEW ORDER MODAL =====
    function openNewOrderModal() {
      document.getElementById('newOrderModal').classList.add('show');
      resetNewOrderForm();
    }

    function closeNewOrderModal() {
      document.getElementById('newOrderModal').classList.remove('show');
      resetNewOrderForm();
    }

    function resetNewOrderForm() {
      const customerSearch = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');

      if (customerSearch) customerSearch.value = '';
      if (searchResults) searchResults.classList.remove('show');

      // Hide all form sections
      hideAllFormSections();

      // Reset form fields
      ['customerName', 'customerPhone', 'customerAddress', 'customerDistrict', 'customerArea', 'orderSource', 'orderSecondarySource', 'orderComments'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });

      // Reset new address fields
      ['newAddressStreet', 'newAddressDistrict', 'newAddressArea', 'newAddressLabel'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });

      // Clear items table
      const itemsTableBody = document.getElementById('itemsTableBody');
      if (itemsTableBody) itemsTableBody.innerHTML = '';

      // Reset state
      appState.newOrderForm = {
        customer: null,
        address: null,
        items: [],
        notes: '',
        source: '',
        secondarySource: ''
      };
      appState.selectedCustomer = null;
      appState.selectedAddress = null;
      appState.isAddingNewAddress = false;
    }

    function hideAllFormSections() {
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('show');
      });
    }

    function showCustomerDetailsSection() {
      hideAllFormSections();
      document.getElementById('customerDetailsSection').classList.add('show');
      document.getElementById('orderDetailsSection').classList.add('show');
      
      // Initialize with one empty item if none exist
      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function showAddressSection() {
      hideAllFormSections();
      document.getElementById('addressSection').classList.add('show');
    }

    function showNewAddressForm() {
      hideAllFormSections();
      appState.isAddingNewAddress = true;
      document.getElementById('newAddressSection').classList.add('show');
      initializeDistrictSearch();
    }

    function showOrderDetailsSection() {
      document.getElementById('orderDetailsSection').classList.add('show');
      
      // Initialize with one empty item if none exist
      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function initializeDistrictSearch() {
      const input = document.getElementById('newAddressDistrictSearch');
      const results = document.getElementById('districtSearchResults');
      const chevron = document.getElementById('districtChevron');
      const hiddenDistrict = document.getElementById('newAddressDistrict');
      const hiddenGovernorate = document.getElementById('newAddressGovernorate');
      const hiddenDistrictId = document.getElementById('newDistrictId');
      let isOpen = false;

      function highlightMatch(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, 'gi');
        return text.replace(regex, '<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
      }

      function renderDistrictResults(filtered, term) {
        if (!filtered.length) {
          results.innerHTML = '<div class="search-result">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
          results.classList.add('show');
          isOpen = true;
          chevron.style.transform = 'translateY(-50%) rotate(180deg)';
          return;
        }
        results.innerHTML = filtered.map(d =>
          `<div class="search-result" data-id="${d.district_id}" data-name="${d.district_name}" data-gov="${d.governorate_name}">
            ${highlightMatch(d.district_name, term)} - ${highlightMatch(d.governorate_name, term)}
          </div>`
        ).join('');
        results.classList.add('show');
        isOpen = true;
        chevron.style.transform = 'translateY(-50%) rotate(180deg)';
      }

      function closeDropdown() {
        results.classList.remove('show');
        isOpen = false;
        chevron.style.transform = 'translateY(-50%)';
      }

      function filterDistricts(term) {
        term = term.trim().toLowerCase();
        if (!term) return districts;
        return districts.filter(d =>
          d.district_name.toLowerCase().includes(term) ||
          d.governorate_name.toLowerCase().includes(term)
        );
      }

      input.addEventListener('input', function() {
        const filtered = filterDistricts(input.value);
        renderDistrictResults(filtered, input.value.trim());
      });
      input.addEventListener('focus', function() {
        if (!isOpen) {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      input.addEventListener('click', function() {
        if (isOpen) {
          closeDropdown();
        } else {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.form-group')) {
          closeDropdown();
        }
      });
      results.addEventListener('click', function(e) {
        const item = e.target.closest('.search-result[data-id]');
        if (item) {
          input.value = item.dataset.name + ' - ' + item.dataset.gov;
          hiddenDistrict.value = item.dataset.name;
          hiddenGovernorate.value = item.dataset.gov;
          hiddenDistrictId.value = item.dataset.id;
          closeDropdown();
        }
      });
    }

    function saveNewAddress() {
      const label = document.getElementById('newAddressLabel').value;
      const comment = document.getElementById('newAddressComment').value.trim();
      const houseNumber = document.getElementById('newHouseNumber').value.trim();
      const flatNumber = document.getElementById('newFlatNumber').value.trim();
      const floorNumber = document.getElementById('newFloorNumber').value.trim();
      const street = document.getElementById('newStreetName').value.trim();
      const marking = document.getElementById('newAddressMarking').value.trim();
      const districtId = document.getElementById('newDistrictId').value;
      const governorate = document.getElementById('newAddressGovernorate').value;

      if (!street || !districtId) {
        showToast('error', 'ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      const selectedDistrict = districts.find(d => d.district_id === districtId);
      const addressDistrict = selectedDistrict ? selectedDistrict.district_name : '';
      const addressGovernorate = selectedDistrict ? selectedDistrict.governorate_name : '';

      const newAddress = {
        id: `ADDR-${Date.now()}`,
        address_label: label,
        address_comment: comment,
        house_number: houseNumber,
        flat_number: flatNumber,
        floor_number: floorNumber,
        street_name: street,
        address_marking: marking,
        address_district: addressDistrict,
        address_governorate: addressGovernorate,
        district_id: districtId,
        isPrimary: false
      };

      // Add to selected customer addresses
      if (appState.selectedCustomer) {
        appState.selectedCustomer.addresses.push(newAddress);
        showAddressSection();
        renderAddresses(appState.selectedCustomer.addresses);
        selectAddress(newAddress);
        showToast('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    function cancelNewAddress() {
      if (appState.selectedCustomer && appState.selectedCustomer.addresses.length > 0) {
        showAddressSection();
        renderAddresses(appState.selectedCustomer.addresses);
      } else {
        hideAllFormSections();
      }
    }

    function initializeLocationDropdowns() {
      const districtSelect = document.getElementById('customerDistrict');
      const areaSelect = document.getElementById('customerArea');

      // Only proceed if both elements exist
      if (!districtSelect || !areaSelect) return;

      // Populate districts
      districtSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>' +
        districts.map(district =>
          `<option value="${district.id}">${district.name}</option>`
        ).join('');

      districtSelect.addEventListener('change', function () {
        const selectedDistrict = districtSelect.value;
        areaSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠ</option>';

        if (selectedDistrict && locations.areas[selectedDistrict]) {
          areaSelect.innerHTML += locations.areas[selectedDistrict].map(area =>
            `<option value="${area.id}">${area.name}</option>`
          ).join('');
        }
      });
    }

    function initializeSourceDropdowns() {
      const sourceSelect = document.getElementById('orderSource');
      const secondarySourceSelect = document.getElementById('orderSecondarySource');

      // Only proceed if both elements exist
      if (!sourceSelect || !secondarySourceSelect) return;

      const sourceMappings = {
        'website': [
          { value: 'facebook', text: 'ÙÙŠØ³Ø¨ÙˆÙƒ' },
          { value: 'instagram', text: 'Ø¥Ù†Ø³ØªØºØ±Ø§Ù…' },
          { value: 'google', text: 'Ø¬ÙˆØ¬Ù„' },
          { value: 'direct', text: 'Ù…Ø¨Ø§Ø´Ø±' },
          { value: 'linktree', text: 'Ù„ÙŠÙ†Ùƒ ØªØ±ÙŠ' },
          { value: 'other', text: 'Ø£Ø®Ø±Ù‰' }
        ],
        'social': [
          { value: 'facebook', text: 'ÙÙŠØ³Ø¨ÙˆÙƒ' },
          { value: 'instagram', text: 'Ø¥Ù†Ø³ØªØºØ±Ø§Ù…' },
          { value: 'google', text: 'Ø¬ÙˆØ¬Ù„' }
        ]
      };

      sourceSelect.addEventListener('change', function () {
        const selectedSource = sourceSelect.value;
        secondarySourceSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>';

        if (selectedSource && sourceMappings[selectedSource]) {
          secondarySourceSelect.innerHTML += sourceMappings[selectedSource].map(option =>
            `<option value="${option.value}">${option.text}</option>`
          ).join('');
        }
      });
    }

    function selectCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        appState.selectedCustomer = customer;
        appState.newOrderForm.customer = customer;

        document.getElementById('customerSearch').value = customer.name;
        document.getElementById('searchResults').classList.remove('show');

        if (customer.addresses.length > 0) {
          showAddressSection();
          renderAddresses(customer.addresses);
        } else {
          showNewAddressForm();
        }
      }
    }

    function renderAddresses(addresses) {
      const addressGrid = document.getElementById('addressGrid');

      addressGrid.innerHTML = addresses.map(address => {
        let icon = 'map-marker-alt';
        switch (address.address_label) {
          case 'Home': icon = 'home'; break;
          case 'Work': icon = 'building'; break;
          case 'Family': icon = 'users'; break;
          case 'Friend': icon = 'handshake'; break;
          case 'Warehouse': icon = 'warehouse'; break;
          case 'Chalet': icon = 'umbrella-beach'; break;
          case 'Farm': icon = 'tractor'; break;
          case 'Shop': icon = 'store'; break;
          case 'Other': icon = 'map-marker-alt'; break;
        }
        return `
          <div class="address-card" onclick="selectAddress('${address.id}')">
            <div class="address-label">
              <i class="fas fa-${icon}"></i>
              ${address.address_label}
            </div>
            <div class="address-details">
              ${address.street_name}ØŒ Ù…Ù†Ø²Ù„ ${address.house_number}${address.flat_number ? 'ØŒ Ø´Ù‚Ø© ' + address.flat_number : ''}${address.floor_number ? 'ØŒ Ø¯ÙˆØ± ' + address.floor_number : ''}<br>
              ${address.address_district} - ${address.address_governorate}
            </div>
            ${address.address_comment ? `<div class="address-comment">${address.address_comment}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function selectAddress(addressId) {
      let address;

      if (typeof addressId === 'string') {
        address = appState.selectedCustomer.addresses.find(a => a.id === addressId);
        // Update UI
        document.querySelectorAll('.address-card').forEach(card => card.classList.remove('selected'));
        event.target.closest('.address-card').classList.add('selected');
      } else {
        address = addressId; // Direct address object
      }

      if (address) {
        appState.selectedAddress = address;
        appState.newOrderForm.address = address;
        showToast('success', 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', address.address_label);

        showOrderDetailsSection();
      }
    }

    // ===== UNITS ARRAY =====
    const units = [
      { id: 'piece', name: 'Ù‚Ø·Ø¹Ø©' },
      { id: 'kilo', name: 'ÙƒÙŠÙ„Ùˆ' },
      { id: 'liter', name: 'Ù„ØªØ±' },
      { id: 'pack', name: 'Ø¹Ø¨ÙˆØ©' },
      { id: 'bag', name: 'ÙƒÙŠØ³' },
      { id: 'bottle', name: 'Ø²Ø¬Ø§Ø¬Ø©' }
    ];

    function addOrderItem() {
      const tbody = document.getElementById('itemsTableBody');
      const rowIndex = tbody.children.length;

      const row = document.createElement('tr');

      // Custom searchable dropdown for products
      row.innerHTML = `
        <td>
          <div class="custom-dropdown" data-row-index="${rowIndex}">
            <div class="custom-dropdown-box" tabindex="0">
              <input type="text" class="custom-dropdown-input" placeholder="Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬..." readonly />
              <i class="fas fa-chevron-down custom-dropdown-chevron"></i>
            </div>
            <div class="custom-dropdown-list"></div>
          </div>
        </td>
        <td>
          <input type="number" class="form-input quantity-input" min="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" onchange="updateOrderItem(${rowIndex})">
        </td>
        <td>
          <select class="form-select unit-select" onchange="updateOrderItem(${rowIndex})">
            ${units.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('')}
          </select>
        </td>
        <td>
          <span class="price-display">0.00 Ø¬.Ù…</span>
        </td>
        <td>
          <input type="text" class="form-input comment-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬" onchange="updateOrderItem(${rowIndex})">
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      tbody.appendChild(row);

      const newItem = {
        id: Date.now(),
        productId: '',
        productName: '',
        quantity: 0,
        unit: units[0].id,
        comments: '',
        price: 0
      };

      appState.newOrderForm.items.push(newItem);

      // Initialize the custom dropdown for this row
      initializeProductDropdown(row, rowIndex);
    }

    function removeOrderItem(button) {
      const row = button.closest('tr');
      const tbody = row.parentNode;
      const rowIndex = Array.from(tbody.children).indexOf(row);

      row.remove();
      appState.newOrderForm.items.splice(rowIndex, 1);

      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function updateOrderItem(rowIndex) {
      const row = document.getElementById('itemsTableBody').children[rowIndex];
      // Support custom product dropdown
      const productInput = row.querySelector('.custom-dropdown-input');
      let productId = '';
      let productName = '';
      let price = 0;

      if (productInput) {
        productId = productInput.getAttribute('data-id') || '';
        productName = productInput.value || '';
        price = parseFloat(productInput.getAttribute('data-price')) || 0;
      } else {
        // fallback for select (legacy)
        const productSelect = row.querySelector('.product-select');
        if (productSelect) {
          const selectedOption = productSelect.selectedOptions[0];
          productId = productSelect.value;
          productName = selectedOption ? selectedOption.textContent : '';
          price = selectedOption && selectedOption.dataset.price ? parseFloat(selectedOption.dataset.price) : 0;
        }
      }

      const quantityInput = row.querySelector('.quantity-input');
      const unitSelect = row.querySelector('.unit-select');
      const commentInput = row.querySelector('.comment-input');
      const priceDisplay = row.querySelector('.price-display');

      if (appState.newOrderForm.items[rowIndex]) {
        appState.newOrderForm.items[rowIndex] = {
          id: appState.newOrderForm.items[rowIndex].id,
          productId: productId,
          productName: productName,
          quantity: parseInt(quantityInput.value) || 0,
          unit: unitSelect.value,
          comments: commentInput.value,
          price: price
        };
        // Update price display
        priceDisplay.textContent = formatCurrency(price);
      }
    }

    function initializeCustomerSearch() {
      const searchInput = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');

      searchInput.addEventListener('input', debounce(handleCustomerSearch, 300));
      searchInput.addEventListener('focus', () => {
        if (searchInput.value.trim()) {
          handleCustomerSearch();
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.customer-search')) {
          searchResults.classList.remove('show');
        }
      });
    }

    function handleCustomerSearch() {
      const searchInput = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');
      const term = searchInput.value.trim().toLowerCase();

      if (term.length < 2) {
        searchResults.classList.remove('show');
        return;
      }

      const filtered = customers.filter(customer =>
        customer.name.toLowerCase().includes(term) ||
        customer.phone.includes(term)
      );

      if (filtered.length > 0) {
        renderSearchResults(filtered, term);
        searchResults.classList.add('show');
      } else {
        searchResults.innerHTML = `
          <div class="search-result new-customer-option" onclick="showNewCustomerForm('${term}')">
            <div>
              <h4><i class="fas fa-plus"></i> Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: "${term}"</h4>
              <p>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</p>
            </div>
          </div>
        `;
        searchResults.classList.add('show');
      }
    }

    function showNewCustomerForm(searchTerm = '') {
      document.getElementById('searchResults').classList.remove('show');
      
      // Clear existing customer data
      appState.selectedCustomer = null;
      appState.newOrderForm.customer = null;
      appState.selectedAddress = null;
      appState.newOrderForm.address = null;

      showCustomerDetailsSection();

      if (searchTerm) {
        document.getElementById('customerName').value = searchTerm;
        document.getElementById('customerSearch').value = searchTerm;
      }

      showToast('success', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
    }

    function renderSearchResults(customers, searchTerm) {
      const searchResults = document.getElementById('searchResults');

      let html = customers.map(customer => {
        const primaryAddress = customer.addresses.find(addr => addr.isPrimary) || customer.addresses[0];
        return `
          <div class="search-result" onclick="selectCustomer('${customer.id}')">
            <div>
              <h4>${highlightMatch(customer.name, searchTerm)}</h4>
              <p>${highlightMatch(customer.phone, searchTerm)} - ${primaryAddress.area}</p>
            </div>
          </div>
        `;
      }).join('');

      html += `
        <div class="search-result new-customer-option" onclick="showNewCustomerForm('${searchTerm}')">
          <div>
            <h4><i class="fas fa-plus"></i> Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: "${searchTerm}"</h4>
            <p>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</p>
          </div>
        </div>
      `;

      searchResults.innerHTML = html;
    }

    function highlightMatch(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
    }

  function validateOrderForm() {
      let isValid = true;
      const errors = [];

      // Check customer selection or form completion
      if (!appState.selectedCustomer) {
        const requiredFields = ['customerName', 'customerPhone', 'primarySourceOfSale'];
        for (const fieldId of requiredFields) {
          const field = document.getElementById(fieldId);
          if (!field) {
            errors.push(`Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${fieldId}`);
            isValid = false;
            continue;
          }
          if (!field.value || !field.value.trim()) {
            field.classList.add('error');
            setTimeout(() => field.classList.remove('error'), 3000);
            errors.push(`ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨`);
            isValid = false;
          }
        }
      }

      // Check address selection
      if (!appState.selectedAddress && !appState.isAddingNewAddress) {
        errors.push('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„');
        isValid = false;
      }

      // Check items
      if (!appState.newOrderForm.items || appState.newOrderForm.items.length === 0) {
        errors.push('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        isValid = false;
      }

      // Validate individual items
      let itemsValid = true;
      const itemsTableBody = document.getElementById('itemsTableBody');
      
      if (itemsTableBody && appState.newOrderForm.items) {
        for (let i = 0; i < appState.newOrderForm.items.length; i++) {
          const row = itemsTableBody.children[i];
          if (!row) continue;
          
          // Check for custom dropdown or regular select
          const productInput = row.querySelector('.custom-dropdown-input');
          const productSelect = row.querySelector('.product-select');
          const quantityInput = row.querySelector('.quantity-input');

          // Validate product selection
          let productSelected = false;
          if (productInput && productInput.getAttribute('data-id')) {
            productSelected = true;
          } else if (productSelect && productSelect.value) {
            productSelected = true;
          }

          if (!productSelected) {
            if (productInput) {
              productInput.classList.add('error');
              setTimeout(() => productInput.classList.remove('error'), 3000);
            } else if (productSelect) {
              productSelect.classList.add('error');
              setTimeout(() => productSelect.classList.remove('error'), 3000);
            }
            itemsValid = false;
          }

          // Validate quantity
          if (!quantityInput || !quantityInput.value || quantityInput.value <= 0) {
            if (quantityInput) {
              quantityInput.classList.add('error');
              setTimeout(() => quantityInput.classList.remove('error'), 3000);
            }
            itemsValid = false;
          }
        }
      }

      if (!itemsValid) {
        errors.push('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ù„ÙƒÙ„ ØµÙ');
        isValid = false;
      }

      if (!isValid) {
        showToast('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', errors.join(' â€¢ '));
      }

      return isValid;
    }

    function submitOrder() {
      // Validate form
      if (!validateOrderForm()) {
        return;
      }

      // Update all items from form
      for (let i = 0; i < appState.newOrderForm.items.length; i++) {
        updateOrderItem(i);
      }

      // Filter out empty items
      const validItems = appState.newOrderForm.items.filter(item =>
        item.productId && item.quantity > 0
      );

      let customer = appState.selectedCustomer;

      // If no existing customer selected, create new one
      if (!customer) {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const whatsapp = document.getElementById('customerWhatsapp').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const comment = document.getElementById('customerComment').value.trim();
        const primarySource = document.getElementById('primarySourceOfSale').value;
        const secondarySource = document.getElementById('secondarySourceOfSale').value;
        const customerType = document.getElementById('customerType').value;

        if (!name || !phone || !primarySource) {
          showToast('error', 'ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
          return;
        }

        const customerData = {
          customer_name: name,
          customer_type: customerType,
          customer_comment: comment,
          primary_source_of_sale: primarySource,
          secondary_source_of_sale: secondarySource,
          customer_phone: phone,
          customer_whatsapp: whatsapp,
          customer_email: email
        };

        API.addCustomer(customerData).then(newCustomer => {
          customers.push(newCustomer);
          return createOrderWithCustomer(newCustomer, validItems);
        }).then(newOrder => {
          handleOrderCreated(newOrder);
        }).catch(error => {
          console.error('Failed to create customer:', error);
        });

        return;
      }

      createOrderWithCustomer(customer, validItems).then(newOrder => {
        handleOrderCreated(newOrder);
      }).catch(error => {
        console.error('Failed to create order:', error);
      });
    }

    function createOrderWithCustomer(customer, items) {
      const orderData = {
        customer: customer,
        address: appState.selectedAddress,
        items: items,
        notes: document.getElementById('orderComments').value.trim(),
        source: document.getElementById('orderSource') ? document.getElementById('orderSource').value : '',
        secondarySource: document.getElementById('orderSecondarySource') ? document.getElementById('orderSecondarySource').value : ''
      };

      return API.addOrder(orderData);
    }

    function handleOrderCreated(newOrder) {
      closeNewOrderModal();
      loadOrders(); // Refresh orders list
      showToast('success', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${newOrder.id}`);
    }

    // ===== INITIALIZATION =====
    function initializeApp() {
      updateLoadingMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

      // Initialize components
      initializeNavigation();
      initializeOrderFilters();
      initializeCustomerSearch();
      initializeLocationDropdowns();
      initializeSourceDropdowns();

      // Load initial data
      Promise.all([
        API.getOrders(),
        API.getProducts(),
        API.getLocations()
      ]).then(([orders, products, locations]) => {
        orders = orders;
        products = products;
        locations = locations;

        updateOrderCounts();
        renderOrders();
        hideGlobalLoader();
        showToast('success', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
      }).catch(error => {
        hideGlobalLoader();
        showToast('error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        console.error('App initialization failed:', error);
      });
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', initializeApp);

    // ===== Global functions for onclick handlers (moved to very end for guaranteed global exposure) =====
    window.openNewOrderModal = openNewOrderModal;
    window.closeNewOrderModal = closeNewOrderModal;
    window.selectCustomer = selectCustomer;
    window.showNewCustomerForm = showNewCustomerForm;
    window.showNewAddressForm = showNewAddressForm;
    window.saveNewAddress = saveNewAddress;
    window.cancelNewAddress = cancelNewAddress;
    window.selectAddress = selectAddress;
    window.addOrderItem = addOrderItem;
    window.removeOrderItem = removeOrderItem;
    window.updateOrderItem = updateOrderItem;
    window.submitOrder = submitOrder;
    window.changeOrderStatus = changeOrderStatus;
    window.toggleOrderDetails = toggleOrderDetails;

    // ===== ADD CUSTOMER MODAL LOGIC =====
    function openAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.add('show');
      resetAddCustomerForm();
      initializeAddCustomerLocationDropdowns();
    }
    function closeAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.remove('show');
      resetAddCustomerForm();
    }
    function resetAddCustomerForm() {
      ['addCustomerName', 'addCustomerPhone', 'addCustomerAddress', 'addCustomerDistrict', 'addCustomerArea'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }
    function initializeAddCustomerLocationDropdowns() {
      const districtSelect = document.getElementById('addCustomerDistrict');
      const areaSelect = document.getElementById('addCustomerArea');
      if (!districtSelect || !areaSelect) return;
      districtSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>' +
        districts.map(district =>
          `<option value="${district.id}">${district.name}</option>`
        ).join('');
      districtSelect.addEventListener('change', function () {
        const selectedDistrict = districtSelect.value;
        areaSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠ</option>';
        if (selectedDistrict && locations.areas[selectedDistrict]) {
          areaSelect.innerHTML += locations.areas[selectedDistrict].map(area =>
            `<option value="${area.id}">${area.name}</option>`
          ).join('');
        }
      });
    }
    function submitAddCustomer() {
      const name = document.getElementById('addCustomerName').value.trim();
      const phone = document.getElementById('addCustomerPhone').value.trim();
      const whatsapp = document.getElementById('addCustomerWhatsapp').value.trim();
      const email = document.getElementById('addCustomerEmail').value.trim();
      const comment = document.getElementById('addCustomerComment').value.trim();
      const primarySource = document.getElementById('addCustomerPrimarySourceOfSale').value;
      const secondarySource = document.getElementById('addCustomerSecondarySourceOfSale').value;
      const customerType = document.getElementById('addCustomerType').value;

      if (!name || !phone || !primarySource) {
        showToast('error', 'ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      const customerData = {
        customer_name: name,
        customer_type: customerType,
        customer_comment: comment,
        primary_source_of_sale: primarySource,
        secondary_source_of_sale: secondarySource,
        customer_phone: phone,
        customer_whatsapp: whatsapp,
        customer_email: email
      };

      API.addCustomer(customerData).then(newCustomer => {
        customers.push(newCustomer);
        showToast('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        closeAddCustomerModal();
        loadCustomers();
      }).catch(error => {
        showToast('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„');
      });
    }
    window.openAddCustomerModal = openAddCustomerModal;
    window.closeAddCustomerModal = closeAddCustomerModal;
    window.submitAddCustomer = submitAddCustomer;

    // ===== ADD LEAD MODAL LOGIC =====
    function openAddLeadModal() {
      document.getElementById('addLeadModalDedicated').classList.add('show');
      resetAddLeadForm();
      initializeAddLeadDistrictDropdown();
    }
    function closeAddLeadModalDedicated() {
      document.getElementById('addLeadModalDedicated').classList.remove('show');
      resetAddLeadForm();
    }
    function resetAddLeadForm() {
      ['addLeadName', 'addLeadPhone', 'addLeadEmail', 'addLeadDistrict', 'addLeadSource', 'addLeadStatus', 'addLeadNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }
    function initializeAddLeadDistrictDropdown() {
      const districtSelect = document.getElementById('addLeadDistrict');
      if (!districtSelect) return;
      districtSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>' +
        districts.map(district =>
          `<option value="${district.id}">${district.name}</option>`
        ).join('');
    }
    function submitAddLead() {
      const name = document.getElementById('addLeadName').value.trim();
      const phone = document.getElementById('addLeadPhone').value.trim();
      const email = document.getElementById('addLeadEmail').value.trim();
      const comment = document.getElementById('addLeadComment').value.trim();
      const primarySource = document.getElementById('addLeadPrimarySourceOfSale').value;
      const secondarySource = document.getElementById('addLeadSecondarySourceOfSale').value;
      const leadType = document.getElementById('addLeadType').value;

      if (!name || !phone || !primarySource) {
        showToast('error', 'ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      const leadData = {
        lead_name: name,
        lead_type: leadType,
        lead_comment: comment,
        lead_phone: phone,
        lead_email: email,
        primary_source_of_sale: primarySource,
        secondary_source_of_sale: secondarySource
      };

      leads.push(leadData);
      showToast('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      closeAddLeadModalDedicated();
      loadLeads();
    }
    window.openAddLeadModal = openAddLeadModal;
    window.closeAddLeadModalDedicated = closeAddLeadModalDedicated;
    window.submitAddLead = submitAddLead;

    // ===== GLOBAL SOURCES MAP =====
    let sourcesMap = {
      Online: [
        { value: 'Referral', label: 'Ø¥Ø­Ø§Ù„Ø©' },
        { value: 'Facebook', label: 'ÙÙŠØ³Ø¨ÙˆÙƒ' },
        { value: 'Instagram', label: 'Ø¥Ù†Ø³ØªØºØ±Ø§Ù…' },
        { value: 'Google', label: 'Ø¬ÙˆØ¬Ù„' },
        { value: 'Other', label: 'Ø£Ø®Ø±Ù‰' }
      ],
      InStore: [
        { value: 'WalkIn', label: 'Ø²ÙŠØ§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©' },
        { value: 'Referral', label: 'Ø¥Ø­Ø§Ù„Ø©' },
        { value: 'Other', label: 'Ø£Ø®Ø±Ù‰' }
      ],
      Phone: [
        { value: 'Referral', label: 'Ø¥Ø­Ø§Ù„Ø©' },
        { value: 'Ad', label: 'Ø¥Ø¹Ù„Ø§Ù†' },
        { value: 'Other', label: 'Ø£Ø®Ø±Ù‰' }
      ],
      Other: [
        { value: 'Other', label: 'Ø£Ø®Ø±Ù‰' }
      ]
    };
    let primarySources = [
      { value: 'Online', label: 'Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' },
      { value: 'InStore', label: 'Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±' },
      { value: 'Phone', label: 'Ù‡Ø§ØªÙ' },
      { value: 'Other', label: 'Ø£Ø®Ø±Ù‰' }
    ];

    function populateSourceDropdowns(primaryId, secondaryId) {
      const primarySelect = document.getElementById(primaryId);
      const secondarySelect = document.getElementById(secondaryId);
      if (!primarySelect || !secondarySelect) return;
      // Populate primary
      primarySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>' +
        primarySources.map(src => `<option value="${src.value}">${src.label}</option>`).join('');
      // Populate secondary on primary change
      primarySelect.addEventListener('change', function () {
        const selected = primarySelect.value;
        const options = sourcesMap[selected] || [];
        secondarySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>' +
          options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      });
      // Initial clear
      secondarySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙØ±Ø¹ÙŠ</option>';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Customer modal
      populateSourceDropdowns('primarySourceOfSale', 'secondarySourceOfSale');
      // Add customer modal
      populateSourceDropdowns('addCustomerPrimarySourceOfSale', 'addCustomerSecondarySourceOfSale');
      // Add lead modal
      populateSourceDropdowns('addLeadPrimarySourceOfSale', 'addLeadSecondarySourceOfSale');

      // Initialize navigation
      initializeNavigation();
      initializeOrderFilters();

      // Load initial data based on active section
      if (appState.currentSection === 'orders') {
        loadOrders();
      } else if (appState.currentSection === 'customers') {
        loadCustomers();
      } else if (appState.currentSection === 'leads') {
        loadLeads();
      }
    });

    function loadLeads() {
      if (API.getLeads) {
        API.getLeads().then(apiLeads => {
          leads = apiLeads;
          renderLeads();
        }).catch(error => {
          console.error('Failed to load leads from API, falling back to hardcoded leads:', error);
          renderLeads(); // fallback to hardcoded leads
        });
      } else {
        renderLeads(); // fallback if API.getLeads is not defined
      }
    }

    function renderLeads() {
      const grid = document.getElementById('leadsGrid');

      grid.innerHTML = leads.map(lead => {
        return `
          <div class="customer-card">
            <div class="customer-header">
              <div class="customer-info">
                <h3>${lead.lead_name}</h3>
                <p><i class="fas fa-phone"></i> ${lead.lead_phone}</p>
                ${lead.lead_email ? `<p><i class="fas fa-envelope"></i> ${lead.lead_email}</p>` : ''}
                <p><i class="fas fa-tag"></i> ${lead.primary_source_of_sale}${lead.secondary_source_of_sale ? ' - ' + lead.secondary_source_of_sale : ''}</p>
              </div>
            </div>
            ${lead.lead_comment ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); color: var(--gray-600);">
                <i class="fas fa-comment"></i> ${lead.lead_comment}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // 3. Add JS to handle the custom searchable dropdown
    function initializeProductDropdown(row, rowIndex) {
      const dropdown = row.querySelector('.custom-dropdown');
      const box = dropdown.querySelector('.custom-dropdown-box');
      const input = dropdown.querySelector('.custom-dropdown-input');
      const chevron = dropdown.querySelector('.custom-dropdown-chevron');
      const list = dropdown.querySelector('.custom-dropdown-list');

      let isOpen = false;
      let selectedIndex = -1;
      let filteredProducts = products;

      function renderList(term = '') {
        filteredProducts = products.filter(p =>
          p.name.toLowerCase().includes(term.toLowerCase())
        );
        if (filteredProducts.length === 0) {
          list.innerHTML = '<div class="custom-dropdown-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        } else {
          list.innerHTML = filteredProducts.map((product, idx) => {
            let highlighted;
            if (term && term.trim() !== '') {
              highlighted = product.name.replace(
                new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
                '<mark>$1</mark>'
              );
            } else {
              highlighted = product.name;
            }
            return `<div class="custom-dropdown-item${idx === selectedIndex ? ' selected' : ''}" data-id="${product.id}" data-price="${product.price}" data-idx="${idx}" style="direction: rtl; text-align: right;">${highlighted} <span style='color:#888;font-size:0.95em;'>${formatCurrency(product.price)}</span></div>`;
          }).join('');
        }
      }

      function openDropdown() {
        isOpen = true;
        box.classList.add('active');
        list.classList.add('show');
        chevron.classList.add('active');
        input.removeAttribute('readonly');
        renderList(input.value);
      }
      function closeDropdown() {
        isOpen = false;
        box.classList.remove('active');
        list.classList.remove('show');
        chevron.classList.remove('active');
        selectedIndex = -1;
        input.setAttribute('readonly', 'readonly');
      }

      box.addEventListener('click', function(e) {
        if (isOpen) {
          closeDropdown();
        } else {
          openDropdown();
          input.focus();
          input.select();
        }
      });
      input.addEventListener('focus', function() {
        openDropdown();
        input.select();
      });
      input.addEventListener('input', function() {
        renderList(input.value);
        selectedIndex = -1;
        if (!isOpen) openDropdown();
      });
      input.addEventListener('keydown', function(e) {
        if (!isOpen) return;
        if (e.key === 'ArrowDown') {
          selectedIndex = Math.min(selectedIndex + 1, filteredProducts.length - 1);
          renderList(input.value);
          e.preventDefault();
        } else if (e.key === 'ArrowUp') {
          selectedIndex = Math.max(selectedIndex - 1, 0);
          renderList(input.value);
          e.preventDefault();
        } else if (e.key === 'Enter') {
          if (selectedIndex >= 0 && filteredProducts[selectedIndex]) {
            selectProduct(filteredProducts[selectedIndex]);
            closeDropdown();
          }
          e.preventDefault();
        } else if (e.key === 'Escape') {
          closeDropdown();
          e.preventDefault();
        }
      });
      list.addEventListener('mousedown', function(e) {
        const item = e.target.closest('.custom-dropdown-item[data-id]');
        if (item) {
          const product = products.find(p => p.id === item.dataset.id);
          selectProduct(product);
          closeDropdown();
        }
      });
      // Use blur to close dropdown only when focus leaves input and dropdown
      input.addEventListener('blur', function(e) {
        setTimeout(closeDropdown, 150);
      });
      // Prevent closing when clicking inside the dropdown list
      list.addEventListener('mousedown', function(e) {
        e.preventDefault();
      });

      function selectProduct(product) {
        input.value = product.name;
        input.setAttribute('data-id', product.id);
        input.setAttribute('data-price', product.price);
        // Update the order item in appState
        appState.newOrderForm.items[rowIndex].productId = product.id;
        appState.newOrderForm.items[rowIndex].productName = product.name;
        appState.newOrderForm.items[rowIndex].price = product.price;
        // Update price display
        const priceDisplay = row.querySelector('.price-display');
        if (priceDisplay) priceDisplay.textContent = formatCurrency(product.price);
        // Optionally, trigger updateOrderItem
        updateOrderItem(rowIndex);
        closeDropdown(); // Always close after selection
      }

      // Initial render
      renderList();
      input.setAttribute('readonly', 'readonly');
    }
  </script>
</body>

</html>