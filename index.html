<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AFI CRM - إدارة العملاء والطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #6161ff;
      --primary-dark: #4545d4;
      --primary-light: #7e7eff;
      --success: #00c875;
      --success-light: #00d084;
      --warning: #ffcb00;
      --warning-light: #ffd533;
      --danger: #e2445c;
      --danger-light: #ff6b7d;
      --info: #0086c0;
      --info-light: #00a8f0;
      --purple: #a25ddc;
      --purple-light: #b56eef;

      /* Status Colors */
      --status-pending: #fdab3d;
      --status-pending-bg: #fef4e6;
      --status-in-progress: #007fff;
      --status-in-progress-bg: #e6f4ff;
      --status-ready: #9747ff;
      --status-ready-bg: #f3e6ff;
      --status-delivery: #ff6b35;
      --status-delivery-bg: #fff0e6;
      --status-delivered: #00c875;
      --status-delivered-bg: #e6f9f0;

      /* Modern Grays */
      --gray-25: #fcfcfc;
      --gray-50: #f8f9fa;
      --gray-75: #f1f3f4;
      --gray-100: #e8eaed;
      --gray-200: #dadce0;
      --gray-300: #c4c7c5;
      --gray-400: #9aa0a6;
      --gray-500: #5f6368;
      --gray-600: #3c4043;
      --gray-700: #202124;
      --gray-800: #171717;
      --gray-900: #0a0a0a;

      /* Modern Styling */
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 16px;
      --border-radius-pill: 50px;

      /* Modern Shadows */
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.03);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
      --shadow-md: 0 6px 16px -6px rgb(0 0 0 / 0.12), 0 0 0 1px rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 24px -8px rgb(0 0 0 / 0.15), 0 0 0 1px rgb(0 0 0 / 0.05);
      --shadow-xl: 0 20px 40px -12px rgb(0 0 0 / 0.20), 0 0 0 1px rgb(0 0 0 / 0.05);

      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.2);

      /* Transitions */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, var(--gray-25) 0%, var(--gray-75) 100%);
      color: var(--gray-700);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(97, 97, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
      backdrop-filter: blur(10px);
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      text-align: center;
      color: white;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 3rem;
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .loading-spinner {
      width: 64px;
      height: 64px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    .loading-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loading-message {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 2rem;
      left: 2rem;
      z-index: 9998;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toast {
      background: white;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 1rem 1.5rem;
      min-width: 320px;
      max-width: 500px;
      transform: translateX(-120%);
      transition: var(--transition);
      border: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: var(--success);
      border-left: 4px solid var(--success);
    }

    .toast.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: var(--danger);
      border-left: 4px solid var(--danger);
    }

    .toast-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      color: var(--gray-700);
    }

    .toast-close {
      background: var(--gray-100);
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      background: var(--gray-200);
      color: var(--gray-700);
      transform: scale(1.05);
    }

    /* ===== MAIN LAYOUT ===== */
    .app-container {
      min-height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--border-radius-xl);
      padding: 2.5rem 3rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-xl);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
      pointer-events: none;
    }

    .header-content h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    .header-content p {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    /* ===== NAVIGATION ===== */
    .main-nav {
      background: var(--glass-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
      overflow: hidden;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .nav-tabs {
      display: flex;
      padding: 0.5rem;
      gap: 0.25rem;
    }

    .nav-tab {
      flex: 1;
      padding: 1rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--gray-500);
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      border-radius: var(--border-radius);
      position: relative;
    }

    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.6);
      color: var(--gray-700);
      transform: translateY(-1px);
    }

    .nav-tab.active {
      color: var(--primary);
      background: white;
      box-shadow: var(--shadow-sm);
      font-weight: 600;
    }

    .nav-tab.active::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--primary);
      border-radius: var(--border-radius-pill);
    }

    /* ===== CONTENT SECTIONS ===== */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* ===== CARDS ===== */
    .card {
      background: var(--glass-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .card-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--gray-200);
      background: rgba(255, 255, 255, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-content {
      padding: 2rem;
      background: rgba(255, 255, 255, 0.3);
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* ===== ORDER FILTERS ===== */
    .order-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--gray-200);
      background: var(--glass-bg);
      border-radius: var(--border-radius-pill);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .filter-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .filter-btn:hover::before {
      opacity: 1;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
    }

    .filter-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .filter-btn .badge {
      background: rgba(255, 255, 255, 0.9);
      color: var(--gray-700);
      padding: 0.25rem 0.6rem;
      border-radius: var(--border-radius-pill);
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .filter-btn.active .badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* ===== ORDERS TABLE ===== */
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: transparent;
      margin: 0;
      border-spacing: 0;
    }

    /* Define specific column widths for the main orders table */
    .orders-table th:nth-child(1),
    .orders-table td:nth-child(1) {
      width: 15%;
      /* رقم الطلب */
    }

    .orders-table th:nth-child(2),
    .orders-table td:nth-child(2) {
      width: 25%;
      /* العميل */
    }

    .orders-table th:nth-child(3),
    .orders-table td:nth-child(3) {
      width: 15%;
      /* التاريخ */
    }

    .orders-table th:nth-child(4),
    .orders-table td:nth-child(4) {
      width: 15%;
      /* المبلغ */
    }

    .orders-table th:nth-child(5),
    .orders-table td:nth-child(5) {
      width: 30%;
      /* الحالة */
    }

    .orders-table th,
    .orders-table td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
      text-align: right;
      box-sizing: border-box;
    }

    .orders-table th {
      background: linear-gradient(135deg, white 0%, var(--gray-100) 100%);
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
      text-align: right;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .orders-table td {
      text-align: right;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
    }

    .orders-table tbody tr {
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--border-radius);
    }

    .orders-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .order-row.expanded {
      background: rgba(97, 97, 255, 0.1);
      box-shadow: var(--shadow-sm);
    }

    .order-details-row {
      display: none;
    }

    .order-details-row.show {
      display: table-row;
    }

    .order-details-content {
      padding: 2rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
      border-radius: var(--border-radius-lg);
      margin: 1rem 0;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Fix for table container */
    .card-content {
      padding: 0;
      background: rgba(255, 255, 255, 0.3);
      overflow-x: auto;
    }

    .orders-table-container {
      width: 100%;
      min-width: 100%;
      overflow-x: auto;
    }

    /* Ensure order details row spans full width */
    .order-details-row td {
      width: 100% !important;
      padding: 1rem !important;
      box-sizing: border-box;
    }

    .order-details-content {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* ===== MODERN STATUS CHIPS ===== */
    .status-select {
      appearance: none;
      background: transparent;
      border: none;
      padding: 0.6rem 2.5rem 0.6rem 1.2rem;
      border-radius: var(--border-radius-pill);
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      color: white;
      min-width: 150px;
      position: relative;
      text-align: center;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* Status Chip Colors */
    .status-pending {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%);
      box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4);
    }

    .status-pending::before {
      content: '⏳';
      margin-left: 0.5rem;
    }

    .status-in-progress {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%);
      box-shadow: 0 4px 15px rgba(55, 66, 250, 0.4);
    }

    .status-in-progress::before {
      content: '⚡';
      margin-left: 0.5rem;
    }

    .status-ready-for-shipment {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%);
      box-shadow: 0 4px 15px rgba(165, 94, 234, 0.4);
    }

    .status-ready-for-shipment::before {
      content: '📦';
      margin-left: 0.5rem;
    }

    .status-out-for-delivery {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
      box-shadow: 0 4px 15px rgba(253, 121, 168, 0.4);
    }

    .status-out-for-delivery::before {
      content: '🚚';
      margin-left: 0.5rem;
    }

    .status-delivered {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
    }

    .status-delivered::before {
      content: '✅';
      margin-left: 0.5rem;
    }

    .status-select:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .status-select:focus {
      outline: none;
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .status-select:active {
      transform: translateY(0) scale(0.98);
    }

    /* Custom dropdown arrow with modern styling */
    .status-select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: left calc(100% - 0.75rem) center;
      background-repeat: no-repeat;
      background-size: 16px 16px;
    }

    /* CHIP-STYLE DROPDOWN OPTIONS */
    .status-select option {
      background: white !important;
      color: var(--gray-700) !important;
      padding: 0.75rem 1rem !important;
      margin: 0.25rem !important;
      border-radius: var(--border-radius-pill) !important;
      font-weight: 600 !important;
      font-size: 0.85rem !important;
      border: 2px solid transparent !important;
      transition: var(--transition) !important;
    }

    .status-select option:hover {
      transform: scale(1.02) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    /* Individual option colors */
    .status-select option[value="pending"] {
      background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%) !important;
      color: #e67e22 !important;
      border-color: rgba(255, 159, 67, 0.3) !important;
    }

    .status-select option[value="pending"]::before {
      content: '⏳ ';
    }

    .status-select option[value="pending"]:hover {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%) !important;
      color: white !important;
    }

    .status-select option[value="in-progress"] {
      background: linear-gradient(135deg, #e8eaff 0%, #d4d7ff 100%) !important;
      color: #3742fa !important;
      border-color: rgba(55, 66, 250, 0.3) !important;
    }

    .status-select option[value="in-progress"]::before {
      content: '⚡ ';
    }

    .status-select option[value="in-progress"]:hover {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%) !important;
      color: white !important;
    }

    .status-select option[value="ready-for-shipment"] {
      background: linear-gradient(135deg, #f3eaff 0%, #e8d5ff 100%) !important;
      color: #a55eea !important;
      border-color: rgba(165, 94, 234, 0.3) !important;
    }

    .status-select option[value="ready-for-shipment"]::before {
      content: '📦 ';
    }

    .status-select option[value="ready-for-shipment"]:hover {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%) !important;
      color: white !important;
    }

    .status-select option[value="out-for-delivery"] {
      background: linear-gradient(135deg, #ffe8f0 0%, #ffd1e1 100%) !important;
      color: #e84393 !important;
      border-color: rgba(253, 121, 168, 0.3) !important;
    }

    .status-select option[value="out-for-delivery"]::before {
      content: '🚚 ';
    }

    .status-select option[value="out-for-delivery"]:hover {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%) !important;
      color: white !important;
    }

    .status-select option[value="delivered"] {
      background: linear-gradient(135deg, #e6f9f6 0%, #ccf2ec 100%) !important;
      color: #00b894 !important;
      border-color: rgba(0, 184, 148, 0.3) !important;
    }

    .status-select option[value="delivered"]::before {
      content: '✅ ';
    }

    .status-select option[value="delivered"]:hover {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%) !important;
      color: white !important;
    }

    /* Enhanced dropdown styling */
    .status-select:focus option {
      background: white;
      border-radius: var(--border-radius-pill);
      margin: 0.2rem 0.5rem;
      padding: 0.5rem 1rem;
    }

    /* Status Badge Styles for Filter Buttons - Enhanced */
    .filter-btn[data-filter="pending"] .badge {
      background: linear-gradient(135deg, #ff9f43 0%, #ff6b35 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(255, 159, 67, 0.3);
    }

    .filter-btn[data-filter="in-progress"] .badge {
      background: linear-gradient(135deg, #3742fa 0%, #2f3542 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(55, 66, 250, 0.3);
    }

    .filter-btn[data-filter="ready-for-shipment"] .badge {
      background: linear-gradient(135deg, #a55eea 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(165, 94, 234, 0.3);
    }

    .filter-btn[data-filter="out-for-delivery"] .badge {
      background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(253, 121, 168, 0.3);
    }

    .filter-btn[data-filter="delivered"] .badge {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
    }

    .filter-btn[data-filter="all"] .badge {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(97, 97, 255, 0.3);
    }

    /* Enhanced filter button badges */
    .filter-btn .badge {
      border-radius: var(--border-radius-pill);
      padding: 0.3rem 0.7rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
      transition: var(--transition);
    }

    /* Override active filter button badge colors */
    .filter-btn.active .badge {
      background: rgba(255, 255, 255, 0.25) !important;
      color: white !important;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }

    /* Pulse animation for active status */
    .status-select {
      animation: none;
    }

    .status-select:focus {
      animation: statusPulse 2s infinite;
    }

    @keyframes statusPulse {
      0% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      50% {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      100% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
    }

    /* ===== ORDER ITEMS TABLE (inside details) - SEPARATE STYLING ===== */
    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      table-layout: auto;
      /* Different from main table */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Specific column widths for items table - More Even Distribution */
    .order-items-table th.order-items-table-product,
    .order-items-table td.order-items-table-product {
      width: 20%;
      /* المنتج */
      text-align: right;
    }

    .order-items-table th.order-items-table-quantity,
    .order-items-table td.order-items-table-quantity {
      width: 13%;
      /* الكمية */
      text-align: center;
    }

    .order-items-table th.order-items-table-unit,
    .order-items-table td.order-items-table-unit {
      width: 13%;
      /* الوحدة */
      text-align: center;
    }

    .order-items-table th.order-items-table-price,
    .order-items-table td.order-items-table-price {
      width: 17%;
      /* السعر */
      text-align: center;
    }

    .order-items-table th.order-items-table-total,
    .order-items-table td.order-items-table-total {
      width: 17%;
      /* الإجمالي */
      text-align: center;
    }

    .order-items-table th.order-items-table-notes,
    .order-items-table td.order-items-table-notes {
      width: 20%;
      /* ملاحظات */
      text-align: right;
    }

    .order-items-table th {
      background: linear-gradient(135deg, var(--gray-75) 0%, var(--gray-100) 100%);
      padding: 0.875rem 0.75rem;
      text-align: center;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.875rem;
      border-bottom: 2px solid var(--gray-200);
      white-space: nowrap;
    }

    .order-items-table th:first-child,
    .order-items-table th:last-child {
      text-align: right;
    }

    .order-items-table td {
      padding: 0.875rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.6);
      vertical-align: middle;
      text-align: center;
    }

    .order-items-table td:first-child,
    .order-items-table td:last-child {
      text-align: right;
    }

    .order-items-table tbody tr:last-child td {
      border-bottom: none;
    }

    .order-items-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    /* Footer styling for items table */
    .order-items-table tfoot tr {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%) !important;
      color: white !important;
    }

    .order-items-table tfoot td {
      background: none !important;
      color: white !important;
      font-weight: 600;
      border-bottom: none;
      padding: 1rem 0.75rem;
    }

    .order-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .summary-item {
      background: var(--glass-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius-lg);
      text-align: center;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: var(--transition);
    }

    .summary-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .summary-label {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .summary-label i {
      font-size: 1rem;
    }

    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-700);
    }

    .summary-value.address-details {
      font-size: 0.9rem;
      line-height: 1.4;
      text-align: center;
      max-width: 100%;
      word-wrap: break-word;
    }

    .expand-icon {
      transition: transform 0.3s ease;
    }

    .expand-icon.rotated {
      transform: rotate(180deg);
    }

    /* ===== ITEMS TABLE (for forms) - SEPARATE STYLING ===== */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      table-layout: auto;
      background: white;
    }

    .items-table th {
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
      padding: 0.875rem 0.75rem;
      text-align: center;
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .items-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
      text-align: center;
    }

    .items-table tbody tr:hover {
      background: var(--gray-50);
    }

    .items-table input,
    .items-table select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .add-item-btn {
      width: 100%;
      background: var(--gray-50);
      color: var(--primary);
      border: 2px dashed var(--gray-300);
      padding: 1rem;
    }

    .add-item-btn:hover {
      background: rgba(97, 97, 255, 0.05);
      border-color: var(--primary);
    }

    /* ===== ADDRESS SELECTION ===== */
    .address-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .address-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .address-card:hover {
      border-color: var(--primary-light);
      background: rgba(37, 99, 235, 0.02);
    }

    .address-card.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .address-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.75rem;
    }

    .address-details {
      color: var(--gray-600);
      line-height: 1.5;
    }

    .section-divider {
      margin: 2rem 0;
      padding-top: 2rem;
      border-top: 2px solid var(--gray-100);
    }

    .form-section {
      display: none;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--gray-200);
    }

    .form-section.show {
      display: block;
    }

    /* ===== CUSTOMER GRID ===== */
    .customers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .customer-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
    }

    .customer-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .customer-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .customer-info h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.25rem;
    }

    .customer-info p {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    .customer-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-200);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray-500);
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      max-width: 900px;
      width: 90%;
      max-height: 96vh;
      min-height: 650px;
      overflow-y: auto;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 2rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-400);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .modal-content {
      padding: 2rem;
    }

    /* ===== FORMS ===== */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 0.875rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      color: var(--gray-900);
      font-family: 'Cairo', sans-serif;
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      font-family: 'Cairo', sans-serif;
      color: var(--gray-400);
      font-size: 0.95rem;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-input.error,
    .form-select.error {
      border-color: var(--danger);
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* ===== CUSTOMER SEARCH ===== */
    .customer-search {
      position: relative;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 1rem 3rem 1rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 1.1rem;
      transition: var(--transition);
      font-family: 'Cairo', sans-serif;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.1rem;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--gray-200);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .search-results.show {
      display: block;
    }

    .search-result {
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--gray-100);
    }

    .search-result:hover {
      background: var(--gray-50);
    }

    .search-result:last-child {
      border-bottom: none;
    }

    .new-customer-option {
      background: var(--gray-100);
      color: var(--primary);
      border-top: 2px solid var(--gray-200);
      font-weight: 500;
    }

    .new-customer-option:hover {
      background: var(--gray-200);
      color: var(--primary-dark);
    }

    /* ===== VALIDATION ERROR STYLES ===== */

    /* Base error class for form inputs */
    .form-input.error,
    .form-select.error,
    .form-textarea.error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
      animation: shake 0.3s ease-in-out !important;
    }

    /* Custom dropdown error styling */
    .custom-dropdown-box.error,
    .custom-dropdown-input.error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
    }

    /* Error shake animation */
    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    /* Focus state for error fields */
    .form-input.error:focus,
    .form-select.error:focus,
    .form-textarea.error:focus {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 4px rgba(226, 68, 92, 0.15) !important;
      outline: none !important;
    }

    /* Error state for different input types */
    input.error,
    select.error,
    textarea.error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
    }

    /* Custom dropdown wrapper error state */
    .custom-dropdown.error .custom-dropdown-box {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
    }

    /* Error label styling */
    .form-label.error {
      color: #e2445c !important;
      font-weight: 600 !important;
    }

    /* Pulsing effect for severe errors */
    .error.pulse {
      animation: errorPulse 1s infinite alternate !important;
    }

    @keyframes errorPulse {
      0% {
        box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1);
      }

      100% {
        box-shadow: 0 0 0 6px rgba(226, 68, 92, 0.2);
      }
    }

    /* Error message tooltip */
    .field-error-tooltip {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2445c;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
      z-index: 1000;
      margin-top: 0.25rem;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.2s ease;
      pointer-events: none;
    }

    .field-error-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }

    .field-error-tooltip::before {
      content: '';
      position: absolute;
      top: -5px;
      left: 1rem;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 5px 5px 5px;
      border-color: transparent transparent #e2445c transparent;
    }

    /* Form group error state */
    .form-group.error {
      position: relative;
    }

    .form-group.error .form-label {
      color: #e2445c !important;
    }

    /* Override any conflicting styles */
    .error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
    }

    /* High specificity overrides for stubborn styles */
    div .form-input.error,
    div .form-select.error,
    div .form-textarea.error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
    }

    /* Ensure error styles work in modals */
    .modal .form-input.error,
    .modal .form-select.error,
    .modal .form-textarea.error {
      border-color: #e2445c !important;
      box-shadow: 0 0 0 3px rgba(226, 68, 92, 0.1) !important;
      background-color: rgba(226, 68, 92, 0.05) !important;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .app-container {
        padding: 1rem;
      }

      .app-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .header-content h1 {
        font-size: 2rem;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .order-filters {
        flex-direction: column;
      }

      .customers-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .toast-container {
        left: 1rem;
        right: 1rem;
      }

      .toast {
        min-width: auto;
      }

      .orders-table {
        width: 100%;
        font-size: 0.9rem;
      }

      .orders-table th,
      .orders-table td {
        padding: 0.75rem 0.5rem;
      }

      /* Adjust column widths for mobile */
      .orders-table th:nth-child(1),
      .orders-table td:nth-child(1) {
        width: 20%;
        /* رقم الطلب */
      }

      .orders-table th:nth-child(2),
      .orders-table td:nth-child(2) {
        width: 30%;
        /* العميل */
      }

      .orders-table th:nth-child(3),
      .orders-table td:nth-child(3) {
        width: 20%;
        /* التاريخ */
      }

      .orders-table th:nth-child(4),
      .orders-table td:nth-child(4) {
        width: 15%;
        /* المبلغ */
      }

      .orders-table th:nth-child(5),
      .orders-table td:nth-child(5) {
        width: 15%;
        /* الحالة */
      }
    }

    /* ===== UTILITY CLASSES ===== */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-2 {
      margin-bottom: 1rem;
    }

    .mt-2 {
      margin-top: 1rem;
    }

    .order-details-row td {
      width: 100%;
      padding: 0;
    }

    .order-details-content {
      width: 100%;
    }

    /* ===== CUSTOM SEARCHABLE DROPDOWN ===== */
    .custom-dropdown {
      position: relative;
      width: 100%;
      font-family: inherit;
      overflow: visible;
    }
    .custom-dropdown-box {
      display: flex;
      align-items: center;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      background: white;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      cursor: pointer;
      min-height: 40px;
      position: relative;
      transition: border-color 0.2s;
    }
    .custom-dropdown-box:focus-within, .custom-dropdown-box.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(97, 97, 255, 0.08);
    }
    .custom-dropdown-input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 1rem;
      background: transparent;
      color: var(--gray-900);
      padding: 0;
      font-family: 'Cairo', sans-serif;
    }
    .custom-dropdown-chevron {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%) rotate(0deg);
      color: #aaa;
      font-size: 1.2em;
      pointer-events: none;
      transition: transform 0.2s;
    }
    .custom-dropdown-box.active .custom-dropdown-chevron {
      transform: translateY(-50%) rotate(180deg);
    }
    .custom-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: var(--shadow-lg);
      max-height: 220px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      direction: rtl;
    }
    .custom-dropdown-list.show {
      display: block;
    }
    .custom-dropdown-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 1rem;
      color: var(--gray-900);
      display: block;
      text-align: right;
      direction: rtl;
      font-family: 'Cairo', sans-serif;
    }
    .custom-dropdown-item.selected, .custom-dropdown-item:hover {
      background: var(--gray-50);
      color: var(--primary);
    }
    .custom-dropdown-item mark {
      background: #fef3c7;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .items-table,
    .items-table tbody,
    .items-table tr {
      overflow: visible !important;
    }

    .customer-details-box {
      /* Remove transition */
    }

    .customer-details-box.show {
      display: block;
      /* Remove animation */
    }

    /* Remove the slideDown animation since it's no longer needed */

    /* Empty State Styles */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
      border-radius: var(--border-radius-lg);
      margin: 2rem auto;
      max-width: 500px;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    .empty-state h3 {
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }

    .empty-state p {
      color: var(--gray-500);
      margin-bottom: 1.5rem;
      font-size: 1rem;
      line-height: 1.5;
    }

    .empty-state .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .empty-state .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Center empty state in grid and table containers */
    .customers-grid > .empty-state,
    .leads-grid > .empty-state {
      grid-column: 1 / -1;
      justify-self: center;
    }
    .orders-table-container .empty-state {
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-title">AFI CRM</div>
      <div class="loading-message" id="loadingMessage">جاري تحميل البيانات...</div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Main Application -->
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="header-content">
        <h1>
          <i class="fas fa-chart-line"></i>
          AFI CRM
        </h1>
        <p>نظام إدارة علاقات العملاء والطلبات</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-success" onclick="openNewOrderModal()">
          <i class="fas fa-plus"></i>
          طلب جديد
        </button>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
      <div class="nav-tabs">
        <button class="nav-tab active" data-section="orders">
          <i class="fas fa-shopping-cart"></i>
          الطلبات
        </button>
        <button class="nav-tab" data-section="customers">
          <i class="fas fa-users"></i>
          العملاء
        </button>
        <button class="nav-tab" data-section="leads">
          <i class="fas fa-user-plus"></i>
          العملاء المحتملين
        </button>
      </div>
    </nav>

    <!-- Orders Section -->
    <div class="content-section active" id="orders">
      <!-- Order Filters -->
      <div class="order-filters">
        <button class="filter-btn active" data-filter="all">
          <span>جميع الطلبات</span>
          <span class="badge" id="allCount">0</span>
        </button>
        <button class="filter-btn" data-filter="pending">
          <span>في الانتظار</span>
          <span class="badge" id="pendingCount">0</span>
        </button>
        <button class="filter-btn" data-filter="in-progress">
          <span>قيد التحضير</span>
          <span class="badge" id="inProgressCount">0</span>
        </button>
        <button class="filter-btn" data-filter="ready-for-shipment">
          <span>جاهز للشحن</span>
          <span class="badge" id="readyForShipmentCount">0</span>
        </button>
        <button class="filter-btn" data-filter="out-for-delivery">
          <span>في التوصيل</span>
          <span class="badge" id="outForDeliveryCount">0</span>
        </button>
        <button class="filter-btn" data-filter="delivered">
          <span>تم التوصيل</span>
          <span class="badge" id="deliveredCount">0</span>
        </button>
      </div>

      <!-- Orders Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-list"></i>
            قائمة الطلبات
          </h2>
        </div>
        <div class="card-content">
          <div class="orders-table-container">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>رقم الطلب</th>
                  <th>العميل</th>
                  <th>التاريخ</th>
                  <th>المبلغ</th>
                  <th>الحالة</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Customers Section -->
    <div class="content-section" id="customers">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-users"></i>
            قائمة العملاء
          </h2>
          <button class="btn btn-primary" onclick="openAddCustomerModal()">
            <i class="fas fa-user-plus"></i>
            إضافة عميل
          </button>
        </div>
        <div class="card-content">
          <div class="customers-grid" id="customersGrid">
          </div>
        </div>
      </div>
    </div>

    <!-- Leads Section -->
    <div class="content-section" id="leads">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-user-plus"></i>
            العملاء المحتملين (Leads)
          </h2>
          <button class="btn btn-success" onclick="openAddLeadModal()">
            <i class="fas fa-plus"></i>
            إضافة عميل محتمل
          </button>
        </div>
        <div class="card-content">
          <div class="leads-grid" id="leadsGrid">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Order Modal -->
  <div class="modal-overlay" id="newOrderModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-plus"></i>
          طلب جديد
        </h2>
        <button class="modal-close" onclick="closeNewOrderModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">

        <!-- Customer Search Section -->
        <div class="customer-search">
          <label class="form-label">البحث عن عميل</label>
          <div style="display: flex; align-items: center; gap: 0.5rem; width:100%;">
            <div id="customerInputWrap" style="position:relative; flex:1;">
              <input type="text" class="search-input" id="customerSearch"
                placeholder="ابحث عن عميل موجود بالاسم أو رقم الهاتف..." autocomplete="off" style="width:100%; height: 44px; font-size: 1.1rem;">
              <div class="search-results" id="searchResults" style="position:absolute; top:100%; left:0; right:0; width:100%; min-width:0;"></div>
              <i class="fas fa-search search-icon"></i>
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="addCustomerUnderSearchBtn" style="flex:0 0 auto; height:44px; padding:0 1rem; margin:0; display:flex; align-items:center; justify-content:center; font-size:1.1rem;" onclick="showNewCustomerForm()">
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
          <!-- Add customer details box -->
          <div id="selectedCustomerDetails" class="customer-details-box" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius); border: 1px solid var(--gray-200);">
            <div class="customer-details-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <h4 style="margin: 0; font-size: 1.1rem; color: var(--gray-800);" id="selectedCustomerName"></h4>
              <button type="button" class="btn btn-sm btn-text" onclick="clearSelectedCustomer()" style="padding: 0.25rem 0.5rem;">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="customer-details-content" style="color: var(--gray-600); font-size: 0.9rem;">
              <p style="margin: 0.25rem 0;"><i class="fas fa-phone"></i> <span id="selectedCustomerPhone"></span></p>
              <p style="margin: 0.25rem 0;"><i class="fas fa-map-marker-alt"></i> <span id="selectedCustomerAddress"></span></p>
              <p style="margin: 0.25rem 0;"><i class="fas fa-shopping-cart"></i> <span id="selectedCustomerOrders"></span></p>
            </div>
          </div>
        </div>

        <!-- Address Selection Section (shows when existing customer is selected) -->
        <div class="form-section" id="addressSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-map-marker-alt"></i>
            اختر العنوان للتوصيل
          </h3>
          <div class="address-grid" id="addressGrid"></div>
          <button type="button" class="btn btn-primary mb-2" onclick="showNewAddressForm()">
            <i class="fas fa-plus"></i>
            إضافة عنوان جديد
          </button>
        </div>

        <!-- NEW ORDER MODAL - Customer Details Section -->
        <div class="form-section" id="customerDetailsSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-user-plus"></i>
            بيانات العميل الجديد
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">اسم العميل *</label>
              <input type="text" class="form-input" id="customerName" required data-label="اسم العميل">
            </div>
            <div class="form-group">
              <label class="form-label">رقم الهاتف *</label>
              <input type="tel" class="form-input" id="customerPhone" required data-label="رقم الهاتف">
            </div>
            <div class="form-group">
              <label class="form-label">نوع *</label>
              <select class="form-select" id="customerGender" required data-label="نوع">
                <option value="">اختر النوع</option>
                <option value="male">ذكر</option>
                <option value="female">أنثى</option>
                <option value="other">آخر</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">واتساب</label>
              <input type="tel" class="form-input" id="customerWhatsapp" data-label="واتساب">
            </div>
            <div class="form-group">
              <label class="form-label">البريد الإلكتروني</label>
              <input type="email" class="form-input" id="customerEmail" data-label="البريد الإلكتروني">
            </div>
            <div class="form-group">
              <label class="form-label">ملاحظات/تعليق</label>
              <textarea class="form-textarea" id="customerComment" data-label="ملاحظات"
                placeholder="أضف أي ملاحظات عن العميل..."></textarea>
            </div>
            <input type="hidden" id="customerType" value="customer">
            <div class="form-group">
              <label class="form-label">مصدر العميل *</label>
              <select class="form-select" id="primarySourceOfSale" required data-label="مصدر الطلب"></select>
            </div>
            <div class="form-group">
              <label class="form-label">المصدر الفرعي</label>
              <select class="form-select" id="secondarySourceOfSale" data-label="المصدر الفرعي"></select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <button type="button" class="btn btn-primary" onclick="submitNewCustomer()">
                <i class="fas fa-check"></i>
                إضافة العميل
              </button>
            </div>
          </div>
        </div>

        <!-- NEW ADDRESS SECTION -->
        <div class="form-section" id="newAddressSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-map-marker-alt"></i>
            إضافة عنوان جديد
          </h3>
          <div class="form-grid">
            <!-- Address Label -->
            <div class="form-group">
              <label class="form-label">تسمية العنوان</label>
              <select class="form-select" id="newAddressLabel">
                <option value="Home" data-icon="fa-home">🏠 المنزل</option>
                <option value="Work" data-icon="fa-building">🏢 العمل</option>
                <option value="Family" data-icon="fa-users">👪 العائلة</option>
                <option value="Friend" data-icon="fa-handshake">🤝 صديق</option>
                <option value="Warehouse" data-icon="fa-warehouse">🏬 مستودع</option>
                <option value="Chalet" data-icon="fa-umbrella-beach">🏖️ شاليه</option>
                <option value="Farm" data-icon="fa-tractor">🌾 مزرعة</option>
                <option value="Shop" data-icon="fa-store">🛒 متجر</option>
                <option value="Other" data-icon="fa-map-marker-alt">📍 أخرى</option>
              </select>
            </div>
            <!-- Building Number -->
            <div class="form-group">
              <label class="form-label">رقم المنزل</label>
              <input type="text" class="form-input" id="newHouseNumber">
            </div>
            <!-- Flat Number -->
            <div class="form-group">
              <label class="form-label">رقم الشقة</label>
              <input type="text" class="form-input" id="newFlatNumber">
            </div>
            <!-- Floor Number -->
            <div class="form-group">
              <label class="form-label">رقم الدور</label>
              <input type="text" class="form-input" id="newFloorNumber">
            </div>
            <!-- Street Name -->
            <div class="form-group">
              <label class="form-label">اسم الشارع *</label>
              <input type="text" class="form-input" id="newStreetName" required data-label="اسم الشارع">
            </div>
            <!-- District (searchable) -->
            <div class="form-group" style="position:relative;">
              <label class="form-label">المنطقة *</label>
              <input type="text" class="form-input" id="newAddressDistrictSearch" placeholder="ابحث عن المنطقة..."
                autocomplete="off" required data-label="المنطقة" style="padding-left: 2.5rem; padding-right: 1rem;">
              <i class="fas fa-chevron-down" id="districtChevron"
                style="position:absolute; left:1.25rem; top:50%; transform:translateY(-50%); color:#aaa; font-size:1.2em; pointer-events:none; line-height:1;"></i>
              <div class="search-results" id="districtSearchResults"></div>
              <input type="hidden" id="newAddressDistrict">
              <input type="hidden" id="newAddressGovernorate">
              <input type="hidden" id="newDistrictId" required data-label="المنطقة">
            </div>
            <!-- Landmark -->
            <div class="form-group">
              <label class="form-label">علامة مميزة</label>
              <input type="text" class="form-input" id="newAddressMarking">
            </div>
            <!-- Comment -->
            <div class="form-group">
              <label class="form-label">ملاحظات/تعليق</label>
              <textarea class="form-textarea" id="newAddressComment"
                placeholder="أضف أي ملاحظات عن العنوان..."></textarea>
            </div>
          </div>
          <!-- Save/Cancel Buttons for Address -->
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
            <button type="button" class="btn btn-success" onclick="saveNewAddress()">
              <i class="fas fa-save"></i>
              حفظ العنوان
            </button>
            <button type="button" class="btn btn-primary" onclick="cancelNewAddress()">
              <i class="fas fa-times"></i>
              إلغاء
            </button>
          </div>
        </div>

        <!-- Order Details Section (always visible once customer/address is set) -->
        <div class="form-section" id="orderDetailsSection">
          <h3 class="card-title mb-2">
            <i class="fas fa-shopping-cart"></i>
            تفاصيل الطلب
          </h3>
          <!-- Source Dropdowns -->
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">مصدر الطلب *</label>
              <select class="form-select" id="orderSource" required data-label="مصدر الطلب"></select>
            </div>
            <div class="form-group">
              <label class="form-label">المصدر الفرعي</label>
              <select class="form-select" id="orderSecondarySource" data-label="المصدر الفرعي"></select>
            </div>
          </div>

          <!-- Order Comments -->
          <div class="form-group mb-2">
            <label class="form-label">ملاحظات عامة للطلب</label>
            <textarea class="form-textarea" id="orderComments" placeholder="أضف أي ملاحظات عامة للطلب..."></textarea>
          </div>

          <!-- Order Items Table -->
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 30%">المنتج</th>
                <th style="width: 12%">الكمية</th>
                <th style="width: 12%">الوحدة</th>
                <th style="width: 12%">السعر</th>
                <th style="width: 25%">ملاحظات المنتج</th>
                <th style="width: 9%">إجراءات</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody">
            </tbody>
          </table>

          <button type="button" class="btn add-item-btn" onclick="addOrderItem()">
            <i class="fas fa-plus"></i>
            إضافة منتج جديد
          </button>

          <!-- Submit Buttons -->
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
            <button type="button" class="btn btn-success" onclick="submitOrder()">
              <i class="fas fa-check"></i>
              تأكيد الطلب
            </button>
            <button type="button" class="btn btn-primary" onclick="closeNewOrderModal()">
              <i class="fas fa-times"></i>
              إلغاء
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Add Lead Modal (dedicated) -->
  <div class="modal-overlay" id="addLeadModalDedicated">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-plus"></i>
          إضافة عميل محتمل جديد
        </h2>
        <button class="modal-close" onclick="closeAddLeadModalDedicated()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">اسم العميل المحتمل *</label>
            <input type="text" class="form-input" id="addLeadName" required data-label="اسم العميل المحتمل">
          </div>
          <div class="form-group">
            <label class="form-label">رقم الهاتف *</label>
            <input type="tel" class="form-input" id="addLeadPhone" required data-label="رقم الهاتف">
          </div>
          <div class="form-group">
            <label class="form-label">نوع *</label>
            <select class="form-select" id="addLeadGender" required data-label="نوع">
              <option value="">اختر النوع</option>
              <option value="male">ذكر</option>
              <option value="female">أنثى</option>
              <option value="other">آخر</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-input" id="addLeadEmail" data-label="البريد الإلكتروني">
          </div>
          <div class="form-group">
            <label class="form-label">ملاحظات/تعليق</label>
            <textarea class="form-textarea" id="addLeadComment" data-label="ملاحظات"
              placeholder="أضف أي ملاحظات عن العميل المحتمل..."></textarea>
          </div>
          <input type="hidden" id="addLeadType" value="customer">
          <div class="form-group">
            <label class="form-label">مصدر العميل *</label>
            <select class="form-select" id="addLeadPrimarySourceOfSale" required data-label="مصدر الطلب"></select>
          </div>
          <div class="form-group">
            <label class="form-label">المصدر الفرعي</label>
            <select class="form-select" id="addLeadSecondarySourceOfSale" data-label="المصدر الفرعي"></select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-overlay" id="addCustomerModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-plus"></i>
          إضافة عميل جديد
        </h2>
        <button class="modal-close" onclick="closeAddCustomerModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">اسم العميل *</label>
            <input type="text" class="form-input" id="addCustomerName" required data-label="اسم العميل">
          </div>
          <div class="form-group">
            <label class="form-label">رقم الهاتف *</label>
            <input type="tel" class="form-input" id="addCustomerPhone" required data-label="رقم الهاتف">
          </div>
          <div class="form-group">
            <label class="form-label">نوع *</label>
            <select class="form-select" id="addCustomerGender" required data-label="نوع">
              <option value="">اختر النوع</option>
              <option value="male">ذكر</option>
              <option value="female">أنثى</option>
              <option value="other">آخر</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">واتساب</label>
            <input type="tel" class="form-input" id="addCustomerWhatsapp" data-label="واتساب">
          </div>
          <div class="form-group">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-input" id="addCustomerEmail" data-label="البريد الإلكتروني">
          </div>
          <div class="form-group">
            <label class="form-label">ملاحظات/تعليق</label>
            <textarea class="form-textarea" id="addCustomerComment" data-label="ملاحظات"
              placeholder="أضف أي ملاحظات عن العميل..."></textarea>
          </div>
          <input type="hidden" id="addCustomerType" value="customer">
          <div class="form-group">
            <label class="form-label">مصدر العميل *</label>
            <select class="form-select" id="addCustomerPrimarySourceOfSale" required data-label="مصدر الطلب"></select>
          </div>
          <div class="form-group">
            <label class="form-label">المصدر الفرعي</label>
            <select class="form-select" id="addCustomerSecondarySourceOfSale" data-label="المصدر الفرعي"></select>
          </div>
        </div>

        <!-- Address Section -->
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-200);">
          <h3 style="margin-bottom: 1.5rem; color: var(--gray-700);">
            <i class="fas fa-map-marker-alt"></i>
            عنوان العميل
          </h3>
          <div class="form-grid">
            <!-- Address Label -->
            <div class="form-group">
              <label class="form-label">تسمية العنوان</label>
              <select class="form-select" id="addCustomerAddressLabel">
                <option value="Home" data-icon="fa-home">🏠 المنزل</option>
                <option value="Work" data-icon="fa-building">🏢 العمل</option>
                <option value="Family" data-icon="fa-users">👪 العائلة</option>
                <option value="Friend" data-icon="fa-handshake">🤝 صديق</option>
                <option value="Warehouse" data-icon="fa-warehouse">🏬 مستودع</option>
                <option value="Chalet" data-icon="fa-umbrella-beach">🏖️ شاليه</option>
                <option value="Farm" data-icon="fa-tractor">🌾 مزرعة</option>
                <option value="Shop" data-icon="fa-store">🛒 متجر</option>
                <option value="Other" data-icon="fa-map-marker-alt">📍 أخرى</option>
              </select>
            </div>
            <!-- Building Number -->
            <div class="form-group">
              <label class="form-label">رقم المنزل</label>
              <input type="text" class="form-input" id="addCustomerHouseNumber">
            </div>
            <!-- Flat Number -->
            <div class="form-group">
              <label class="form-label">رقم الشقة</label>
              <input type="text" class="form-input" id="addCustomerFlatNumber">
            </div>
            <!-- Floor Number -->
            <div class="form-group">
              <label class="form-label">رقم الدور</label>
              <input type="text" class="form-input" id="addCustomerFloorNumber">
            </div>
            <!-- Street Name -->
            <div class="form-group">
              <label class="form-label">اسم الشارع *</label>
              <input type="text" class="form-input" id="addCustomerStreetName" required data-label="اسم الشارع">
            </div>
            <!-- District (searchable) -->
            <div class="form-group" style="position:relative;">
              <label class="form-label">المنطقة *</label>
              <input type="text" class="form-input" id="addCustomerDistrictSearch" placeholder="ابحث عن المنطقة..."
                autocomplete="off" required data-label="المنطقة" style="padding-left: 2.5rem; padding-right: 1rem;">
              <i class="fas fa-chevron-down" id="addCustomerDistrictChevron"
                style="position:absolute; left:1.25rem; top:50%; transform:translateY(-50%); color:#aaa; font-size:1.2em; pointer-events:none; line-height:1;"></i>
              <div class="search-results" id="addCustomerDistrictSearchResults"></div>
              <input type="hidden" id="addCustomerAddressDistrict">
              <input type="hidden" id="addCustomerAddressGovernorate">
              <input type="hidden" id="addCustomerDistrictId" required data-label="المنطقة">
            </div>
            <!-- Landmark -->
            <div class="form-group">
              <label class="form-label">علامة مميزة</label>
              <input type="text" class="form-input" id="addCustomerAddressMarking">
            </div>
            <!-- Comment -->
            <div class="form-group">
              <label class="form-label">ملاحظات/تعليق</label>
              <textarea class="form-textarea" id="addCustomerAddressComment"
                placeholder="أضف أي ملاحظات عن العنوان..."></textarea>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
          <button type="button" class="btn btn-success" onclick="submitAddCustomer()">
            <i class="fas fa-save"></i>
            حفظ العميل
          </button>
          <button type="button" class="btn btn-primary" onclick="closeAddCustomerModal()">
            <i class="fas fa-times"></i>
            إلغاء
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== GLOBAL DATA =====
    let products = [
      { id: 'PROD_001', name: 'أرز أبيض - كيس 5 كيلو', category: 'أرز', price: 45.00 },
      { id: 'PROD_002', name: 'أرز بسمتي - كيس 2 كيلو', category: 'أرز', price: 35.00 },
      { id: 'PROD_003', name: 'معكرونة بنة - 500 جرام', category: 'معكرونة', price: 12.50 },
      { id: 'PROD_004', name: 'معكرونة حلزونية - 500 جرام', category: 'معكرونة', price: 15.00 },
      { id: 'PROD_005', name: 'زيت دوار الشمس - لتر', category: 'زيوت', price: 25.00 },
      { id: 'PROD_006', name: 'زيت زيتون - 500 مل', category: 'زيوت', price: 85.00 },
      { id: 'PROD_007', name: 'سكر أبيض - كيس كيلو', category: 'سكر', price: 20.00 },
      { id: 'PROD_008', name: 'دقيق فاخر - كيس 2 كيلو', category: 'دقيق', price: 18.00 },
      { id: 'PROD_009', name: 'شاي أحمد - 100 كيس', category: 'مشروبات', price: 30.00 },
      { id: 'PROD_010', name: 'قهوة نسكافيه - 200 جرام', category: 'مشروبات', price: 55.00 }
    ];

    let districts = [
      { district_id: '420000000000001', district_name: 'المعادي', governorate_name: 'القاهرة' },
      { district_id: '420000000000002', district_name: 'مصر الجديدة', governorate_name: 'القاهرة' },
      { district_id: '420000000000003', district_name: 'وسط البلد', governorate_name: 'القاهرة' },
      { district_id: '420000000000004', district_name: 'النزهة', governorate_name: 'القاهرة' },
      { district_id: '420000000000005', district_name: 'مدينة نصر', governorate_name: 'القاهرة' },
      { district_id: '420000000000006', district_name: 'المهندسين', governorate_name: 'الجيزة' },
      { district_id: '420000000000007', district_name: 'الزمالك', governorate_name: 'القاهرة' }
    ];

    let orders = [
      {
        id: 'AFI-001',
        customerId: 'CUST-001',
        customerName: 'أحمد محمد علي',
        customerPhone: '01234567890',
        date: '2025-06-10',
        amount: 450.00,
        status: 'pending',
        items: [
          { productId: 'PROD_002', productName: 'أرز بسمتي - كيس 2 كيلو', quantity: 2, unit: 'كيس', price: 35.00, comments: 'يفضل النوع الفاخر' },
          { productId: 'PROD_005', productName: 'زيت دوار الشمس - لتر', quantity: 1, unit: 'لتر', price: 25.00, comments: '' }
        ],
        area: 'المعادي الجديدة',
        address_details: 'شارع النيل، منزل 15، شقة 3، دور 2<br>المعادي - القاهرة',
        comments: 'يرجى التوصيل قبل المغرب'
      },
      {
        id: 'AFI-002',
        customerId: 'CUST-002',
        customerName: 'فاطمة أحمد محمود',
        customerPhone: '01111111111',
        date: '2025-06-09',
        amount: 320.50,
        status: 'in-progress',
        items: [
          { productId: 'PROD_003', productName: 'معكرونة بنة - 500 جرام', quantity: 3, unit: 'عبوة', price: 12.50, comments: 'نوع جيد' },
          { productId: 'PROD_007', productName: 'سكر أبيض - كيس كيلو', quantity: 2, unit: 'كيس', price: 20.00, comments: '' }
        ],
        area: 'هليوبوليس',
        address_details: 'شارع الجمهورية، منزل 8، شقة 5، دور 5<br>مصر الجديدة - القاهرة',
        comments: ''
      },
      {
        id: 'AFI-003',
        customerId: 'CUST-003',
        customerName: 'محمد حسن إبراهيم',
        customerPhone: '01222222222',
        date: '2025-06-08',
        amount: 680.75,
        status: 'out-for-delivery',
        items: [
          { productId: 'PROD_008', productName: 'دقيق فاخر - كيس 2 كيلو', quantity: 1, unit: 'كيس', price: 18.00, comments: '' },
          { productId: 'PROD_009', productName: 'شاي أحمد - 100 كيس', quantity: 2, unit: 'عبوة', price: 30.00, comments: 'تاريخ حديث' }
        ],
        area: 'الدقي',
        address_details: 'شارع أحمد عرابي، منزل 22<br>المهندسين - الجيزة',
        comments: 'طلب عاجل'
      },
      {
        id: 'AFI-004',
        customerId: 'CUST-001',
        customerName: 'أحمد محمد علي',
        customerPhone: '01234567890',
        date: '2025-06-07',
        amount: 280.00,
        status: 'delivered',
        items: [
          { productId: 'PROD_006', productName: 'زيت زيتون - 500 مل', quantity: 1, unit: 'زجاجة', price: 85.00, comments: 'أصلي 100%' }
        ],
        area: 'المعادي الجديدة',
        address_details: 'شارع النيل، منزل 15، شقة 3، دور 2<br>المعادي - القاهرة',
        comments: ''
      },
      {
        id: 'AFI-005',
        customerId: 'CUST-004',
        customerName: 'سارة عبدالله أحمد',
        customerPhone: '01333333333',
        date: '2025-06-06',
        amount: 520.25,
        status: 'delivered',
        items: [
          { productId: 'PROD_001', productName: 'أرز أبيض - كيس 5 كيلو', quantity: 2, unit: 'كيس', price: 45.00, comments: '' },
          { productId: 'PROD_004', productName: 'معكرونة حلزونية - 500 جرام', quantity: 3, unit: 'عبوة', price: 15.00, comments: 'للأطفال' }
        ],
        area: 'الحي الأول',
        address_details: 'شارع العروبة، منزل 10، شقة 2، دور 2<br>مدينة نصر - القاهرة',
        comments: 'توصيل سريع'
      }
    ];

    let customers = [
      {
        id: 'CUST-001',
        name: 'أحمد محمد علي',
        phone: '01234567890',
        gender: 'male',
        addresses: [
          {
            id: 'ADDR_001',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: 'عنوان رئيسي',
            house_number: '15',
            flat_number: '3',
            floor_number: '2',
            street_name: 'شارع النيل',
            address_marking: 'قرب محطة المترو',
            address_district: 'المعادي',
            address_governorate: 'القاهرة',
            district_id: '420000000000001',
            area_id: '420000000000101',
            area: 'المعادي الجديدة',
            isPrimary: true
          },
          {
            id: 'ADDR_002',
            address_label: 'Work',
            address_type: 'Work',
            address_comment: 'مكتب الشركة',
            house_number: '45',
            flat_number: '201',
            floor_number: '5',
            street_name: 'شارع التحرير',
            address_marking: '',
            address_district: 'وسط البلد',
            address_governorate: 'القاهرة',
            district_id: '420000000000003',
            area_id: '420000000000301',
            area: 'التحرير',
            isPrimary: false
          }
        ],
        totalOrders: 5,
        totalSpent: 1250.00,
        lastOrderDate: '2025-06-10'
      },
      {
        id: 'CUST-002',
        name: 'فاطمة أحمد محمود',
        phone: '01111111111',
        gender: 'female',
        addresses: [
          {
            id: 'ADDR_003',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '8',
            flat_number: '5',
            floor_number: '5',
            street_name: 'شارع الجمهورية',
            address_marking: '',
            address_district: 'مصر الجديدة',
            address_governorate: 'القاهرة',
            district_id: '420000000000002',
            area_id: '420000000000201',
            area: 'هليوبوليس',
            isPrimary: true
          }
        ],
        totalOrders: 3,
        totalSpent: 890.50,
        lastOrderDate: '2025-06-09'
      },
      {
        id: 'CUST-003',
        name: 'محمد حسن إبراهيم',
        phone: '01222222222',
        gender: 'male',
        addresses: [
          {
            id: 'ADDR_004',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '22',
            flat_number: '',
            floor_number: '',
            street_name: 'شارع أحمد عرابي',
            address_marking: '',
            address_district: 'المهندسين',
            address_governorate: 'الجيزة',
            district_id: '420000000000006',
            area_id: '420000000000601',
            area: 'الدقي',
            isPrimary: true
          }
        ],
        totalOrders: 2,
        totalSpent: 680.75,
        lastOrderDate: '2025-06-08'
      },
      {
        id: 'CUST-004',
        name: 'سارة عبدالله أحمد',
        phone: '01333333333',
        gender: 'female',
        addresses: [
          {
            id: 'ADDR_005',
            address_label: 'Home',
            address_type: 'Home',
            address_comment: '',
            house_number: '10',
            flat_number: '2',
            floor_number: '2',
            street_name: 'شارع العروبة',
            address_marking: '',
            address_district: 'مدينة نصر',
            address_governorate: 'القاهرة',
            district_id: '420000000000005',
            area_id: '420000000000501',
            area: 'الحي الأول',
            isPrimary: true
          }
        ],
        totalOrders: 1,
        totalSpent: 520.25,
        lastOrderDate: '2025-06-06'
      }
    ];

    let leads = [
      {
        lead_name: 'خالد عبدالرحمن',
        lead_type: 'customer',
        lead_comment: 'مهتم بالمنتجات العضوية، طلب كتالوج',
        lead_phone: '01544444444',
        lead_email: 'khalid@email.com',
        lead_gender: 'male',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Facebook'
      },
      {
        lead_name: 'ريم محمود',
        lead_type: 'customer',
        lead_comment: 'تم إرسال عرض سعر لطلبية شهرية',
        lead_phone: '01655555555',
        lead_email: 'reem.m@email.com',
        lead_gender: 'female',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Google'
      },
      {
        lead_name: 'عمر الشريف',
        lead_type: 'customer',
        lead_comment: 'إحالة من أحمد محمد علي',
        lead_phone: '01766666666',
        lead_email: '',
        lead_gender: 'male',
        primary_source_of_sale: 'Referral',
        secondary_source_of_sale: ''
      },
      {
        lead_name: 'نورا حسام',
        lead_type: 'customer',
        lead_comment: 'غير مهتمة حالياً، للمتابعة بعد 3 أشهر',
        lead_phone: '01877777777',
        lead_email: 'nora.h@email.com',
        lead_gender: 'female',
        primary_source_of_sale: 'Online',
        secondary_source_of_sale: 'Instagram'
      }
    ];

    // ===== STATE MANAGEMENT =====
    let appState = {
      currentSection: 'orders',
      orderFilter: 'all',
      selectedCustomer: null,
      selectedAddress: null,
      newOrderForm: {
        customer: null,
        address: null,
        items: [],
        notes: '',
        source: '',
        secondarySource: ''
      },
      isAddingNewAddress: false
    };

    // ===== API MODULE =====
    // === Per-method test flags ===
    const TEST_MODE_GET_ORDERS = true;
    const TEST_MODE_ADD_ORDER = false;
    const TEST_MODE_GET_PRODUCTS = true;
    const TEST_MODE_GET_CUSTOMERS = true;
    const TEST_MODE_ADD_CUSTOMER = false;
    const TEST_MODE_GET_LEADS = true;
    const TEST_MODE_ADD_COMPOUNDED_REQUEST_TO_BUFFER = false;
    // ...add more as needed

    const API = {
      activeRequests: {},

      request: function (functionName, data = {}, options = {}) {
        // Show loader if not explicitly disabled
        if (options.showLoader !== false) {
          showGlobalLoader();
          if (options.loaderMessage) {
            updateLoadingMessage(options.loaderMessage);
          }
        }

        // Only real backend logic here!
        return new Promise((resolve, reject) => {
          // Example for Google Apps Script:
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((result) => {
                // Hide loader if shown
                if (options.showLoader !== false) {
                  hideGlobalLoader();
                }
                // Show success toast if not disabled
                if (!options.hideToastOnSuccess && options.successMessage) {
                  showToast('success', options.successMessage);
                }
                resolve(result);
              })
              .withFailureHandler((error) => {
                // Hide loader if shown
                if (options.showLoader !== false) {
                  hideGlobalLoader();
                }
                // Show error toast
                showToast('error', 'حدث خطأ', error.message || 'حدث خطأ غير متوقع');
                reject(error);
              })[functionName](data);
          } else {
            // Placeholder for REST API or other backend
            const error = new Error('Real backend not implemented.');
            // Hide loader if shown
            if (options.showLoader !== false) {
              hideGlobalLoader();
            }
            // Show error toast
            showToast('error', 'حدث خطأ', error.message);
            reject(error);
          }
        });
      },

      getLocations: function () {
        return new Promise(resolve => setTimeout(() => resolve(districts), 500));
      },

      getOrders: function () {
        if (TEST_MODE_GET_ORDERS) {
          return new Promise(resolve => setTimeout(() => resolve(orders), 500));
        }
        return this.request('getOrders', {}, {
          loaderMessage: 'جاري تحميل الطلبات...',
          hideToastOnSuccess: true
        });
      },

      addOrder: function (orderData) {
        if (TEST_MODE_ADD_ORDER) {
          // Simulate adding order to mock orders array
          return new Promise(resolve => {
            setTimeout(() => {
              const newOrder = {
                id: `AFI-${String(orders.length + 1).padStart(3, '0')}`,
                customerId: orderData.customer.id || `CUST-${Date.now()}`,
                customerName: orderData.customer.name,
                customerPhone: orderData.customer.phone,
                date: new Date().toISOString().split('T')[0],
                amount: orderData.items.reduce((total, item) => total + (item.price * item.quantity), 0),
                status: 'pending',
                items: orderData.items,
                area: orderData.address ? orderData.address.area : (orderData.customer.area || 'غير محدد'),
                address_details: orderData.address ? 
                  `${orderData.address.street_name}، منزل ${orderData.address.house_number}${orderData.address.flat_number ? '، شقة ' + orderData.address.flat_number : ''}${orderData.address.floor_number ? '، دور ' + orderData.address.floor_number : ''}<br>${orderData.address.address_district} - ${orderData.address.address_governorate}` :
                  (orderData.customer.address || 'غير محدد'),
                comments: orderData.notes || ''
              };
              orders.unshift(newOrder);
              resolve(newOrder);
            }, 500);
          });
        }
        return this.request('addOrder', orderData, {
          loaderMessage: 'جاري إنشاء الطلب...',
          successMessage: 'تم إنشاء الطلب بنجاح'
        });
      },

      getProducts: function () {
        if (TEST_MODE_GET_PRODUCTS) {
          return new Promise(resolve => setTimeout(() => resolve(products), 500));
        }
        return this.request('getProducts', {}, {
          loaderMessage: 'جاري تحميل المنتجات...',
          hideToastOnSuccess: true
        });
      },

      getCustomers: function () {
        if (TEST_MODE_GET_CUSTOMERS) {
          return new Promise(resolve => setTimeout(() => resolve(customers), 500));
        }
        return this.request('getCustomers', {}, {
          loaderMessage: 'جاري تحميل العملاء...',
          hideToastOnSuccess: true
        });
      },

      addCustomer: function (customerData) {
        if (TEST_MODE_ADD_CUSTOMER) {
          return new Promise(resolve => {
            setTimeout(() => {
              const newId = `CUST-${Date.now()}`;
              const newAddressId = `ADDR-${Date.now()}`;
              const newCustomerForMockDB = {
                id: newId,
                name: customerData.customer.name,
                phone: customerData.customer.phone,
                gender: customerData.customer.gender,
                addresses: [{
                  id: newAddressId,
                  address_label: customerData.address.address_label || 'Home',
                  address_type: customerData.address.address_label || 'Home',
                  address_comment: customerData.address.address_comment || '',
                  house_number: customerData.address.house_number || '',
                  flat_number: customerData.address.flat_number || '',
                  floor_number: customerData.address.floor_number || '',
                  street_name: customerData.address.street_name,
                  address_marking: customerData.address.address_marking || '',
                  address_district: customerData.address.address_district,
                  address_governorate: customerData.address.address_governorate,
                  district_id: customerData.address.district_id,
                  area: customerData.address.address_district,
                  isPrimary: true
                }],
                totalOrders: 0,
                totalSpent: 0,
                lastOrderDate: null
              };
              customers.push(newCustomerForMockDB);
              resolve({ customer_id: newId, address_id: newAddressId });
            }, 500);
          });
        }
        return this.request('addCustomer', customerData, {
          loaderMessage: 'جاري إضافة العميل...',
          successMessage: 'تم إضافة العميل بنجاح'
        });
      },

      getLeads: function () {
        if (TEST_MODE_GET_LEADS) {
          return new Promise(resolve => setTimeout(() => resolve(leads), 500));
        }
        return this.request('getLeads', {}, {
          loaderMessage: 'جاري تحميل العملاء المحتملين...',
          hideToastOnSuccess: true
        });
      },

      addLead: function (leadData) {
        return new Promise(resolve => {
          setTimeout(() => {
            const newLead = {
              lead_name: leadData.lead_name,
              lead_type: leadData.lead_type,
              lead_comment: leadData.lead_comment,
              lead_phone: leadData.lead_phone,
              lead_email: leadData.lead_email,
              lead_gender: leadData.lead_gender,
              primary_source_of_sale: leadData.primary_source_of_sale,
              secondary_source_of_sale: leadData.secondary_source_of_sale
            };
            leads.push(newLead);
            resolve(newLead);
          }, 500);
        });
      },

      addCompoundedRequestToBuffer: function(orderData) {
        if (TEST_MODE_ADD_COMPOUNDED_REQUEST_TO_BUFFER) {
          return new Promise(resolve => setTimeout(() => resolve({ success: true, message: 'Buffered successfully (mock)' }), 500));
        }
        return this.request('addCompoundedRequestToBuffer', orderData, {
          loaderMessage: 'جاري إنشاء الطلب...'
        });
      },

      addCompoudedOrder: function(orderData) {
        // Fire-and-forget: don't show loader, don't block UI
        return this.request('addCompoudedOrder', orderData, {
          showLoader: false,
          hideToastOnSuccess: true
        });
      },
    };

    // ===== UTILITY FUNCTIONS =====
    function updateLoadingMessage(message) {
      document.getElementById('loadingMessage').textContent = message;
    }

    function showGlobalLoader() {
      document.getElementById('loadingScreen').classList.remove('hidden');
    }

    function hideGlobalLoader() {
      document.getElementById('loadingScreen').classList.add('hidden');
    }

    function showToast(type, title, message = '') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle'
      };

      toast.innerHTML = `
        <div class="toast-icon"><i class="fas fa-${icons[type]}"></i></div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

      toastContainer.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function formatCurrency(amount) {
      return `${amount.toFixed(2)} ج.م`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-EG');
    }

    // ===== NAVIGATION =====
    function initializeNavigation() {
      const navTabs = document.querySelectorAll('.nav-tab');
      const contentSections = document.querySelectorAll('.content-section');

      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetSection = tab.dataset.section;

          // Update nav tabs
          navTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update content sections
          contentSections.forEach(section => section.classList.remove('active'));
          document.getElementById(targetSection).classList.add('active');

          appState.currentSection = targetSection;

          // Load section data if needed
          if (targetSection === 'customers') {
            loadCustomers();
          } else if (targetSection === 'leads') {
            loadLeads();
          }
        });
      });
    }

    // ===== ORDERS MANAGEMENT =====
    function initializeOrderFilters() {
      const filterButtons = document.querySelectorAll('.filter-btn');

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;

          // Update filter buttons
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          appState.orderFilter = filter;
          renderOrders();
        });
      });
    }

    function loadOrders() {
      API.getOrders().then(orders => {
        orders = orders;
        updateOrderCounts();
        renderOrders();
      }).catch(error => {
        console.error('Failed to load orders:', error);
      });
    }

    function updateOrderCounts() {
      const counts = {
        all: orders.length,
        pending: orders.filter(o => o.status === 'pending').length,
        inprogress: orders.filter(o => o.status === 'in-progress').length,
        readyforshipment: orders.filter(o => o.status === 'ready-for-shipment').length,
        outfordelivery: orders.filter(o => o.status === 'out-for-delivery').length,
        delivered: orders.filter(o => o.status === 'delivered').length
      };

      // Update badges with correct IDs
      document.getElementById('allCount').textContent = counts.all;
      document.getElementById('pendingCount').textContent = counts.pending;
      document.getElementById('inProgressCount').textContent = counts.inprogress;
      document.getElementById('readyForShipmentCount').textContent = counts.readyforshipment;
      document.getElementById('outForDeliveryCount').textContent = counts.outfordelivery;
      document.getElementById('deliveredCount').textContent = counts.delivered;
    }

    function renderOrders() {
      const tbody = document.getElementById('ordersTableBody');
      if (!tbody) {
        console.error('Orders table body element not found');
        return;
      }

      if (!orders || orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <i class="fas fa-shopping-cart"></i>
                <h3>لا توجد طلبات</h3>
                <p>لم يتم إضافة أي طلبات حتى الآن. يمكنك إضافة طلب جديد من خلال الضغط على زر "طلب جديد"</p>
                <button class="btn btn-primary" onclick="openNewOrderModal()">
                  <i class="fas fa-plus"></i>
                  إضافة طلب جديد
                </button>
              </div>
            </td>
          </tr>`;
        return;
      }

      let filteredOrders = orders;
      if (appState.orderFilter !== 'all') {
        filteredOrders = orders.filter(order => order.status === appState.orderFilter);
      }

      if (filteredOrders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <i class="fas fa-filter"></i>
                <h3>لا توجد طلبات في هذه الفئة</h3>
                <p>لم يتم العثور على أي طلبات تطابق الفلتر المحدد. جرب تغيير الفلتر أو إضافة طلب جديد</p>
                <button class="btn btn-primary" onclick="openNewOrderModal()">
                  <i class="fas fa-plus"></i>
                  إضافة طلب جديد
                </button>
              </div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = filteredOrders.map(order => {
        const totalItems = order.items.length;
        const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);

        return `
          <tr class="order-row" onclick="toggleOrderDetails('${order.id}')" data-order-id="${order.id}">
            <td><strong>${order.id}</strong></td>
            <td>
              <div>
                <strong>${order.customerName}</strong><br>
                <small style="color: var(--gray-500);">${order.customerPhone}</small>
              </div>
            </td>
            <td>${formatDate(order.date)}</td>
            <td><strong>${formatCurrency(order.amount)}</strong></td>
            <td>
              <select class="form-select" style="padding: 0.5rem; font-size: 0.875rem;" onchange="changeOrderStatus('${order.id}', this.value)" onclick="event.stopPropagation()">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>في الانتظار</option>
                <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>قيد التحضير</option>
                <option value="ready-for-shipment" ${order.status === 'ready-for-shipment' ? 'selected' : ''}>جاهز للشحن</option>
                <option value="out-for-delivery" ${order.status === 'out-for-delivery' ? 'selected' : ''}>في التوصيل</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>تم التوصيل</option>
              </select>
            </td>
          </tr>
          <tr class="order-details-row" id="details-${order.id}">
            <td colspan="6">
              <div class="order-details-content">
                <div class="order-summary">
                  <div class="summary-item">
                    <div class="summary-label">
                      <i class="fas fa-box" style="color: var(--info);"></i>
                      إجمالي المنتجات
                    </div>
                    <div class="summary-value">${totalItems}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">
                      <i class="fas fa-layer-group" style="color: var(--warning);"></i>
                      إجمالي الكمية
                    </div>
                    <div class="summary-value">${totalQuantity}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">
                      <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i>
                      المنطقة
                    </div>
                    <div class="summary-value">${order.area || 'غير محدد'}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">
                      <i class="fas fa-home" style="color: var(--success);"></i>
                      تفاصيل العنوان
                    </div>
                    <div class="summary-value address-details">${order.address_details || order.address || 'غير محدد'}</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">
                      <i class="fas fa-calendar-alt" style="color: var(--purple);"></i>
                      تاريخ الطلب
                    </div>
                    <div class="summary-value">${formatDate(order.date)}</div>
                  </div>
                </div>
                
                ${order.comments ? `
                  <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid var(--info);">
                    <h5 style="margin-bottom: 0.5rem; color: var(--gray-700);"><i class="fas fa-comment"></i> ملاحظات الطلب:</h5>
                    <p style="margin: 0; color: var(--gray-600);">${order.comments}</p>
                  </div>
                ` : ''}
                
                <h4 style="margin-bottom: 1rem; color: var(--gray-700);">
                  <i class="fas fa-list"></i> تفاصيل المنتجات
                </h4>
                
                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>المنتج</th>
                      <th>الكمية</th>
                      <th>الوحدة</th>
                      <th>السعر</th>
                      <th>الإجمالي</th>
                      <th>ملاحظات</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${order.items.map(item => `
                      <tr>
                        <td><strong>${item.productName}</strong></td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td><strong>${formatCurrency(item.price * item.quantity)}</strong></td>
                        <td>${item.comments || '-'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: var(--gray-100); font-weight: 600;">
                      <td colspan="4" style="text-align: left; padding: 1rem;">المجموع الكلي:</td>
                      <td style="padding: 1rem;"><strong>${formatCurrency(order.amount)}</strong></td>
                      <td style="padding: 1rem;"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function toggleOrderDetails(orderId) {
      const detailsRow = document.getElementById(`details-${orderId}`);
      const expandIcon = document.getElementById(`expand-${orderId}`);
      const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);

      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        if (expandIcon) expandIcon.classList.remove('rotated');
        orderRow.classList.remove('expanded');
      } else {
        // Close all other expanded rows first
        document.querySelectorAll('.order-details-row.show').forEach(row => {
          row.classList.remove('show');
        });
        document.querySelectorAll('.expand-icon.rotated').forEach(icon => {
          icon.classList.remove('rotated');
        });
        document.querySelectorAll('.order-row.expanded').forEach(row => {
          row.classList.remove('expanded');
        });

        // Open the clicked row
        detailsRow.classList.add('show');
        if (expandIcon) expandIcon.classList.add('rotated');
        orderRow.classList.add('expanded');
      }
    }

    function changeOrderStatus(orderId, newStatus) {
      API.updateOrderStatus(orderId, newStatus).then(updatedOrder => {
        updateOrderCounts();
        renderOrders();
      }).catch(error => {
        console.error('Failed to update order status:', error);
        // Revert the select to original value
        loadOrders();
      });
    }

    // ===== CUSTOMERS MANAGEMENT =====
    function loadCustomers() {
      API.getCustomers().then(customersData => {
        customers = Array.isArray(customersData) ? customersData : [];
        renderCustomers();
      }).catch(error => {
        console.error('Failed to load customers:', error);
        customers = [];
        renderCustomers();
      });
    }

    function loadLeads() {
      API.getLeads().then(leadsData => {
        leads = Array.isArray(leadsData) ? leadsData : [];
        renderLeads();
      }).catch(error => {
        console.error('Failed to load leads:', error);
        leads = [];
        renderLeads();
      });
    }

    function renderCustomers() {
      const grid = document.getElementById('customersGrid');
      if (!grid) return;

      if (customers.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <h3>لا يوجد عملاء</h3>
            <p>لم يتم إضافة أي عملاء حتى الآن. يمكنك إضافة عميل جديد من خلال الضغط على زر "إضافة عميل"</p>
            <button class="btn btn-primary" onclick="openAddCustomerModal()">
              <i class="fas fa-user-plus"></i>
              إضافة عميل جديد
            </button>
          </div>`;
        return;
      }

      grid.innerHTML = customers.map(customer => {
        const primaryAddress = customer.addresses && customer.addresses.length > 0
          ? customer.addresses.find(addr => addr.isPrimary) || customer.addresses[0]
          : null;
        let genderIcon, genderText, genderColor;
        
        if (customer.gender === 'male') {
          genderIcon = 'fas fa-mars';
          genderText = 'ذكر';
          genderColor = '#3b82f6';
        } else if (customer.gender === 'female') {
          genderIcon = 'fas fa-venus';
          genderText = 'أنثى';
          genderColor = '#ec4899';
        } else {
          genderIcon = 'fas fa-user';
          genderText = 'آخر';
          genderColor = '#6b7280';
        }
        
        return `
          <div class="customer-card">
            <div class="customer-header">
              <div class="customer-info">
                <h3>${customer.name}</h3>
                <p><i class="fas fa-phone"></i> ${customer.phone}</p>
                <p><i class="${genderIcon}" style="color: ${genderColor};"></i> ${genderText}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${primaryAddress ? (primaryAddress.area + (primaryAddress.address_governorate ? ', ' + primaryAddress.address_governorate : '')) : 'لا يوجد عنوان'}</p>
              </div>
            </div>
            <div class="customer-stats">
              <div class="stat">
                <div class="stat-value">${customer.totalOrders}</div>
                <div class="stat-label">عدد الطلبات</div>
              </div>
              <div class="stat">
                <div class="stat-value">${formatCurrency(customer.totalSpent)}</div>
                <div class="stat-label">إجمالي المشتريات</div>
              </div>
            </div>
            ${customer.lastOrderDate ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); text-align: center; color: var(--gray-500); font-size: 0.9rem;">
                آخر طلب: ${formatDate(customer.lastOrderDate)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ===== NEW ORDER MODAL =====
    function openNewOrderModal() {
      document.getElementById('newOrderModal').classList.add('show');
      resetNewOrderForm();
      
      // Initialize customer search
      initializeCustomerSearch();
      // Initialize address grid listener
      initializeAddressGrid();
      
      // Initialize source dropdowns for order form
      initializeSourceDropdowns();
      
      // Initialize customer source dropdowns in the order form
      populateSourceDropdowns('primarySourceOfSale', 'secondarySourceOfSale');
    }

    function closeNewOrderModal() {
      document.getElementById('newOrderModal').classList.remove('show');
      resetNewOrderForm();
    }

    // Add click event listener to close modal when clicking outside
    document.getElementById('newOrderModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeNewOrderModal();
      }
    });

    function resetNewOrderForm() {
      const customerSearch = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');

      if (customerSearch) customerSearch.value = '';
      if (searchResults) searchResults.classList.remove('show');

      clearSelectedCustomer()

      // Hide all form sections
      hideAllFormSections();

      // Reset form fields
      ['customerName', 'customerPhone', 'customerAddress', 'customerDistrict', 'customerArea', 'orderSource', 'orderSecondarySource', 'orderComments'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });

      // Reset new address fields
      ['newAddressStreet', 'newAddressDistrict', 'newAddressArea', 'newAddressLabel'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });

      // Clear items table
      const itemsTableBody = document.getElementById('itemsTableBody');
      if (itemsTableBody) itemsTableBody.innerHTML = '';

      // Reset state
      appState.newOrderForm = {
        customer: null,
        address: null,
        items: [],
        notes: '',
        source: '',
        secondarySource: ''
      };
      appState.selectedCustomer = null;
      appState.selectedAddress = null;
      appState.isAddingNewAddress = false;
    }

    function hideAllFormSections() {
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('show');
      });
    }

    function showCustomerDetailsSection() {
      hideAllFormSections();
      document.getElementById('customerDetailsSection').classList.add('show');
      document.getElementById('orderDetailsSection').classList.add('show');

      // Initialize with one empty item if none exist
      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function showAddressSection() {
      hideAllFormSections();
      document.getElementById('addressSection').classList.add('show');
    }

    function showNewAddressForm() {
      hideAllFormSections();
      appState.isAddingNewAddress = true;
      appState.selectedAddress = null;
      appState.newOrderForm.address = null;
      document.getElementById('newAddressSection').classList.add('show');
      initializeDistrictSearch();
    }

    function showOrderDetailsSection() {
      document.getElementById('orderDetailsSection').classList.add('show');

      // Initialize with one empty item if none exist
      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function initializeDistrictSearch() {
      const input = document.getElementById('newAddressDistrictSearch');
      const results = document.getElementById('districtSearchResults');
      const chevron = document.getElementById('districtChevron');
      const hiddenDistrict = document.getElementById('newAddressDistrict');
      const hiddenGovernorate = document.getElementById('newAddressGovernorate');
      const hiddenDistrictId = document.getElementById('newDistrictId');
      let isOpen = false;

      function highlightMatch(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, 'gi');
        return text.replace(regex, '<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
      }

      function renderDistrictResults(filtered, term) {
        if (!filtered.length) {
          results.innerHTML = '<div class="search-result">لا توجد نتائج</div>';
          results.classList.add('show');
          isOpen = true;
          chevron.style.transform = 'translateY(-50%) rotate(180deg)';
          return;
        }
        results.innerHTML = filtered.map(d =>
          `<div class="search-result" data-id="${d.district_id}" data-name="${d.district_name}" data-gov="${d.governorate_name}">
            ${highlightMatch(d.district_name, term)} - ${highlightMatch(d.governorate_name, term)}
          </div>`
        ).join('');
        results.classList.add('show');
        isOpen = true;
        chevron.style.transform = 'translateY(-50%) rotate(180deg)';
      }

      function closeDropdown() {
        results.classList.remove('show');
        isOpen = false;
        chevron.style.transform = 'translateY(-50%)';
      }

      function filterDistricts(term) {
        term = term.trim().toLowerCase();
        if (!term) return districts;
        return districts.filter(d =>
          d.district_name.toLowerCase().includes(term) ||
          d.governorate_name.toLowerCase().includes(term)
        );
      }

      input.addEventListener('input', function () {
        const filtered = filterDistricts(input.value);
        renderDistrictResults(filtered, input.value.trim());
      });
      input.addEventListener('focus', function () {
        if (!isOpen) {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      input.addEventListener('click', function () {
        if (isOpen) {
          closeDropdown();
        } else {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.form-group')) {
          closeDropdown();
        }
      });
      results.addEventListener('click', function (e) {
        const item = e.target.closest('.search-result[data-id]');
        if (item) {
          input.value = item.dataset.name + ' - ' + item.dataset.gov;
          hiddenDistrict.value = item.dataset.name;
          hiddenGovernorate.value = item.dataset.gov;
          hiddenDistrictId.value = item.dataset.id;
          closeDropdown();
        }
      });
    }

    function saveNewAddress() {
      const label = document.getElementById('newAddressLabel').value;
      const comment = document.getElementById('newAddressComment').value.trim();
      const houseNumber = document.getElementById('newHouseNumber').value.trim();
      const flatNumber = document.getElementById('newFlatNumber').value.trim();
      const floorNumber = document.getElementById('newFloorNumber').value.trim();
      const street = document.getElementById('newStreetName').value.trim();
      const marking = document.getElementById('newAddressMarking').value.trim();
      const districtId = document.getElementById('newDistrictId').value;
      const governorate = document.getElementById('newAddressGovernorate').value;

      if (!street || !districtId) {
        showToast('error', 'يجب ملء جميع الحقول المطلوبة');
        return;
      }

      const selectedDistrict = districts.find(d => d.district_id === districtId);
      const addressDistrict = selectedDistrict ? selectedDistrict.district_name : '';
      const addressGovernorate = selectedDistrict ? selectedDistrict.governorate_name : '';

      const newAddress = {
        id: `ADDR-${Date.now()}`,
        address_label: label,
        address_comment: comment,
        house_number: houseNumber,
        flat_number: flatNumber,
        floor_number: floorNumber,
        street_name: street,
        address_marking: marking,
        address_district: addressDistrict,
        address_governorate: addressGovernorate,
        district_id: districtId,
        isPrimary: false
      };

      // Add to selected customer addresses
      if (appState.selectedCustomer) {
        appState.selectedCustomer.addresses.push(newAddress);
        showAddressSection();
        renderAddresses(appState.selectedCustomer.addresses);
        
        // Find the newly rendered card and select it
        const newAddressCard = document.querySelector(`.address-card[data-address-id="${newAddress.id}"]`);
        if (newAddressCard) {
          selectAddress(newAddress.id, newAddressCard);
        } else {
          // Fallback for safety
          selectAddress(newAddress);
        }

        showToast('success', 'تم إضافة العنوان بنجاح');
      }
    }

    function cancelNewAddress() {
      if (appState.selectedCustomer && appState.selectedCustomer.addresses.length > 0) {
        showAddressSection();
        renderAddresses(appState.selectedCustomer.addresses);
      } else {
        hideAllFormSections();
      }
      appState.isAddingNewAddress = false;
      appState.selectedAddress = null;
      appState.newOrderForm.address = null;
    }

    function initializeLocationDropdowns() {
      const districtSelect = document.getElementById('customerDistrict');
      const areaSelect = document.getElementById('customerArea');

      // Only proceed if both elements exist
      if (!districtSelect || !areaSelect) return;

      // Populate districts
      districtSelect.innerHTML = '<option value="">اختر المنطقة</option>' +
        districts.map(district =>
          `<option value="${district.id}">${district.name}</option>`
        ).join('');

      districtSelect.addEventListener('change', function () {
        const selectedDistrict = districtSelect.value;
        areaSelect.innerHTML = '<option value="">اختر الحي</option>';

        if (selectedDistrict && locations.areas[selectedDistrict]) {
          areaSelect.innerHTML += locations.areas[selectedDistrict].map(area =>
            `<option value="${area.id}">${area.name}</option>`
          ).join('');
        }
      });
    }

    function initializeSourceDropdowns() {
      const sourceSelect = document.getElementById('orderSource');
      const secondarySourceSelect = document.getElementById('orderSecondarySource');

      // Only proceed if both elements exist
      if (!sourceSelect || !secondarySourceSelect) return;

      const sourceMappings = {
        'Online': [
          { value: 'Referral', text: 'إحالة' },
          { value: 'Facebook', text: 'فيسبوك' },
          { value: 'Instagram', text: 'إنستغرام' },
          { value: 'Google', text: 'جوجل' },
          { value: 'Other', text: 'أخرى' }
        ],
        'InStore': [
          { value: 'WalkIn', text: 'زيارة مباشرة' },
          { value: 'Referral', text: 'إحالة' },
          { value: 'Other', text: 'أخرى' }
        ],
        'Phone': [
          { value: 'Referral', text: 'إحالة' },
          { value: 'Ad', text: 'إعلان' },
          { value: 'Other', text: 'أخرى' }
        ],
        'Other': [
          { value: 'Other', text: 'أخرى' }
        ]
      };

      const primarySources = [
        { value: 'Online', text: 'أونلاين' },
        { value: 'InStore', text: 'من المتجر' },
        { value: 'Phone', text: 'هاتف' },
        { value: 'Other', text: 'أخرى' }
      ];

      // Populate primary source dropdown
      sourceSelect.innerHTML = '<option value="">اختر المصدر</option>' +
        primarySources.map(src => `<option value="${src.value}">${src.text}</option>`).join('');

      sourceSelect.addEventListener('change', function () {
        const selectedSource = sourceSelect.value;
        secondarySourceSelect.innerHTML = '<option value="">اختر المصدر الفرعي</option>';

        if (selectedSource && sourceMappings[selectedSource]) {
          secondarySourceSelect.innerHTML += sourceMappings[selectedSource].map(option =>
            `<option value="${option.value}">${option.text}</option>`
          ).join('');
        }
      });
    }

    function selectCustomer(customerId) {
      // Coerce both IDs to strings for a reliable comparison
      const customer = customers.find(c => String(c.id) === String(customerId));

      if (customer) {
        appState.selectedCustomer = customer;
        appState.newOrderForm.customer = customer;

        document.getElementById('customerSearch').value = customer.name;
        document.getElementById('searchResults').classList.remove('show');

        // Show customer details box
        const detailsBox = document.getElementById('selectedCustomerDetails');
        const primaryAddress = customer.addresses.find(addr => addr.isPrimary) || customer.addresses[0];

        document.getElementById('selectedCustomerName').textContent = customer.name;
        document.getElementById('selectedCustomerPhone').textContent = customer.phone;
        document.getElementById('selectedCustomerAddress').textContent = primaryAddress ?
          `${primaryAddress.area}${primaryAddress.address_governorate ? ', ' + primaryAddress.address_governorate : ''}` :
          'لا يوجد عنوان';
        document.getElementById('selectedCustomerOrders').textContent =
          `${customer.totalOrders} طلبات - ${formatCurrency(customer.totalSpent)} إجمالي المشتريات`;

        detailsBox.style.display = 'block';
        setTimeout(() => detailsBox.classList.add('show'), 10);

        if (customer.addresses.length > 0) {
          showAddressSection();
          renderAddresses(customer.addresses);
        } else {
          showNewAddressForm();
        }
      } else {
        console.error(`selectCustomer: Could not find customer with ID ${customerId} in the local 'customers' array.`);
      }
    }

    function clearSelectedCustomer() {
      appState.selectedCustomer = null;
      appState.newOrderForm.customer = null;
      appState.selectedAddress = null;
      appState.newOrderForm.address = null;
      
      document.getElementById('customerSearch').value = '';
      // Hide and reset the customer details box
      const detailsBox = document.getElementById('selectedCustomerDetails');
      if (detailsBox) {
        detailsBox.classList.remove('show');
        detailsBox.style.display = 'none';
        // Optionally clear its contents
        const name = document.getElementById('selectedCustomerName');
        const phone = document.getElementById('selectedCustomerPhone');
        const address = document.getElementById('selectedCustomerAddress');
        const orders = document.getElementById('selectedCustomerOrders');
        if (name) name.textContent = '';
        if (phone) phone.textContent = '';
        if (address) address.textContent = '';
        if (orders) orders.textContent = '';
      }
      
      hideAllFormSections();
    }

    function renderAddresses(addresses) {
      const addressGrid = document.getElementById('addressGrid');

      addressGrid.innerHTML = addresses.map(address => {
        let icon = 'map-marker-alt';
        switch (address.address_label) {
          case 'Home': icon = 'home'; break;
          case 'Work': icon = 'building'; break;
          case 'Family': icon = 'users'; break;
          case 'Friend': icon = 'handshake'; break;
          case 'Warehouse': icon = 'warehouse'; break;
          case 'Chalet': icon = 'umbrella-beach'; break;
          case 'Farm': icon = 'tractor'; break;
          case 'Shop': icon = 'store'; break;
          case 'Other': icon = 'map-marker-alt'; break;
        }
        return `
          <div class="address-card" data-address-id="${address.id}">
            <div class="address-label">
              <i class="fas fa-${icon}"></i>
              ${address.address_label}
            </div>
            <div class="address-details">
              ${address.street_name}، منزل ${address.house_number}${address.flat_number ? '، شقة ' + address.flat_number : ''}${address.floor_number ? '، دور ' + address.floor_number : ''}<br>
              ${address.address_district} - ${address.address_governorate}
            </div>
            ${address.address_comment ? `<div class="address-comment">${address.address_comment}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function selectAddress(addressId, clickedElement = null) {
      let address;

      if (typeof addressId === 'string') {
        // Coerce both IDs to strings for a reliable comparison
        address = appState.selectedCustomer.addresses.find(a => String(a.id) === String(addressId));
        // Update UI
        if (clickedElement) {
          document.querySelectorAll('.address-card').forEach(card => card.classList.remove('selected'));
          clickedElement.classList.add('selected');
        }
      } else {
        address = addressId; // Direct address object for programmatic selection
      }

      if (address) {
        appState.selectedAddress = address;
        appState.newOrderForm.address = address;
        showToast('success', 'تم اختيار العنوان', address.address_label);

        setTimeout(() => {
          showOrderDetailsSection();
        }, 500);
      } else {
        console.error(`selectAddress: Could not find address with ID ${addressId}`);
      }
    }

    function addOrderItem() {
      const tbody = document.getElementById('itemsTableBody');
      const rowIndex = tbody.children.length;

      const row = document.createElement('tr');

      const productOptions = '<option value="">اختر المنتج</option>' +
        products.map(product => {
          return `<option value="${product.id}" data-price="${product.price}">
            ${product.name} - ${formatCurrency(product.price)}
          </option>`;
        }).join('');

      row.innerHTML = `
        <td>
          <div class="custom-dropdown" data-row-index="${rowIndex}">
            <div class="custom-dropdown-box" tabindex="0">
              <input type="text" class="custom-dropdown-input" placeholder="اختر المنتج..." />
              <i class="fas fa-chevron-down custom-dropdown-chevron"></i>
            </div>
            <div class="custom-dropdown-list"></div>
          </div>
        </td>
        <td>
          <input type="number" class="form-input quantity-input" min="1" placeholder="الكمية" onchange="updateOrderItem(${rowIndex})">
        </td>
        <td>
          <select class="form-select unit-select" onchange="updateOrderItem(${rowIndex})">
            <option value="قطعة">قطعة</option>
            <option value="كيلو">كيلو</option>
            <option value="لتر">لتر</option>
            <option value="عبوة">عبوة</option>
            <option value="كيس">كيس</option>
            <option value="زجاجة">زجاجة</option>
          </select>
        </td>
        <td>
          <span class="price-display">0.00 ج.م</span>
        </td>
        <td>
          <input type="text" class="form-input comment-input" placeholder="ملاحظات المنتج" onchange="updateOrderItem(${rowIndex})">
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      tbody.appendChild(row);

      const newItem = {
        id: Date.now(),
        productId: '',
        productName: '',
        quantity: 0,
        unit: 'قطعة',
        comments: '',
        price: 0
      };

      appState.newOrderForm.items.push(newItem);
      
      // Initialize the product dropdown for the new row
      initializeProductDropdown(row, rowIndex);
    }

    function removeOrderItem(button) {
      const row = button.closest('tr');
      const tbody = row.parentNode;
      const rowIndex = Array.from(tbody.children).indexOf(row);

      row.remove();
      appState.newOrderForm.items.splice(rowIndex, 1);

      if (appState.newOrderForm.items.length === 0) {
        addOrderItem();
      }
    }

    function updateOrderItem(rowIndex) {
      const row = document.getElementById('itemsTableBody').children[rowIndex];
      const dropdownInput = row.querySelector('.custom-dropdown-input');
      const quantityInput = row.querySelector('.quantity-input');
      const unitSelect = row.querySelector('.unit-select');
      const commentInput = row.querySelector('.comment-input');
      const priceDisplay = row.querySelector('.price-display');

      if (appState.newOrderForm.items[rowIndex]) {
        const productId = dropdownInput.getAttribute('data-selected-id');
        const product = products.find(p => p.id === productId);
        const price = product ? product.price : 0;
        const quantity = parseInt(quantityInput.value) || 0;

        appState.newOrderForm.items[rowIndex] = {
          id: appState.newOrderForm.items[rowIndex].id,
          productId: productId || '',
          productName: product ? product.name : '',
          quantity: quantity,
          unit: unitSelect.value,
          comments: commentInput.value,
          price: price
        };

        // Update price display
        priceDisplay.textContent = formatCurrency(price * quantity);
      }
    }

    function initializeCustomerSearch() {
      const searchInput = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');

      searchInput.addEventListener('input', debounce(handleCustomerSearch, 300));
      searchInput.addEventListener('focus', () => {
        handleCustomerSearch();
        searchResults.classList.add('show');
      });
      searchInput.addEventListener('click', () => {
        handleCustomerSearch();
        searchResults.classList.add('show');
      });

      // Event delegation for search results
      searchResults.addEventListener('click', (e) => {
        const resultElement = e.target.closest('.search-result');
        if (!resultElement) return;

        if (resultElement.classList.contains('new-customer-option')) {
          const searchTerm = resultElement.dataset.searchTerm || '';
          showNewCustomerForm(searchTerm);
        } else {
          const customerId = resultElement.dataset.customerId;
          if (customerId) {
            selectCustomer(customerId);
          }
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.customer-search')) {
          searchResults.classList.remove('show');
        }
      });
    }

    function handleCustomerSearch() {
      const searchInput = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');
      const term = searchInput.value.trim().toLowerCase();

      if (term.length < 2) {
        searchResults.classList.remove('show');
        return;
      }

      const filtered = customers.filter(customer =>
        customer.name.toLowerCase().includes(term) ||
        customer.phone.includes(term)
      );

      if (filtered.length > 0) {
        renderSearchResults(filtered, term);
        searchResults.classList.add('show');
      } else {
        searchResults.innerHTML = `
          <div class="search-result new-customer-option" data-search-term="${term}">
            <div>
              <h4><i class="fas fa-plus"></i> عميل جديد: "${term}"</h4>
              <p>إضافة عميل جديد بهذا الاسم</p>
            </div>
          </div>
        `;
        searchResults.classList.add('show');
      }
    }

    function showNewCustomerForm(searchTerm = '') {
      document.getElementById('searchResults').classList.remove('show');
      document.getElementById('customerSearch').value = '';

      // Clear existing customer data
      appState.selectedCustomer = null;
      appState.newOrderForm.customer = null;
      appState.selectedAddress = null;
      appState.newOrderForm.address = null;

      // Hide all sections once
      hideAllFormSections();

      // Show both customer and address forms, and order details
      document.getElementById('customerDetailsSection').classList.add('show');
      document.getElementById('newAddressSection').classList.add('show');
      document.getElementById('orderDetailsSection').classList.add('show');

      // Initialize district search for address form
      initializeDistrictSearch();
      
      // Initialize source dropdowns
      initializeSourceDropdowns();
      populateSourceDropdowns('primarySourceOfSale', 'secondarySourceOfSale');

      if (searchTerm) {
        document.getElementById('customerName').value = searchTerm;
        document.getElementById('customerSearch').value = searchTerm;
      }

      // Reset customer details box
      const detailsBox = document.getElementById('selectedCustomerDetails');
      detailsBox.classList.remove('show');
      detailsBox.style.display = 'none';

      showToast('success', 'يمكنك الآن إدخال بيانات العميل الجديد');
    }

    function renderSearchResults(customers, searchTerm) {
      const searchResults = document.getElementById('searchResults');

      let html = customers.map(customer => {
        const primaryAddress = customer.addresses && customer.addresses.length > 0
          ? customer.addresses.find(addr => addr.isPrimary) || customer.addresses[0]
          : null;
        return `
          <div class="search-result" data-customer-id="${customer.id}">
            <div>
              <h4>${highlightMatch(customer.name, searchTerm)}</h4>
              <p>${highlightMatch(customer.phone, searchTerm)} - ${primaryAddress ? primaryAddress.area : 'لا يوجد عنوان'}</p>
            </div>
          </div>
        `;
      }).join('');

      html += `
        <div class="search-result new-customer-option" data-search-term="${searchTerm}">
          <div>
            <h4><i class="fas fa-plus"></i> عميل جديد: "${searchTerm}"</h4>
            <p>إضافة عميل جديد بهذا الاسم</p>
          </div>
        </div>
      `;

      searchResults.innerHTML = html;
    }

    function highlightMatch(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
    }

   // ===== HTML-DRIVEN VALIDATION SYSTEM =====

/**
 * Get validation rules from HTML form elements
 * @param {string} containerSelector - CSS selector for the form container
 * @returns {Array} Array of field validation objects
 */
function getFormValidationRules(containerSelector) {
  const container = document.querySelector(containerSelector);
  if (!container) return [];

  const requiredFields = container.querySelectorAll('[required]');
  return Array.from(requiredFields).map(field => ({
    id: field.id,
    label: field.dataset.label || field.placeholder || field.id,
    type: field.type || 'text',
    element: field
  }));
}

/**
 * Validate form fields based on HTML attributes
 * @param {string} containerSelector - CSS selector for the form container
 * @returns {Object} Validation result with isValid, errors, and missingFields
 */
function validateHtmlForm(containerSelector) {
  console.log('Validating form:', containerSelector);
  
  const validationRules = getFormValidationRules(containerSelector);
  console.log('Found validation rules:', validationRules);
  
  const errors = [];
  const missingFields = [];
  let isValid = true;

  for (const rule of validationRules) {
    const field = rule.element;
    
    if (!field) {
      console.warn('Field not found:', rule.id);
      errors.push(`حقل "${rule.label}" غير موجود في النموذج`);
      isValid = false;
      continue;
    }

    let fieldValue = field.value;
    let isEmpty = !fieldValue || !fieldValue.trim();

    // Special handling for different field types
    if (rule.type === 'select-one' && fieldValue === '') {
      isEmpty = true;
    }

    // Special handling for hidden fields (like district ID)
    if (field.type === 'hidden' && field.hasAttribute('required')) {
      isEmpty = !fieldValue;
    }

    console.log(`Field ${rule.id}: value="${fieldValue}", isEmpty=${isEmpty}, type=${rule.type}`);

    if (isEmpty) {
      console.log('Field is empty, highlighting:', rule.id);
      highlightErrorField(field);
      missingFields.push(rule.label);
      isValid = false;
    }
  }

  if (missingFields.length > 0) {
    errors.push(`الحقول المطلوبة التالية مفقودة: ${missingFields.join('، ')}`);
  }

  console.log('Validation result:', { isValid, errors, missingFields });
  return { isValid, errors, missingFields };
}

/**
 * Validate order items table
 * @returns {Object} Validation result for order items
 */
function validateOrderItems() {
  const itemsTableBody = document.getElementById('itemsTableBody');
  const missingItemFields = [];
  let isValid = true;

  if (!itemsTableBody || !appState.newOrderForm.items) {
    return { isValid: false, errors: ['جدول المنتجات غير موجود'], missingFields: [] };
  }

  for (let i = 0; i < appState.newOrderForm.items.length; i++) {
    const row = itemsTableBody.children[i];
    if (!row) continue;

    const rowNumber = i + 1;

    // Validate product selection
    const productInput = row.querySelector('.custom-dropdown-input');
    const productSelect = row.querySelector('.product-select');
    let productSelected = false;

    if (productInput && productInput.getAttribute('data-selected-id')) {
      productSelected = true;
    } else if (productSelect && productSelect.value) {
      productSelected = true;
    }

    if (!productSelected) {
      const fieldToHighlight = productInput || productSelect;
      if (fieldToHighlight) {
        highlightErrorField(fieldToHighlight);
      }
      missingItemFields.push(`المنتج في الصف ${rowNumber}`);
      isValid = false;
    }

    // Validate quantity
    const quantityInput = row.querySelector('.quantity-input');
    if (!quantityInput || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
      if (quantityInput) {
        highlightErrorField(quantityInput);
      }
      missingItemFields.push(`الكمية في الصف ${rowNumber}`);
      isValid = false;
    }
  }

  const errors = missingItemFields.length > 0 ? [`يجب تحديد: ${missingItemFields.join('، ')}`] : [];
  return { isValid, errors, missingFields: missingItemFields };
}

/**
 * Highlight field with error styling
 * @param {HTMLElement} field - The field element to highlight
 */
function highlightErrorField(field) {
  if (!field) {
    console.warn('highlightErrorField: field is null or undefined');
    return;
  }
  
  console.log('Highlighting field:', field.id || field.name || 'unnamed field');
  
  // Remove any existing error styling first
  field.classList.remove('error');
  
  // Add error class
  field.classList.add('error');
  
  // Apply inline styles with !important to override CSS
  field.style.setProperty('border-color', '#e2445c', 'important');
  field.style.setProperty('box-shadow', '0 0 0 3px rgba(226, 68, 92, 0.1)', 'important');
  field.style.setProperty('background-color', 'rgba(226, 68, 92, 0.05)', 'important');
  
  // Also add a visual shake animation
  field.style.setProperty('animation', 'shake 0.3s ease-in-out', 'important');
  
  // Clear the error styling after 8 seconds (increased from 5)
  setTimeout(() => {
    field.classList.remove('error');
    field.style.removeProperty('border-color');
    field.style.removeProperty('box-shadow');
    field.style.removeProperty('background-color');
    field.style.removeProperty('animation');
    console.log('Cleared error styling for field:', field.id || field.name || 'unnamed field');
  }, 8000);
}

/**
 * Main order form validation function
 * @returns {boolean} True if form is valid, false otherwise
 */
function validateOrderForm() {
  let isValid = true;
  const allErrors = [];

  // Check customer selection or form completion
  if (!appState.selectedCustomer) {
    const customerValidation = validateHtmlForm('#customerDetailsSection');
    if (!customerValidation.isValid) {
      allErrors.push(...customerValidation.errors);
      isValid = false;
    }

    // Check address fields for new customers
    const addressValidation = validateHtmlForm('#newAddressSection');
    if (!addressValidation.isValid && !appState.isAddingNewAddress) {
      // Only add address errors if we're not in the process of adding a new address
      allErrors.push('يجب إكمال بيانات العنوان أو اختيار عنوان موجود');
      isValid = false;
    }
  }

  // Check address selection for existing customers
  if (appState.selectedCustomer && !appState.selectedAddress && !appState.isAddingNewAddress) {
    allErrors.push('يجب اختيار عنوان للتوصيل من القائمة أو إضافة عنوان جديد');
    isValid = false;
  }

  // Check items
  if (!appState.newOrderForm.items || appState.newOrderForm.items.length === 0) {
    allErrors.push('يجب إضافة منتج واحد على الأقل للطلب');
    isValid = false;
  } else {
    // Validate individual items
    const itemsValidation = validateOrderItems();
    if (!itemsValidation.isValid) {
      allErrors.push(...itemsValidation.errors);
      isValid = false;
    }
  }

  if (!isValid) {
    // Scroll to top to show error message
    const modalContent = document.querySelector('.modal-content');
    if (modalContent) {
      modalContent.scrollTop = 0;
    }
    showToast('error', 'يرجى تصحيح الأخطاء التالية:', allErrors.join('<br>• '));
  }

  return isValid;
}

/**
 * Submit add customer form with validation
 */
function submitAddCustomer() {
  const validation = validateHtmlForm('#addCustomerModal .modal-content');
  if (!validation.isValid) {
    showToast('error', 'يرجى تصحيح الأخطاء التالية:', validation.errors.join('<br>• '));
    return;
  }
  
  // Collect customer data
  const customerData = {
    customer: {
      name: document.getElementById('addCustomerName').value.trim(),
      phone: document.getElementById('addCustomerPhone').value.trim(),
      gender: document.getElementById('addCustomerGender').value,
      whatsapp: document.getElementById('addCustomerWhatsapp').value.trim(),
      email: document.getElementById('addCustomerEmail').value.trim(),
      comment: document.getElementById('addCustomerComment').value.trim(),
      primary_source_of_sale: document.getElementById('addCustomerPrimarySourceOfSale').value,
      secondary_source_of_sale: document.getElementById('addCustomerSecondarySourceOfSale').value,
      type: document.getElementById('addCustomerType').value
    },
    address: {
      address_label: document.getElementById('addCustomerAddressLabel').value,
      address_comment: document.getElementById('addCustomerAddressComment').value.trim(),
      house_number: document.getElementById('addCustomerHouseNumber').value.trim(),
      flat_number: document.getElementById('addCustomerFlatNumber').value.trim(),
      floor_number: document.getElementById('addCustomerFloorNumber').value.trim(),
      street_name: document.getElementById('addCustomerStreetName').value.trim(),
      address_marking: document.getElementById('addCustomerAddressMarking').value.trim(),
      address_district: document.getElementById('addCustomerAddressDistrict').value,
      address_governorate: document.getElementById('addCustomerAddressGovernorate').value,
      district_id: document.getElementById('addCustomerDistrictId').value,
      isPrimary: true
    }
  };

  API.addCustomer(customerData).then(response => {
    console.log('=== API RESPONSE ===');
    console.log('Raw response:', response);
    
    // Handle both string and object responses
    let parsedResponse;
    if (typeof response === 'string') {
      try {
        parsedResponse = JSON.parse(response);
      } catch (e) {
        console.error('Failed to parse response as JSON:', e);
        showToast('error', 'حدث خطأ في استجابة الخادم.');
        return;
      }
    } else {
      parsedResponse = response;
    }
    
    console.log('Parsed response:', parsedResponse);
    
    const newCustomerId = parsedResponse.customer_id || parsedResponse.id;
    const newAddressId = parsedResponse.address_id || `ADDR-${Date.now()}`;
    
    if (!newCustomerId) {
        console.error("Backend did not return a customer ID.", parsedResponse);
        showToast('error', 'حدث خطأ في استجابة الخادم.');
        return;
    }

    // Create complete customer object for frontend
    const newCustomerForFrontend = {
      id: newCustomerId,
      name: customerData.customer.name,
      phone: customerData.customer.phone,
      gender: customerData.customer.gender,
      addresses: [{
        id: newAddressId,
        address_label: customerData.address.address_label || 'Home',
        address_type: customerData.address.address_label || 'Home',
        address_comment: customerData.address.address_comment || '',
        house_number: customerData.address.house_number || '',
        flat_number: customerData.address.flat_number || '',
        floor_number: customerData.address.floor_number || '',
        street_name: customerData.address.street_name,
        address_marking: customerData.address.address_marking || '',
        address_district: customerData.address.address_district,
        address_governorate: customerData.address.address_governorate,
        district_id: customerData.address.district_id,
        area: customerData.address.address_district,
        isPrimary: true
      }],
      totalOrders: 0,
      totalSpent: 0,
      lastOrderDate: null
    };

    customers.push(newCustomerForFrontend);
    showToast('success', 'تم إضافة العميل بنجاح');
    closeAddCustomerModal();
    renderCustomers();
    
    // If the new order modal is open, automatically populate the search with the new customer
    const newOrderModal = document.getElementById('newOrderModal');
    if (newOrderModal && newOrderModal.classList.contains('show')) {
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.value = newCustomerForFrontend.name;
        // Trigger a search to show the new customer in results
        handleCustomerSearch();
      }
    }
  }).catch(error => {
    showToast('error', 'حدث خطأ أثناء إضافة العميل');
    console.error('Failed to add customer:', error);
  });
}

function initializeProductDropdown(row, rowIndex) {
  const dropdown = row.querySelector('.custom-dropdown');
  const input = dropdown.querySelector('.custom-dropdown-input');
  const list = dropdown.querySelector('.custom-dropdown-list');
  const box = dropdown.querySelector('.custom-dropdown-box');
  const chevron = dropdown.querySelector('.custom-dropdown-chevron');
  let isOpen = false;

  function highlightMatch(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  function renderProductResults(filtered, term) {
    if (!filtered.length) {
      list.innerHTML = '<div class="custom-dropdown-item">لا توجد نتائج</div>';
      list.classList.add('show');
      isOpen = true;
      chevron.style.transform = 'translateY(-50%) rotate(180deg)';
      return;
    }
    list.innerHTML = filtered.map(product =>
      `<div class="custom-dropdown-item" data-id="${product.id}" data-price="${product.price}">
        ${highlightMatch(product.name, term)}
        <small style="color: var(--gray-500);">${product.category}</small>
      </div>`
    ).join('');
    list.classList.add('show');
    isOpen = true;
    chevron.style.transform = 'translateY(-50%) rotate(180deg)';
  }

  function closeDropdown() {
    list.classList.remove('show');
    isOpen = false;
    chevron.style.transform = 'translateY(-50%)';
  }

  function filterProducts(term) {
    term = term.trim().toLowerCase();
    if (!term) return products;
    return products.filter(p =>
      p.name.toLowerCase().includes(term) ||
      p.category.toLowerCase().includes(term)
    );
  }

  function selectProduct(product) {
    input.value = product.name;
    input.setAttribute('data-selected-id', product.id);
    input.setAttribute('data-selected-price', product.price);
    // Auto-set quantity to 1 if empty
    const row = document.getElementById('itemsTableBody').children[rowIndex];
    const quantityInput = row.querySelector('.quantity-input');
    if (quantityInput && (!quantityInput.value || parseInt(quantityInput.value) <= 0)) {
      quantityInput.value = 1;
    }
    closeDropdown();
    updateOrderItem(rowIndex);
  }

  input.addEventListener('input', function() {
    const filtered = filterProducts(input.value);
    renderProductResults(filtered, input.value.trim());
  });

  input.addEventListener('focus', function() {
    if (!isOpen) {
      renderProductResults(products, input.value.trim());
    }
  });

  input.addEventListener('click', function() {
    if (isOpen) {
      closeDropdown();
    } else {
      renderProductResults(products, input.value.trim());
    }
  });

  list.addEventListener('click', function(e) {
    const item = e.target.closest('.custom-dropdown-item');
    if (item) {
      const productId = item.dataset.id;
      const product = products.find(p => p.id === productId);
      if (product) {
        selectProduct(product);
      }
    }
  });

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-dropdown')) {
      closeDropdown();
    }
  });
}

    function submitAddLead() {
      const name = document.getElementById('addLeadName').value.trim();
      const phone = document.getElementById('addLeadPhone').value.trim();
      const gender = document.getElementById('addLeadGender').value;
      const email = document.getElementById('addLeadEmail').value.trim();
      const comment = document.getElementById('addLeadComment').value.trim();
      const primarySource = document.getElementById('addLeadPrimarySourceOfSale').value;
      const secondarySource = document.getElementById('addLeadSecondarySourceOfSale').value;
      const leadType = document.getElementById('addLeadType').value;

      if (!name || !phone || !primarySource || !gender) {
        showToast('error', 'يجب ملء جميع الحقول المطلوبة');
        return;
      }

      const leadData = {
        lead_name: name,
        lead_type: leadType,
        lead_comment: comment,
        lead_phone: phone,
        lead_email: email,
        lead_gender: gender,
        primary_source_of_sale: primarySource,
        secondary_source_of_sale: secondarySource
      };

      API.addLead(leadData).then(newLead => {
        leads.push(newLead);
        showToast('success', 'تم إضافة العميل المحتمل بنجاح');
        closeAddLeadModalDedicated();
        loadLeads();
      }).catch(error => {
        showToast('error', 'حدث خطأ أثناء إضافة العميل المحتمل');
      });
    }

    function renderLeads() {
      const grid = document.getElementById('leadsGrid');
      if (!grid) return;

      if (!leads || leads.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-plus"></i>
            <h3>لا يوجد عملاء محتملين</h3>
            <p>لم يتم إضافة أي عملاء محتملين حتى الآن. يمكنك إضافة عميل محتمل جديد من خلال الضغط على زر "إضافة عميل محتمل"</p>
            <button class="btn btn-success" onclick="openAddLeadModal()">
              <i class="fas fa-plus"></i>
              إضافة عميل محتمل جديد
            </button>
          </div>`;
        return;
      }

      grid.innerHTML = leads.map(lead => {
        let genderIcon, genderText, genderColor;
        
        if (lead.lead_gender === 'male') {
          genderIcon = 'fas fa-mars';
          genderText = 'ذكر';
          genderColor = '#3b82f6';
        } else if (lead.lead_gender === 'female') {
          genderIcon = 'fas fa-venus';
          genderText = 'أنثى';
          genderColor = '#ec4899';
        } else {
          genderIcon = 'fas fa-user';
          genderText = 'آخر';
          genderColor = '#6b7280';
        }
        
        return `
          <div class="customer-card">
            <div class="customer-header">
              <div class="customer-info">
                <h3>${lead.lead_name}</h3>
                <p><i class="fas fa-phone"></i> ${lead.lead_phone}</p>
                <p><i class="${genderIcon}" style="color: ${genderColor};"></i> ${genderText}</p>
                ${lead.lead_email ? `<p><i class="fas fa-envelope"></i> ${lead.lead_email}</p>` : ''}
                <p><i class="fas fa-tag"></i> ${lead.primary_source_of_sale}${lead.secondary_source_of_sale ? ' - ' + lead.secondary_source_of_sale : ''}</p>
              </div>
            </div>
            ${lead.lead_comment ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); color: var(--gray-600);">
                <i class="fas fa-comment"></i> ${lead.lead_comment}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ===== ADD CUSTOMER MODAL LOGIC =====
    function openAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.add('show');
      resetAddCustomerForm();
      populateSourceDropdowns('addCustomerPrimarySourceOfSale', 'addCustomerSecondarySourceOfSale');
      initializeAddCustomerDistrictSearch();
    }

    function closeAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.remove('show');
      resetAddCustomerForm();
    }

    function resetAddCustomerForm() {
      ['addCustomerName', 'addCustomerPhone', 'addCustomerGender', 'addCustomerWhatsapp', 'addCustomerEmail', 'addCustomerComment', 'addCustomerPrimarySourceOfSale', 'addCustomerSecondarySourceOfSale', 'addCustomerType', 'addCustomerAddressLabel', 'addCustomerHouseNumber', 'addCustomerFlatNumber', 'addCustomerFloorNumber', 'addCustomerStreetName', 'addCustomerDistrictSearch', 'addCustomerAddressDistrict', 'addCustomerAddressGovernorate', 'addCustomerDistrictId', 'addCustomerAddressMarking', 'addCustomerAddressComment'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }

    function initializeAddCustomerDistrictSearch() {
      const input = document.getElementById('addCustomerDistrictSearch');
      const results = document.getElementById('addCustomerDistrictSearchResults');
      const chevron = document.getElementById('addCustomerDistrictChevron');
      const hiddenDistrict = document.getElementById('addCustomerAddressDistrict');
      const hiddenGovernorate = document.getElementById('addCustomerAddressGovernorate');
      const hiddenDistrictId = document.getElementById('addCustomerDistrictId');
      let isOpen = false;

      function highlightMatch(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, 'gi');
        return text.replace(regex, '<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
      }

      function renderDistrictResults(filtered, term) {
        if (!filtered.length) {
          results.innerHTML = '<div class="search-result">لا توجد نتائج</div>';
          results.classList.add('show');
          isOpen = true;
          chevron.style.transform = 'translateY(-50%) rotate(180deg)';
          return;
        }
        results.innerHTML = filtered.map(d =>
          `<div class="search-result" data-id="${d.district_id}" data-name="${d.district_name}" data-gov="${d.governorate_name}">
            ${highlightMatch(d.district_name, term)} - ${highlightMatch(d.governorate_name, term)}
          </div>`
        ).join('');
        results.classList.add('show');
        isOpen = true;
        chevron.style.transform = 'translateY(-50%) rotate(180deg)';
      }

      function closeDropdown() {
        results.classList.remove('show');
        isOpen = false;
        chevron.style.transform = 'translateY(-50%)';
      }

      function filterDistricts(term) {
        term = term.trim().toLowerCase();
        if (!term) return districts;
        return districts.filter(d =>
          d.district_name.toLowerCase().includes(term) ||
          d.governorate_name.toLowerCase().includes(term)
        );
      }

      input.addEventListener('input', function () {
        const filtered = filterDistricts(input.value);
        renderDistrictResults(filtered, input.value.trim());
      });
      input.addEventListener('focus', function () {
        if (!isOpen) {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      input.addEventListener('click', function () {
        if (isOpen) {
          closeDropdown();
        } else {
          renderDistrictResults(districts, input.value.trim());
        }
      });
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.form-group')) {
          closeDropdown();
        }
      });
      results.addEventListener('click', function (e) {
        const item = e.target.closest('.search-result[data-id]');
        if (item) {
          input.value = item.dataset.name + ' - ' + item.dataset.gov;
          hiddenDistrict.value = item.dataset.name;
          hiddenGovernorate.value = item.dataset.gov;
          hiddenDistrictId.value = item.dataset.id;
          closeDropdown();
        }
      });
    }

    // Add click event listener to close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const addCustomerModal = document.getElementById('addCustomerModal');
      if (addCustomerModal) {
        addCustomerModal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAddCustomerModal();
          }
        });
      }
    });

    // ===== ADD LEAD MODAL LOGIC =====
    function openAddLeadModal() {
      document.getElementById('addLeadModalDedicated').classList.add('show');
      resetAddLeadForm();
      populateSourceDropdowns('addLeadPrimarySourceOfSale', 'addLeadSecondarySourceOfSale');
    }

    function closeAddLeadModalDedicated() {
      document.getElementById('addLeadModalDedicated').classList.remove('show');
      resetAddLeadForm();
    }

    function resetAddLeadForm() {
      ['addLeadName', 'addLeadPhone', 'addLeadGender', 'addLeadEmail', 'addLeadComment', 'addLeadPrimarySourceOfSale', 'addLeadSecondarySourceOfSale', 'addLeadType'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }

    // Add click event listener to close lead modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const addLeadModal = document.getElementById('addLeadModalDedicated');
      if (addLeadModal) {
        addLeadModal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAddLeadModalDedicated();
          }
        });
      }
    });

    // ===== MAIN INITIALIZATION =====
    function initializeApp() {
      updateLoadingMessage('جاري تحميل البيانات...');
      
      // Initialize components
      initializeNavigation();
      initializeOrderFilters();
      
      // Load initial data
      Promise.all([
        API.getOrders(),
        API.getProducts(),
        API.getLocations()
      ]).then(([ordersData, productsData, locationsData]) => {
        orders = ordersData;
        products = productsData;
        locations = locationsData;
        
        updateOrderCounts();
        renderOrders();
        hideGlobalLoader();
        showToast('success', 'تم تحميل النظام بنجاح');
      }).catch(error => {
        hideGlobalLoader();
        showToast('error', 'خطأ في تحميل البيانات');
        console.error('App initialization failed:', error);
      });
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);

    // ===== SOURCE DROPDOWNS =====
    const sourcesMap = {
      Online: [
        { value: 'Referral', label: 'إحالة' },
        { value: 'Facebook', label: 'فيسبوك' },
        { value: 'Instagram', label: 'إنستغرام' },
        { value: 'Google', label: 'جوجل' },
        { value: 'Other', label: 'أخرى' }
      ],
      InStore: [
        { value: 'WalkIn', label: 'زيارة مباشرة' },
        { value: 'Referral', label: 'إحالة' },
        { value: 'Other', label: 'أخرى' }
      ],
      Phone: [
        { value: 'Referral', label: 'إحالة' },
        { value: 'Ad', label: 'إعلان' },
        { value: 'Other', label: 'أخرى' }
      ],
      Other: [
        { value: 'Other', label: 'أخرى' }
      ]
    };

    const primarySources = [
      { value: 'Online', label: 'أونلاين' },
      { value: 'InStore', label: 'من المتجر' },
      { value: 'Phone', label: 'هاتف' },
      { value: 'Other', label: 'أخرى' }
    ];

    function populateSourceDropdowns(primaryId, secondaryId) {
      const primarySelect = document.getElementById(primaryId);
      const secondarySelect = document.getElementById(secondaryId);
      if (!primarySelect || !secondarySelect) return;
      
      // Populate primary
      primarySelect.innerHTML = '<option value="">اختر المصدر</option>' +
        primarySources.map(src => `<option value="${src.value}">${src.label}</option>`).join('');
      
      // Populate secondary on primary change
      primarySelect.addEventListener('change', function () {
        const selected = primarySelect.value;
        const options = sourcesMap[selected] || [];
        secondarySelect.innerHTML = '<option value="">اختر المصدر الفرعي</option>' +
          options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      });
      
      // Initial clear
      secondarySelect.innerHTML = '<option value="">اختر المصدر الفرعي</option>';
    }

    // Global function assignments
    window.openAddCustomerModal = openAddCustomerModal;
    window.closeAddCustomerModal = closeAddCustomerModal;
    window.submitAddCustomer = submitAddCustomer;
    window.openAddLeadModal = openAddLeadModal;
    window.closeAddLeadModalDedicated = closeAddLeadModalDedicated;
    window.submitAddLead = submitAddLead;
    window.openNewOrderModal = openNewOrderModal;
    window.closeNewOrderModal = closeNewOrderModal;
    window.submitOrder = submitOrder;
    window.submitNewCustomer = submitNewCustomer;
    window.showNewCustomerForm = showNewCustomerForm;
    window.clearSelectedCustomer = clearSelectedCustomer;
    window.showNewAddressForm = showNewAddressForm;
    window.saveNewAddress = saveNewAddress;
    window.cancelNewAddress = cancelNewAddress;
    window.addOrderItem = addOrderItem;
    window.removeOrderItem = removeOrderItem;
    window.updateOrderItem = updateOrderItem;
    window.changeOrderStatus = changeOrderStatus;
    window.initializeCustomerSearch = initializeCustomerSearch;
    window.selectCustomer = selectCustomer;
    
    // ===== ORDER SUBMISSION =====
    function submitOrder() {
      // Validate the order form
      if (!validateOrderForm()) {
        return;
      }

      // Generate a unique reference for this order (timestamp + random)
      const reference = `REF-${Date.now()}-${Math.floor(Math.random()*100000)}`;

      // Determine if this is a new customer or existing customer
      const isNewCustomer = !appState.selectedCustomer;
      const isNewAddress = !appState.selectedAddress;

      // Prepare customer fields
      let customer_id = null;
      let customer = {};
      if (isNewCustomer) {
        customer = {
          name: document.getElementById('customerName').value.trim(),
          phone: document.getElementById('customerPhone').value.trim(),
          gender: document.getElementById('customerGender').value,
          whatsapp: document.getElementById('customerWhatsapp').value.trim(),
          email: document.getElementById('customerEmail').value.trim(),
          comment: document.getElementById('customerComment').value.trim(),
          primarySource: document.getElementById('primarySourceOfSale').value,
          secondarySource: document.getElementById('secondarySourceOfSale').value,
          type: document.getElementById('customerType').value
        };
        customer_id = null;
      } else {
        customer_id = appState.selectedCustomer.id;
        customer = {};
      }

      // Prepare address fields
      let address_id = null;
      let address = {};
      if (isNewAddress) {
        address = {
          street_name: document.getElementById('newStreetName').value.trim(),
          address_district: document.getElementById('newAddressDistrict').value,
          address_governorate: document.getElementById('newAddressGovernorate').value,
          house_number: document.getElementById('newHouseNumber').value.trim(),
          flat_number: document.getElementById('newFlatNumber').value.trim(),
          floor_number: document.getElementById('newFloorNumber').value.trim(),
          address_marking: document.getElementById('newAddressMarking').value.trim(),
          address_comment: document.getElementById('newAddressComment').value.trim(),
          area: document.getElementById('newAddressDistrict').value
        };
        address_id = null;
      } else {
        address_id = appState.selectedAddress.id;
        address = {};
      }

      // Collect order data
      const orderData = {
        reference,
        customer_id,
        customer,
        address_id,
        address,
        items: appState.newOrderForm.items.filter(item => item.productId && item.quantity > 0),
        notes: document.getElementById('orderComments').value.trim(),
        source: document.getElementById('orderSource').value,
        secondarySource: document.getElementById('orderSecondarySource').value
      };

      console.log('=== ORDER PAYLOAD TO BE SENT ===');
      console.log(orderData);

      // Validate that we have at least one item
      if (!orderData.items || orderData.items.length === 0) {
        showToast('error', 'يجب إضافة منتج واحد على الأقل للطلب');
        return;
      }

      // Step 1: Add to buffer (with loading)
      API.addCompoundedRequestToBuffer(orderData).then(response => {
        console.log('=== BUFFER RESPONSE ===');
        console.log('Buffer Response:', response);
        // Use the reference returned from the buffer (if present)
        const bufferReference = response && response.reference ? response.reference : reference;
        // Step 2: Fire-and-forget the actual order creation, attach reference
        const fireAndForgetOrder = { ...orderData, reference: bufferReference };
        API.addCompoudedOrder(fireAndForgetOrder).catch(error => {
          console.error('Background order creation failed:', error);
          // Don't show error to user since this is fire-and-forget
        });

        // Create local order object for immediate UI update
        const newOrder = {
          id: `AFI-${String(orders.length + 1).padStart(3, '0')}`,
          customerId: customer_id || `CUST-${Date.now()}`,
          customerName: isNewCustomer ? customer.name : appState.selectedCustomer.name,
          customerPhone: isNewCustomer ? customer.phone : appState.selectedCustomer.phone,
          date: new Date().toISOString().split('T')[0],
          amount: orderData.items.reduce((total, item) => total + (item.price * item.quantity), 0),
          status: 'pending',
          items: orderData.items,
          area: isNewAddress ? address.area : appState.selectedAddress.area,
          address_details: isNewAddress ? 
            `${address.street_name}، منزل ${address.house_number}${address.flat_number ? '، شقة ' + address.flat_number : ''}${address.floor_number ? '، دور ' + address.floor_number : ''}<br>${address.address_district} - ${address.address_governorate}` :
            `${appState.selectedAddress.street_name}، منزل ${appState.selectedAddress.house_number}${appState.selectedAddress.flat_number ? '، شقة ' + appState.selectedAddress.flat_number : ''}${appState.selectedAddress.floor_number ? '، دور ' + appState.selectedAddress.floor_number : ''}<br>${appState.selectedAddress.address_district} - ${appState.selectedAddress.address_governorate}`,
          comments: orderData.notes || ''
        };

        console.log('=== LOCAL ORDER CREATED ===');
        console.log('New Order:', newOrder);

        // Update UI immediately
        orders.unshift(newOrder);
        updateOrderCounts();
        renderOrders();
        closeNewOrderModal();
        showToast('success', 'تم إنشاء الطلب بنجاح', `رقم الطلب: ${newOrder.id}`);
      }).catch(error => {
        console.error('Failed to buffer order:', error);
        showToast('error', 'حدث خطأ أثناء إنشاء الطلب');
      });
    }

    // ===== NEW CUSTOMER SUBMISSION =====
    function submitNewCustomer() {
      const validation = validateHtmlForm('#addCustomerModal .modal-content');
      if (!validation.isValid) {
        showToast('error', 'يرجى تصحيح الأخطاء التالية:', validation.errors.join('<br>• '));
        return;
      }
      const customerData = {
        customer: {
          name: document.getElementById('addCustomerName').value.trim(),
          phone: document.getElementById('addCustomerPhone').value.trim(),
          gender: document.getElementById('addCustomerGender').value,
          whatsapp: document.getElementById('addCustomerWhatsapp').value.trim(),
          email: document.getElementById('addCustomerEmail').value.trim(),
          comment: document.getElementById('addCustomerComment').value.trim(),
          primary_source_of_sale: document.getElementById('addCustomerPrimarySourceOfSale').value,
          secondary_source_of_sale: document.getElementById('addCustomerSecondarySourceOfSale').value,
          type: document.getElementById('addCustomerType').value
        },
        address: {
          address_label: document.getElementById('addAddressLabel') ? document.getElementById('newAddressLabel').value : 'Home',
          address_comment: document.getElementById('newAddressComment') ? document.getElementById('newAddressComment').value.trim() : '',
          house_number: document.getElementById('newHouseNumber') ? document.getElementById('newHouseNumber').value.trim() : '',
          flat_number: document.getElementById('newFlatNumber') ? document.getElementById('newFlatNumber').value.trim() : '',
          floor_number: document.getElementById('newFloorNumber') ? document.getElementById('newFloorNumber').value.trim() : '',
          street_name: document.getElementById('newStreetName') ? document.getElementById('newStreetName').value.trim() : '',
          address_marking: document.getElementById('newAddressMarking') ? document.getElementById('newAddressMarking').value.trim() : '',
          address_district: document.getElementById('newAddressDistrict') ? document.getElementById('newAddressDistrict').value : '',
          address_governorate: document.getElementById('newAddressGovernorate') ? document.getElementById('newAddressGovernorate').value : '',
          district_id: document.getElementById('newDistrictId') ? document.getElementById('newDistrictId').value : '',
          isPrimary: true
        }
      };
      API.addCustomer(customerData).then(response => {
        response = JSON.parse(response);
        const newCustomerId = response.customer_id;
        const newAddressId = response.address_id;
        if (!newCustomerId) {
            showToast('error', 'حدث خطأ في استجابة الخادم.');
            return;
        }
        const newCustomerForFrontend = {
          id: newCustomerId,
          name: customerData.customer.name,
          phone: customerData.customer.phone,
          gender: customerData.customer.gender,
          addresses: [{
            id: newAddressId,
            address_label: customerData.address.address_label || 'Home',
            address_type: customerData.address.address_label || 'Home',
            address_comment: customerData.address.address_comment || '',
            house_number: customerData.address.house_number || '',
            flat_number: customerData.address.flat_number || '',
            floor_number: customerData.address.floor_number || '',
            street_name: customerData.address.street_name,
            address_marking: customerData.address.address_marking || '',
            address_district: customerData.address.address_district,
            address_governorate: customerData.address.address_governorate,
            district_id: customerData.address.district_id,
            area: customerData.address.address_district,
            isPrimary: true
          }],
          totalOrders: 0,
          totalSpent: 0,
          lastOrderDate: null
        };
        customers.push(newCustomerForFrontend);
        showToast('success', 'تم إضافة العميل بنجاح');
        closeAddCustomerModal();
        renderCustomers();
      }).catch(error => {
        showToast('error', 'حدث خطأ أثناء إضافة العميل');
      });
    }

    // ===== ADDRESS GRID EVENT LISTENER =====
    function initializeAddressGrid() {
      const addressGrid = document.getElementById('addressGrid');
      if (!addressGrid) return;

      addressGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.address-card');
        if (card && card.dataset.addressId) {
          const addressId = card.dataset.addressId;
          selectAddress(addressId, card);
        }
      });
    }
  </script>
</body>

</html>